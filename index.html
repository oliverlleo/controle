<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinanControl - Sistema de Gerenciamento Financeiro</title>
  
  <!-- Meta tags para evitar cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- CSS do Daterangepicker -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Ícones (Font Awesome) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- CSS Personalizado -->
  <link rel="stylesheet" href="responsive_layout.css">
  <link rel="stylesheet" href="enhanced_styles.css">
  
  <style>
    /* Estilos específicos para esta página */
    .insights-list {
      list-style: none;
      padding: 0;
    }
    
    .insight-item {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-md);
      padding: var(--spacing-md) 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .insight-item:last-child {
      border-bottom: none;
    }
    
    .insight-title {
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
    }
    
    .insight-description {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--warning);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .mobile-nav {
      display: none;
    }
    
    @media (max-width: 767px) {
      .mobile-nav {
        display: flex;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Menu Lateral -->
    <aside>
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <i class="fas fa-wallet"></i>
          <h2>FinanControl</h2>
        </div>
        <button class="sidebar-toggle" id="sidebarToggle">
          <i class="fas fa-bars"></i>
        </button>
      </div>
      
      <div class="user-profile">
        <div class="user-avatar" id="userAvatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-info">
          <div class="user-name" id="userName">Carregando...</div>
          <div class="user-email" id="userEmail">Carregando...</div>
        </div>
      </div>
      
      <div class="nav-group">
        <div class="nav-group-title">Principal</div>
        <a href="#" class="nav-link active" data-section="dashboardSection">
          <i class="fas fa-house"></i>
          <span class="nav-link-text">Dashboard</span>
        </a>
        <a href="#" class="nav-link" data-section="despesasSection">
          <i class="fas fa-money-bill-wave"></i>
          <span class="nav-link-text">Despesas</span>
        </a>
        <a href="#" class="nav-link" data-section="rendaSection">
          <i class="fas fa-user"></i>
          <span class="nav-link-text">Renda</span>
        </a>
      </div>
      
      <div class="nav-group">
        <div class="nav-group-title">Gestão</div>
        <a href="#" class="nav-link" data-section="goalsSection">
          <i class="fas fa-bullseye"></i>
          <span class="nav-link-text">Metas</span>
        </a>
        <a href="#" class="nav-link" data-section="budgetSection">
          <i class="fas fa-coins"></i>
          <span class="nav-link-text">Orçamento</span>
        </a>
        <a href="#" class="nav-link" data-section="cashFlowSection">
          <i class="fas fa-chart-line"></i>
          <span class="nav-link-text">Fluxo de Caixa</span>
        </a>
      </div>
      
      <div class="nav-group">
        <div class="nav-group-title">Análise</div>
        <a href="#" class="nav-link" data-section="relatorioSection">
          <i class="fas fa-file-alt"></i>
          <span class="nav-link-text">Relatórios</span>
        </a>
        <a href="#" class="nav-link" data-section="trendsSection">
          <i class="fas fa-chart-bar"></i>
          <span class="nav-link-text">Tendências</span>
        </a>
        <a href="#" class="nav-link" data-section="comparisonSection">
          <i class="fas fa-balance-scale"></i>
          <span class="nav-link-text">Comparativo</span>
        </a>
      </div>
      
      <div class="nav-group">
        <div class="nav-group-title">Configurações</div>
        <a href="#" class="nav-link" data-section="categoriasSection">
          <i class="fas fa-tags"></i>
          <span class="nav-link-text">Categorias</span>
        </a>
        <a href="#" class="nav-link" data-section="cartoesSection">
          <i class="fas fa-credit-card"></i>
          <span class="nav-link-text">Cartões</span>
        </a>
        <a href="#" class="nav-link" data-section="notificationsSection">
          <i class="fas fa-bell"></i>
          <span class="nav-link-text">Notificações</span>
          <span class="nav-badge" id="notificationCount">0</span>
        </a>
        <a href="#" class="nav-link" onclick="exportData()">
          <i class="fas fa-file-export"></i>
          <span class="nav-link-text">Exportar Dados</span>
        </a>
        <a href="#" class="nav-link" id="logoutButton">
          <i class="fas fa-sign-out-alt"></i>
          <span class="nav-link-text">Sair</span>
        </a>
      </div>
      
      <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
      </button>
    </aside>
    
    <!-- Menu Mobile -->
    <div class="mobile-nav">
      <a href="#" class="mobile-nav-link active" data-section="dashboardSection">
        <i class="fas fa-house"></i>
        <span>Início</span>
      </a>
      <a href="#" class="mobile-nav-link" data-section="despesasSection">
        <i class="fas fa-money-bill-wave"></i>
        <span>Despesas</span>
      </a>
      <a href="#" class="mobile-nav-link" data-section="goalsSection">
        <i class="fas fa-bullseye"></i>
        <span>Metas</span>
      </a>
      <a href="#" class="mobile-nav-link" data-section="relatorioSection">
        <i class="fas fa-chart-bar"></i>
        <span>Relatórios</span>
      </a>
      <a href="#" class="mobile-nav-link" id="mobileMenuButton">
        <i class="fas fa-bars"></i>
        <span>Menu</span>
      </a>
    </div>
    
    <!-- Conteúdo Principal -->
    <main>
      <!-- Dashboard Resumido -->
      <section id="dashboardSection" class="container fade-in">
        <div class="page-header">
          <div class="page-title">
            <h1>Dashboard</h1>
            <p>Visão geral das suas finanças</p>
          </div>
          <div class="page-actions">
            <div id="dashboardMonthSelector">
              <select id="dashboardMonth" class="form-control">
                <option value="0">Janeiro</option>
                <option value="1">Fevereiro</option>
                <option value="2">Março</option>
                <option value="3">Abril</option>
                <option value="4">Maio</option>
                <option value="5">Junho</option>
                <option value="6">Julho</option>
                <option value="7">Agosto</option>
                <option value="8">Setembro</option>
                <option value="9">Outubro</option>
                <option value="10">Novembro</option>
                <option value="11">Dezembro</option>
              </select>
              <select id="dashboardYear" class="form-control">
                <!-- Preenchido via JavaScript -->
              </select>
              <button class="btn btn-primary" onclick="atualizarDashboard()">
                <i class="fas fa-sync-alt"></i> Atualizar
              </button>
            </div>
          </div>
        </div>
        
        <div class="grid mb-4">
          <div class="stat-card-enhanced">
            <div class="stat-card-icon-enhanced">
              <i class="fas fa-wallet"></i>
            </div>
            <div class="stat-card-title-enhanced">Saldo Atual</div>
            <div class="stat-card-value-enhanced" id="saldoAtual">R$ 0,00</div>
            <div class="stat-card-trend-enhanced">
              <i class="fas fa-arrow-up trend-up"></i>
              <span id="saldoTrend">Calculando...</span>
            </div>
          </div>
          
          <div class="stat-card-enhanced warning">
            <div class="stat-card-icon-enhanced">
              <i class="fas fa-credit-card"></i>
            </div>
            <div class="stat-card-title-enhanced">Despesas do Mês</div>
            <div class="stat-card-value-enhanced" id="despesasMes">R$ 0,00</div>
            <div class="stat-card-trend-enhanced">
              <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <button class="nav-mes-btn" onclick="prevDashboardMonth()"><i class="fa-solid fa-arrow-left"></i></button>
                <span id="despesasMesTitle">Carregando...</span>
                <button class="nav-mes-btn" onclick="nextDashboardMonth()"><i class="fa-solid fa-arrow-right"></i></button>
              </div>
            </div>
          </div>
          
          <div class="stat-card-enhanced success">
            <div class="stat-card-icon-enhanced">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-card-title-enhanced">Próximos Vencimentos</div>
            <div class="stat-card-value-enhanced" id="proximosVencimentos">0</div>
            <div class="stat-card-trend-enhanced">
              <span>dias para o próximo vencimento</span>
            </div>
          </div>
        </div>
        
        <div class="grid">
          <div class="card grid-col-2">
            <div class="card-header">
              <div class="card-title">Despesas por Categoria</div>
            </div>
            <div class="card-body">
              <canvas id="graficoDespesas" height="250"></canvas>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">Despesas do Mês</div>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
              <div id="listaDespesasMes"></div>
            </div>
            <div class="card-footer">
              <button class="btn btn-primary" onclick="abrirModal('cadastroDespesaModal')">
                <i class="fas fa-plus"></i> Nova Despesa
              </button>
            </div>
          </div>
        </div>
        
        <div class="grid mt-4">
          <div class="card grid-col-2">
            <div class="card-header">
              <div class="card-title">Progresso de Metas</div>
            </div>
            <div class="card-body" id="dashboardGoals">
              <div class="text-center">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Carregando metas...</p>
              </div>
            </div>
            <div class="card-footer">
              <button class="btn btn-primary" onclick="abrirModal('goalModal')">
                <i class="fas fa-plus"></i> Nova Meta
              </button>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">Orçamentos</div>
            </div>
            <div class="card-body" id="dashboardBudgets">
              <div class="text-center">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Carregando orçamentos...</p>
              </div>
            </div>
            <div class="card-footer">
              <button class="btn btn-primary" onclick="abrirModal('budgetModal')">
                <i class="fas fa-plus"></i> Novo Orçamento
              </button>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Seção de Despesas -->
      <section id="despesasSection" class="container fade-in" style="display: none;">
        <div class="page-header">
          <div class="page-title">
            <h1>Despesas</h1>
            <p>Gerencie suas despesas</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="abrirModal('cadastroDespesaModal')">
              <i class="fas fa-plus"></i> Nova Despesa
            </button>
            <button class="btn btn-secondary" onclick="abrirModal('pagarDespesaModal'); filtrarDespesas();">
              <i class="fas fa-check"></i> Pagar Despesa
            </button>
            <button class="btn btn-secondary" onclick="abrirModal('calendarModal'); renderCalendar();">
              <i class="fas fa-calendar"></i> Calendário
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Filtrar Despesas</div>
          </div>
          <div class="card-body">
            <div class="grid">
              <div class="form-group">
                <input type="text" id="despesaSearchFilter" class="form-control" placeholder=" ">
                <label for="despesaSearchFilter" class="form-label">Descrição</label>
              </div>
              
              <div class="form-group">
                <select id="categoriaFiltroGlobal" class="form-control">
                  <option value="">Todas as categorias</option>
                  <!-- Preenchido via JavaScript -->
                </select>
                <label for="categoriaFiltroGlobal" class="form-label">Categoria</label>
              </div>
              
              <div class="form-group">
                <select id="statusFiltro" class="form-control">
                  <option value="all">Todos os status</option>
                  <option value="pending">Pendentes</option>
                  <option value="paid">Pagas</option>
                </select>
                <label for="statusFiltro" class="form-label">Status</label>
              </div>
              
              <div class="form-group">
                <input type="text" id="dataRangeDespesas" class="form-control" placeholder=" ">
                <label for="dataRangeDespesas" class="form-label">Período</label>
              </div>
            </div>
            
            <button class="btn btn-primary" onclick="filtrarDespesasGlobal()">
              <i class="fas fa-filter"></i> Filtrar
            </button>
            <button class="btn btn-secondary" onclick="limparFiltrosDespesas()">
              <i class="fas fa-broom"></i> Limpar Filtros
            </button>
          </div>
        </div>
        
        <div class="card mt-4">
          <div class="card-header">
            <div class="card-title">Despesas</div>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table id="despesasTable">
                <thead>
                  <tr>
                    <th>Descrição</th>
                    <th>Categoria</th>
                    <th>Data</th>
                    <th>Valor</th>
                    <th>Forma</th>
                    <th>Status</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="despesasTableBody">
                  <!-- Preenchido via JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Seção de Metas -->
      <section id="goalsSection" class="container fade-in" style="display: none;">
        <div class="page-header">
          <div class="page-title">
            <h1>Metas Financeiras</h1>
            <p>Defina e acompanhe suas metas</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="abrirModal('goalModal')">
              <i class="fas fa-plus"></i> Nova Meta
            </button>
          </div>
        </div>
        
        <div id="goalsContainer" class="grid">
          <!-- Preenchido via JavaScript -->
        </div>
      </section>
      
      <!-- Seção de Orçamento -->
      <section id="budgetSection" class="container fade-in" style="display: none;">
        <div class="page-header">
          <div class="page-title">
            <h1>Orçamento Mensal</h1>
            <p>Defina limites para suas categorias</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="abrirModal('budgetModal')">
              <i class="fas fa-plus"></i> Novo Orçamento
            </button>
          </div>
        </div>
        
        <div id="budgetContainer" class="grid">
          <!-- Preenchido via JavaScript -->
        </div>
      </section>
      
      <!-- Seção de Fluxo de Caixa -->
      <section id="cashFlowSection" class="container fade-in" style="display: none;">
        <div class="page-header">
          <div class="page-title">
            <h1>Fluxo de Caixa</h1>
            <p>Acompanhe suas receitas e despesas</p>
          </div>
          <div class="page-actions">
            <div id="cashFlowMonthSelector">
              <select id="cashFlowMonth" class="form-control">
                <option value="0">Janeiro</option>
                <option value="1">Fevereiro</option>
                <option value="2">Março</option>
                <option value="3">Abril</option>
                <option value="4">Maio</option>
                <option value="5">Junho</option>
                <option value="6">Julho</option>
                <option value="7">Agosto</option>
                <option value="8">Setembro</option>
                <option value="9">Outubro</option>
                <option value="10">Novembro</option>
                <option value="11">Dezembro</option>
              </select>
              <select id="cashFlowYear" class="form-control">
                <!-- Preenchido via JavaScript -->
              </select>
              <button class="btn btn-primary" onclick="loadCashFlow()">
                <i class="fas fa-sync-alt"></i> Atualizar
              </button>
            </div>
          </div>
        </div>
        
        <div id="cashFlowContainer">
          <!-- Preenchido via JavaScript -->
        </div>
      </section>
      
      <!-- Seção de Relatórios -->
      <section id="relatorioSection" class="container fade-in" style="display: none;">
        <div class="page-header">
          <div class="page-title">
            <h1>Relatórios</h1>
            <p>Visualize relatórios detalhados</p>
          </div>
          <div class="page-actions">
            <div id="filtrosRelatorio">
              <input type="text" id="dataRange" class="form-control" placeholder="Selecione o período">
            </div>
          </div>
        </div>
        
        <div id="relatorioMensalContainer">
          <!-- Preenchido via JavaScript -->
        </div>
      </section>
      
      <!-- Seção de Tendências -->
      <section id="trendsSection" class="container fade-in" style="display: none;">
        <div class="page-header">
          <div class="page-title">
            <h1>Análise de Tendências</h1>
            <p>Visualize tendências e previsões</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="loadTrendsAnalysis()">
              <i class="fas fa-sync-alt"></i> Atualizar Análise
            </button>
          </div>
        </div>
        
        <div id="trendsContainer">
          <!-- Preenchido via JavaScript -->
        </div>
      </section>
      
      <!-- Seção de Comparativo -->
      <section id="comparisonSection" class="container fade-in" style="display: none;">
        <div class="page-header">
          <div class="page-title">
            <h1>Comparativo de Gastos</h1>
            <p>Compare gastos entre períodos</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="loadExpenseComparison()">
              <i class="fas fa-sync-alt"></i> Atualizar Comparativo
            </button>
          </div>
        </div>
        
        <div id="comparisonContainer">
          <!-- Preenchido via JavaScript -->
        </div>
      </section>
      
      <!-- Seção de Categorias -->
      <section id="categoriasSection" class="container fade-in" style="display: none;">
        <div class="page-header">
          <div class="page-title">
            <h1>Categorias</h1>
            <p>Gerencie suas categorias de despesas</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="abrirModal('categoriasModal')">
              <i class="fas fa-plus"></i> Nova Categoria
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Categorias Cadastradas</div>
          </div>
          <div class="card-body">
            <div id="categoriasListaPrincipal" class="grid">
              <!-- Preenchido via JavaScript -->
            </div>
          </div>
        </div>
      </section>
      
      <!-- Seção de Cartões -->
      <section id="cartoesSection" class="container fade-in" style="display: none;">
        <div class="page-header">
          <div class="page-title">
            <h1>Cartões</h1>
            <p>Gerencie seus cartões de crédito</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="abrirModal('cartaoModal')">
              <i class="fas fa-plus"></i> Novo Cartão
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Cartões Cadastrados</div>
          </div>
          <div class="card-body">
            <div id="cartoesListaPrincipal" class="grid">
              <!-- Preenchido via JavaScript -->
            </div>
          </div>
        </div>
      </section>
      
      <!-- Seção de Renda -->
      <section id="rendaSection" class="container fade-in" style="display: none;">
        <div class="page-header">
          <div class="page-title">
            <h1>Renda</h1>
            <p>Gerencie suas fontes de renda</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="abrirModal('cadastroModal')">
              <i class="fas fa-plus"></i> Nova Renda
            </button>
            <button class="btn btn-secondary" onclick="loadRendas()">
              <i class="fas fa-sync-alt"></i> Atualizar
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Rendas Cadastradas</div>
          </div>
          <div class="card-body">
            <div id="usuariosListaPrincipal">
              <!-- Preenchido via JavaScript -->
            </div>
          </div>
        </div>
      </section>
      
      <!-- Seção de Notificações -->
      <section id="notificationsSection" class="container fade-in" style="display: none;">
        <div class="page-header">
          <div class="page-title">
            <h1>Notificações</h1>
            <p>Gerencie suas notificações</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="loadNotifications()">
              <i class="fas fa-sync-alt"></i> Atualizar
            </button>
            <button class="btn btn-secondary" onclick="abrirModal('notificationSettingsModal')">
              <i class="fas fa-cog"></i> Configurações
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Notificações Recentes</div>
          </div>
          <div class="card-body">
            <div id="notificationsContainer">
              <!-- Preenchido via JavaScript -->
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>
  
  <!-- ===================== MODAIS ===================== -->
  
  <!-- Modal: Cadastro de Despesa -->
  <div id="cadastroDespesaModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('cadastroDespesaModal')">&times;</span>
      <h2>Cadastrar Despesa</h2>
      <form id="despesaForm">
        <div class="form-group">
          <input type="text" id="despesaDescricao" class="form-control" placeholder=" " required>
          <label for="despesaDescricao" class="form-label">Descrição</label>
        </div>
        
        <div class="form-group">
          <input type="number" id="despesaValor" class="form-control" placeholder=" " step="0.01" required pattern="[0-9]*" inputmode="decimal">
          <label for="despesaValor" class="form-label">Valor (R$)</label>
        </div>
        
        <div class="form-group">
          <input type="date" id="dataCompra" class="form-control" required>
          <label for="dataCompra" class="form-label">Data da Compra</label>
        </div>
        
        <div class="form-group">
          <select id="categoriaDespesa" class="form-control" required>
            <option value="">Selecione a Categoria</option>
            <!-- Preenchido via JavaScript -->
          </select>
          <label for="categoriaDespesa" class="form-label">Categoria</label>
        </div>
        
        <div class="form-group">
          <select id="formaPagamento" class="form-control" onchange="toggleParcelamento()" required>
            <option value="avista">À Vista</option>
            <option value="cartao">Cartão</option>
          </select>
          <label for="formaPagamento" class="form-label">Forma de Pagamento</label>
        </div>
        
        <div id="parcelamentoDiv" class="hidden">
          <div class="form-group">
            <select id="cartaoDespesa" class="form-control" required>
              <option value="">Selecione o Cartão</option>
              <!-- Preenchido via JavaScript -->
            </select>
            <label for="cartaoDespesa" class="form-label">Cartão</label>
          </div>
          
          <div class="form-group">
            <input type="number" id="numParcelasDespesa" class="form-control" min="1" max="12" placeholder=" " required>
            <label for="numParcelasDespesa" class="form-label">Número de Parcelas</label>
          </div>
        </div>
        
        <button type="button" class="btn btn-primary" onclick="salvarDespesa()">Salvar Despesa</button>
      </form>
    </div>
  </div>
  
  <!-- Modal: Pagamento de Despesa -->
  <div id="pagarDespesaModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('pagarDespesaModal')">&times;</span>
      <h2>Pagar Despesa</h2>
      
      <div class="form-group">
        <input type="text" id="despesaSearch" class="form-control" placeholder=" " maxlength="25">
        <label for="despesaSearch" class="form-label">Descrição</label>
      </div>
      
      <div class="form-group">
        <input type="text" id="mesFiltro" class="form-control" placeholder=" " list="meses">
        <label for="mesFiltro" class="form-label">Mês (ex: JAN)</label>
        <datalist id="meses">
          <option value="JAN"></option>
          <option value="FEV"></option>
          <option value="MAR"></option>
          <option value="ABR"></option>
          <option value="MAI"></option>
          <option value="JUN"></option>
          <option value="JUL"></option>
          <option value="AGO"></option>
          <option value="SET"></option>
          <option value="OUT"></option>
          <option value="NOV"></option>
          <option value="DEZ"></option>
        </datalist>
      </div>
      
      <div class="form-group">
        <input type="text" id="anoFiltro" class="form-control" placeholder=" " list="anos">
        <label for="anoFiltro" class="form-label">Ano (ex: 2025)</label>
        <datalist id="anos">
          <!-- Preenchido via JavaScript -->
        </datalist>
      </div>
      
      <div class="form-group">
        <select id="categoriaFiltro" class="form-control">
          <option value="">Todas as categorias</option>
          <!-- Preenchido via JavaScript -->
        </select>
        <label for="categoriaFiltro" class="form-label">Categoria</label>
      </div>
      
      <div class="form-group">
        <div class="custom-checkbox">
          <input type="checkbox" id="contaMesFiltro">
          <span class="checkmark"></span>
          Apenas despesas do mês
        </div>
      </div>
      
      <button type="button" class="btn btn-secondary" onclick="filtrarDespesas()">Filtrar</button>
      
      <div class="form-group mt-4">
        <select id="despesaSelect" class="form-control" size="5">
          <!-- Preenchido via JavaScript -->
        </select>
        <label for="despesaSelect" class="form-label">Selecione a despesa para pagar</label>
      </div>
      
      <button type="button" class="btn btn-primary" onclick="pagarDespesaSelecionada()">Pagar Despesa</button>
    </div>
  </div>
  
  <!-- Modal: Calendário -->
  <div id="calendarModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('calendarModal')">&times;</span>
      <h2 id="calendarTitulo">Calendário de Despesas</h2>
      
      <div class="calendar-enhanced">
        <div class="calendar-header">
          <button class="calendar-nav-btn" onclick="prevMonth()">
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="calendar-title" id="calendarMonthYear"></div>
          <button class="calendar-nav-btn" onclick="nextMonth()">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        
        <div class="calendar-grid" id="calendarGrid">
          <!-- Preenchido via JavaScript -->
        </div>
      </div>
      
      <div id="saldoDisponivelContainer" class="mt-3 text-center"></div>
    </div>
  </div>
  
  <!-- Modal: Gerenciar Categorias -->
  <div id="categoriasModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('categoriasModal')">&times;</span>
      <h2>Gerenciar Categorias</h2>
      
      <div class="form-group">
        <input type="text" id="categoriaNome" class="form-control" placeholder=" ">
        <label for="categoriaNome" class="form-label">Nome da Categoria</label>
      </div>
      
      <div class="form-group">
        <input type="color" id="categoriaCor" class="form-control" value="#4361ee">
        <label for="categoriaCor" class="form-label">Cor da Categoria</label>
      </div>
      
      <button type="button" class="btn btn-primary" onclick="salvarCategoria()">Salvar Categoria</button>
      
      <div id="categoriasLista" class="mt-4">
        <!-- Preenchido via JavaScript -->
      </div>
    </div>
  </div>
  
  <!-- Modal: Gerenciar Cartões -->
  <div id="cartaoModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('cartaoModal')">&times;</span>
      <h2>Gerenciar Cartões</h2>
      
      <div class="form-group">
        <input type="text" id="nomeCartao" class="form-control" placeholder=" ">
        <label for="nomeCartao" class="form-label">Nome do Cartão</label>
      </div>
      
      <div class="form-group">
        <input type="number" id="diaFatura" class="form-control" placeholder=" " min="1" max="31">
        <label for="diaFatura" class="form-label">Dia da Fatura</label>
      </div>
      
      <div class="form-group">
        <input type="number" id="diaFechamento" class="form-control" placeholder=" " min="1" max="31">
        <label for="diaFechamento" class="form-label">Dia do Fechamento</label>
      </div>
      
      <div class="form-group">
        <input type="number" id="limiteCartao" class="form-control" placeholder=" " step="0.01">
        <label for="limiteCartao" class="form-label">Limite do Cartão (R$)</label>
      </div>
      
      <button type="button" class="btn btn-primary" onclick="salvarCartao()">Salvar Cartão</button>
      
      <div id="cartoesLista" class="mt-4">
        <!-- Preenchido via JavaScript -->
      </div>
    </div>
  </div>
  
  <!-- Modal: Cadastro de Renda -->
  <div id="cadastroModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('cadastroModal')">&times;</span>
      <h2>Cadastrar Renda</h2>
      
      <div class="form-group">
        <input type="text" id="nomePessoa" class="form-control" placeholder=" ">
        <label for="nomePessoa" class="form-label">Nome</label>
      </div>
      
      <div class="form-group">
        <input type="number" id="saldoInicial" class="form-control" placeholder=" " step="0.01">
        <label for="saldoInicial" class="form-label">Saldo Inicial (R$)</label>
      </div>
      
      <div class="form-group">
        <div class="custom-checkbox">
          <input type="checkbox" id="cltCheckbox" onchange="toggleClt()">
          <span class="checkmark"></span>
          Funcionário CLT
        </div>
      </div>
      
      <div id="cltFields" style="display: none;">
        <div class="form-group">
          <input type="number" id="salarioBruto" class="form-control" placeholder=" " step="0.01" onchange="atualizarSalarioLiquido()">
          <label for="salarioBruto" class="form-label">Salário Bruto (R$)</label>
        </div>
        
        <div class="form-group">
          <input type="number" id="dependentes" class="form-control" placeholder=" " min="0" onchange="atualizarSalarioLiquido()">
          <label for="dependentes" class="form-label">Número de Dependentes</label>
        </div>
        
        <div class="form-group">
          <input type="number" id="outrosDescontos" class="form-control" placeholder=" " step="0.01" onchange="atualizarSalarioLiquido()">
          <label for="outrosDescontos" class="form-label">Outros Descontos (R$)</label>
        </div>
        
        <div class="form-group">
          <input type="number" id="salarioLiquido" class="form-control" placeholder=" " step="0.01" readonly>
          <label for="salarioLiquido" class="form-label">Salário Líquido (R$)</label>
        </div>
      </div>
      
      <div id="pagamentosContainer">
        <h3 class="mt-4 mb-3">Pagamentos</h3>
        <div id="pagamentos">
          <div class="pagamento-item">
            <div class="form-group">
              <input type="number" class="pagamento-dia form-control" placeholder=" " min="1" max="31">
              <label class="form-label">Dia do Pagamento</label>
            </div>
            <div class="form-group">
              <input type="number" class="pagamento-valor form-control" placeholder=" " step="0.01">
              <label class="form-label">Valor (R$)</label>
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-secondary mt-2" onclick="adicionarPagamento()">
          <i class="fas fa-plus"></i> Adicionar Pagamento
        </button>
      </div>
      
      <button type="button" class="btn btn-primary mt-4" onclick="salvarRenda()">Salvar Renda</button>
    </div>
  </div>
  
  <!-- Modal: Metas Financeiras -->
  <div id="goalModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('goalModal')">&times;</span>
      <h2>Nova Meta Financeira</h2>
      
      <form id="goalForm">
        <div class="form-group">
          <input type="text" id="goalName" class="form-control" placeholder=" " required>
          <label for="goalName" class="form-label">Nome da Meta</label>
        </div>
        
        <div class="form-group">
          <input type="number" id="goalAmount" class="form-control" placeholder=" " step="0.01" required>
          <label for="goalAmount" class="form-label">Valor da Meta (R$)</label>
        </div>
        
        <div class="form-group">
          <input type="date" id="goalDate" class="form-control" required>
          <label for="goalDate" class="form-label">Data Limite</label>
        </div>
        
        <div class="form-group">
          <select id="goalCategory" class="form-control">
            <option value="">Selecione uma categoria (opcional)</option>
            <option value="viagem">Viagem</option>
            <option value="carro">Carro</option>
            <option value="casa">Casa</option>
            <option value="educacao">Educação</option>
            <option value="aposentadoria">Aposentadoria</option>
            <option value="emergencia">Fundo de Emergência</option>
            <option value="outro">Outro</option>
          </select>
          <label for="goalCategory" class="form-label">Categoria</label>
        </div>
        
        <div class="form-group">
          <input type="number" id="goalInitialAmount" class="form-control" placeholder=" " step="0.01">
          <label for="goalInitialAmount" class="form-label">Valor Inicial (R$)</label>
        </div>
        
        <button type="button" class="btn btn-primary" onclick="saveFinancialGoal()">Salvar Meta</button>
      </form>
    </div>
  </div>
  
  <!-- Modal: Editar Meta -->
  <div id="editGoalModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('editGoalModal')">&times;</span>
      <h2>Editar Meta Financeira</h2>
      
      <form id="editGoalForm">
        <input type="hidden" id="editGoalId">
        
        <div class="form-group">
          <input type="text" id="editGoalName" class="form-control" placeholder=" " required>
          <label for="editGoalName" class="form-label">Nome da Meta</label>
        </div>
        
        <div class="form-group">
          <input type="number" id="editGoalAmount" class="form-control" placeholder=" " step="0.01" required>
          <label for="editGoalAmount" class="form-label">Valor da Meta (R$)</label>
        </div>
        
        <div class="form-group">
          <input type="date" id="editGoalDate" class="form-control" required>
          <label for="editGoalDate" class="form-label">Data Limite</label>
        </div>
        
        <div class="form-group">
          <select id="editGoalCategory" class="form-control">
            <option value="">Selecione uma categoria (opcional)</option>
            <option value="viagem">Viagem</option>
            <option value="carro">Carro</option>
            <option value="casa">Casa</option>
            <option value="educacao">Educação</option>
            <option value="aposentadoria">Aposentadoria</option>
            <option value="emergencia">Fundo de Emergência</option>
            <option value="outro">Outro</option>
          </select>
          <label for="editGoalCategory" class="form-label">Categoria</label>
        </div>
        
        <button type="button" class="btn btn-primary" onclick="updateGoal()">Atualizar Meta</button>
      </form>
    </div>
  </div>
  
  <!-- Modal: Adicionar Contribuição -->
  <div id="contributionModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('contributionModal')">&times;</span>
      <h2>Adicionar Contribuição</h2>
      
      <form id="contributionForm">
        <input type="hidden" id="contributionGoalId">
        
        <div class="mb-3">
          <strong>Meta:</strong> <span id="contributionGoalName"></span>
        </div>
        
        <div class="mb-3">
          <strong>Valor Atual:</strong> <span id="contributionCurrentAmount"></span>
        </div>
        
        <div class="mb-3">
          <strong>Valor da Meta:</strong> <span id="contributionTargetAmount"></span>
        </div>
        
        <div class="form-group">
          <input type="number" id="contributionAmount" class="form-control" placeholder=" " step="0.01" required>
          <label for="contributionAmount" class="form-label">Valor da Contribuição (R$)</label>
        </div>
        
        <div class="form-group">
          <input type="text" id="contributionDescription" class="form-control" placeholder=" ">
          <label for="contributionDescription" class="form-label">Descrição (opcional)</label>
        </div>
        
        <button type="button" class="btn btn-primary" onclick="saveContribution()">Adicionar</button>
      </form>
    </div>
  </div>
  
  <!-- Modal: Orçamento -->
  <div id="budgetModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('budgetModal')">&times;</span>
      <h2>Definir Orçamento</h2>
      
      <form id="budgetForm">
        <div class="form-group">
          <select id="budgetCategory" class="form-control" required>
            <option value="">Selecione uma categoria</option>
            <!-- Preenchido via JavaScript -->
          </select>
          <label for="budgetCategory" class="form-label">Categoria</label>
        </div>
        
        <div class="form-group">
          <input type="number" id="budgetLimit" class="form-control" placeholder=" " step="0.01" required>
          <label for="budgetLimit" class="form-label">Limite Mensal (R$)</label>
        </div>
        
        <button type="button" class="btn btn-primary" onclick="saveBudget()">Salvar Orçamento</button>
      </form>
    </div>
  </div>
  
  <!-- Modal: Editar Orçamento -->
  <div id="editBudgetModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('editBudgetModal')">&times;</span>
      <h2>Editar Orçamento</h2>
      
      <form id="editBudgetForm">
        <input type="hidden" id="editBudgetCategoryId">
        
        <div class="mb-3">
          <strong>Categoria:</strong> <span id="editBudgetCategory"></span>
        </div>
        
        <div class="form-group">
          <input type="number" id="editBudgetLimit" class="form-control" placeholder=" " step="0.01" required>
          <label for="editBudgetLimit" class="form-label">Limite Mensal (R$)</label>
        </div>
        
        <button type="button" class="btn btn-primary" onclick="updateBudget()">Atualizar Orçamento</button>
      </form>
    </div>
  </div>
  
  <!-- Modal: Configurações de Notificações -->
  <div id="notificationSettingsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('notificationSettingsModal')">&times;</span>
      <h2>Configurações de Notificações</h2>
      
      <form id="notificationSettingsForm">
        <div class="form-group">
          <div class="custom-checkbox">
            <input type="checkbox" id="notifyBudget" checked>
            <span class="checkmark"></span>
            Alertas de orçamento
          </div>
        </div>
        
        <div class="form-group">
          <div class="custom-checkbox">
            <input type="checkbox" id="notifyDueDate" checked>
            <span class="checkmark"></span>
            Vencimentos próximos
          </div>
        </div>
        
        <div class="form-group">
          <div class="custom-checkbox">
            <input type="checkbox" id="notifyOverdue" checked>
            <span class="checkmark"></span>
            Despesas vencidas
          </div>
        </div>
        
        <div class="form-group">
          <div class="custom-checkbox">
            <input type="checkbox" id="notifyGoals" checked>
            <span class="checkmark"></span>
            Metas financeiras
          </div>
        </div>
        
        <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()">Salvar Configurações</button>
      </form>
    </div>
  </div>
  
  <!-- ===================== SCRIPTS ===================== -->
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-database-compat.js"></script>
  
  <!-- Scripts do Sistema -->
  <script src="financial_features.js"></script>
  
  <script>
    'use strict';
    
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAG6LktPXGe6F-vSTHV2Y3n95vSwhpXch8",
      authDomain: "controlegasto-df3f1.firebaseapp.com",
      databaseURL: "https://controlegasto-df3f1-default-rtdb.firebaseio.com",
      projectId: "controlegasto-df3f1",
      storageBucket: "controlegasto-df3f1.firebasestorage.app",
      messagingSenderId: "1034936676414",
      appId: "1:1034936676414:web:61c67ce39c3ab71a07a16f",
      measurementId: "G-PTN43GZHGR"
    };
    
    // Inicializar Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    
    const auth = firebase.auth();
    const db = firebase.database();
    
    // Verificar autenticação
    auth.onAuthStateChanged(user => {
      if (user) {
        // Usuário está logado
        updateUserInfo(user);
        initializeApp();
      } else {
        // Usuário não está logado, redirecionar para página de login
        window.location.href = 'login_system.html';
      }
    });
    
    // Atualizar informações do usuário
    function updateUserInfo(user) {
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      const userEmail = document.getElementById('userEmail');
      
      if (user.photoURL) {
        userAvatar.innerHTML = `<img src="${user.photoURL}" alt="${user.displayName || 'Usuário'}" />`;
      } else {
        userAvatar.innerHTML = user.displayName ? user.displayName.charAt(0).toUpperCase() : '<i class="fas fa-user"></i>';
      }
      
      userName.textContent = user.displayName || 'Usuário';
      userEmail.textContent = user.email;
      
      // Verificar notificações
      checkAllNotifications();
    }
    
    // Inicializar aplicativo
    function initializeApp() {
      // Carregar mapa de categorias
      window.novo_categoriasMap = {};
      db.ref("categorias").once("value").then(snapshot => {
        snapshot.forEach(child => {
          window.novo_categoriasMap[child.key] = child.val().nome;
        });
        
        // Inicializar componentes após carregar categorias
        preencherDashboardAno();
        document.getElementById("dashboardMonth").value = new Date().getMonth();
        atualizarDashboard();
        updateDespesasMesTitle();
        carregarPainelDespesasMes();
        
        // Carregar dados para o dashboard
        loadFinancialGoalsForDashboard();
        loadBudgetsForDashboard();
        
        // Configurar daterangepicker
        setupDateRangePicker();
        
        // Inicializar tema
        initializeTheme();
      });
    }
    
    // Carregar metas para o dashboard
    function loadFinancialGoalsForDashboard() {
      const userId = firebase.auth().currentUser.uid;
      const goalsContainer = document.getElementById('dashboardGoals');
      
      db.ref(`users/${userId}/goals`).limitToFirst(3).once('value').then(snapshot => {
        if (!snapshot.exists()) {
          goalsContainer.innerHTML = '<p class="text-center">Você ainda não tem metas cadastradas.</p>';
          return;
        }
        
        goalsContainer.innerHTML = '';
        
        snapshot.forEach(childSnapshot => {
          const goal = childSnapshot.val();
          const progress = calculateGoalProgress(goal);
          
          const goalItem = document.createElement('div');
          goalItem.className = 'mb-3';
          goalItem.innerHTML = `
            <div class="d-flex justify-content-between mb-1">
              <div>${goal.name}</div>
              <div>${progress}%</div>
            </div>
            <div class="progress mb-1">
              <div class="progress-bar progress-bar-primary" style="width: ${progress}%"></div>
            </div>
            <div class="d-flex justify-content-between">
              <div>R$ ${parseFloat(goal.currentAmount).toFixed(2)}</div>
              <div>R$ ${parseFloat(goal.targetAmount).toFixed(2)}</div>
            </div>
          `;
          
          goalsContainer.appendChild(goalItem);
        });
        
        const viewAllLink = document.createElement('div');
        viewAllLink.className = 'text-center mt-3';
        viewAllLink.innerHTML = '<a href="#" onclick="showSection(\'goalsSection\')">Ver todas as metas</a>';
        goalsContainer.appendChild(viewAllLink);
      });
    }
    
    // Carregar orçamentos para o dashboard
    function loadBudgetsForDashboard() {
      const userId = firebase.auth().currentUser.uid;
      const budgetsContainer = document.getElementById('dashboardBudgets');
      
      // Obter mês e ano atual para filtro
      const currentDate = new Date();
      const currentMonth = currentDate.getMonth();
      const currentYear = currentDate.getFullYear();
      
      // Carregar orçamentos do mês atual
      db.ref(`users/${userId}/budgets/${currentYear}/${currentMonth}`).limitToFirst(3).once('value').then(snapshot => {
        if (!snapshot.exists()) {
          budgetsContainer.innerHTML = '<p class="text-center">Você ainda não definiu orçamentos para este mês.</p>';
          return;
        }
        
        // Obter despesas do mês para calcular o progresso
        getMonthlyExpensesByCategory(currentYear, currentMonth).then(expenses => {
          budgetsContainer.innerHTML = '';
          
          snapshot.forEach(childSnapshot => {
            const budget = childSnapshot.val();
            const categoryId = childSnapshot.key;
            const categoryName = window.novo_categoriasMap[categoryId] || categoryId;
            const spent = expenses[categoryId] || 0;
            const limit = parseFloat(budget.limit);
            const progress = Math.min(Math.round((spent / limit) * 100), 100);
            
            let statusClass = 'success';
            if (progress >= 80 && progress < 100) {
              statusClass = 'warning';
            } else if (progress >= 100) {
              statusClass = 'danger';
            }
            
            const budgetItem = document.createElement('div');
            budgetItem.className = 'mb-3';
            budgetItem.innerHTML = `
              <div class="d-flex justify-content-between mb-1">
                <div>${categoryName}</div>
                <div>${progress}%</div>
              </div>
              <div class="progress mb-1">
                <div class="progress-bar progress-bar-${statusClass}" style="width: ${progress}%"></div>
              </div>
              <div class="d-flex justify-content-between">
                <div>R$ ${spent.toFixed(2)}</div>
                <div>R$ ${limit.toFixed(2)}</div>
              </div>
            `;
            
            budgetsContainer.appendChild(budgetItem);
          });
          
          const viewAllLink = document.createElement('div');
          viewAllLink.className = 'text-center mt-3';
          viewAllLink.innerHTML = '<a href="#" onclick="showSection(\'budgetSection\')">Ver todos os orçamentos</a>';
          budgetsContainer.appendChild(viewAllLink);
        });
      });
    }
    
    // Configurar DateRangePicker
    function setupDateRangePicker() {
      $('#dataRange').daterangepicker({
        autoUpdateInput: false,
        locale: {
          format: 'DD/MM/YYYY',
          applyLabel: 'Aplicar',
          cancelLabel: 'Cancelar',
          fromLabel: 'Data Inicial',
          toLabel: 'Data Final',
          customRangeLabel: 'Personalizado',
          weekLabel: 'S',
          daysOfWeek: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'],
          monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'],
          firstDay: 0
        }
      });
      
      $('#dataRange').on('apply.daterangepicker', function(ev, picker) {
        rangeStart = picker.startDate.toDate();
        rangeEnd = picker.endDate.toDate();
        $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
        loadRelatorioMensal();
      });
      
      $('#dataRange').on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
        rangeStart = null;
        rangeEnd = null;
        loadRelatorioMensal();
      });
    }
    
    // Inicializar tema
    function initializeTheme() {
      const themeToggle = document.getElementById('themeToggle');
      let darkMode = localStorage.getItem('darkMode') === 'true';
      
      function updateTheme() {
        if (darkMode) {
          document.body.setAttribute('data-theme', 'dark');
          themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
          document.body.removeAttribute('data-theme');
          themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }
      }
      
      updateTheme();
      
      themeToggle.addEventListener('click', () => {
        darkMode = !darkMode;
        localStorage.setItem('darkMode', darkMode);
        updateTheme();
      });
    }
    
    // Navegação entre seções
    function showSection(sectionId) {
      // Ocultar todas as seções
      document.querySelectorAll('main > section').forEach(section => {
        section.style.display = 'none';
      });
      
      // Mostrar a seção selecionada
      document.getElementById(sectionId).style.display = 'block';
      
      // Atualizar links ativos no menu
      document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      document.querySelectorAll(`.nav-link[data-section="${sectionId}"], .mobile-nav-link[data-section="${sectionId}"]`).forEach(link => {
        link.classList.add('active');
      });
      
      // Carregar dados específicos da seção
      switch (sectionId) {
        case 'goalsSection':
          loadFinancialGoals();
          break;
        case 'budgetSection':
          loadBudgets();
          break;
        case 'cashFlowSection':
          loadCashFlow();
          break;
        case 'trendsSection':
          loadTrendsAnalysis();
          break;
        case 'comparisonSection':
          loadExpenseComparison();
          break;
        case 'notificationsSection':
          loadNotifications();
          break;
        case 'relatorioSection':
          loadRelatorioMensal();
          break;
        case 'categoriasSection':
          loadCategorias();
          break;
        case 'cartoesSection':
          loadCartoes();
          break;
        case 'rendaSection':
          loadRendas();
          break;
        case 'despesasSection':
          filtrarDespesasGlobal();
          break;
      }
      
      // Fechar menu lateral em dispositivos móveis
      if (window.innerWidth < 768) {
        document.querySelector('.app-container').classList.remove('sidebar-open');
      }
    }
    
    // Abrir modal
    window.abrirModal = function(id) {
      document.getElementById(id).style.display = "flex";
      
      // Ações específicas para cada modal
      switch (id) {
        case 'categoriasModal':
          loadCategorias();
          break;
        case 'cartaoModal':
          loadCartoes();
          break;
        case 'calendarModal':
          document.getElementById("calendarTitulo").innerText = "Calendário de Despesas";
          renderCalendar();
          break;
        case 'pagarDespesaModal':
          filtrarDespesas();
          break;
        case 'goalModal':
          document.getElementById('goalDate').value = new Date().toISOString().split('T')[0];
          break;
        case 'budgetModal':
          loadCategoriesForBudget();
          break;
      }
    };
    
    // Fechar modal
    window.fecharModal = function(id) {
      document.getElementById(id).style.display = "none";
    };
    
    // Logout
    document.getElementById('logoutButton').addEventListener('click', (e) => {
      e.preventDefault();
      
      auth.signOut().then(() => {
        window.location.href = 'login_system.html';
      }).catch((error) => {
        console.error('Erro ao fazer logout:', error);
        showToast('Erro ao fazer logout. Tente novamente.', 'danger');
      });
    });
    
    // Toggle do menu lateral
    document.getElementById('sidebarToggle').addEventListener('click', () => {
      document.querySelector('.app-container').classList.toggle('sidebar-collapsed');
    });
    
    // Toggle do menu mobile
    document.getElementById('mobileMenuButton').addEventListener('click', (e) => {
      e.preventDefault();
      document.querySelector('.app-container').classList.toggle('sidebar-open');
    });
    
    // Navegação por links do menu
    document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
      if (link.dataset.section) {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          showSection(link.dataset.section);
        });
      }
    });
    
    // Funções para adicionar pagamentos no cadastro de renda
    function adicionarPagamento() {
      const pagamentosContainer = document.getElementById('pagamentos');
      const novoPagamento = document.createElement('div');
      novoPagamento.className = 'pagamento-item';
      novoPagamento.innerHTML = `
        <div class="form-group">
          <input type="number" class="pagamento-dia form-control" placeholder=" " min="1" max="31">
          <label class="form-label">Dia do Pagamento</label>
        </div>
        <div class="form-group">
          <input type="number" class="pagamento-valor form-control" placeholder=" " step="0.01">
          <label class="form-label">Valor (R$)</label>
        </div>
        <button type="button" class="btn btn-danger btn-icon" onclick="removerPagamento(this)">
          <i class="fas fa-trash"></i>
        </button>
      `;
      pagamentosContainer.appendChild(novoPagamento);
    }
    
    function removerPagamento(button) {
      const pagamentoItem = button.closest('.pagamento-item');
      pagamentoItem.remove();
    }
    
    // Filtrar despesas globalmente
    function filtrarDespesasGlobal() {
      const searchText = document.getElementById("despesaSearchFilter").value.toLowerCase();
      const categoriaFiltro = document.getElementById("categoriaFiltroGlobal").value;
      const statusFiltro = document.getElementById("statusFiltro").value;
      const dataRange = document.getElementById("dataRangeDespesas").value;
      
      let startDate = null;
      let endDate = null;
      
      if (dataRange) {
        const dates = dataRange.split(' - ');
        if (dates.length === 2) {
          const [startDay, startMonth, startYear] = dates[0].split('/');
          const [endDay, endMonth, endYear] = dates[1].split('/');
          
          startDate = new Date(startYear, startMonth - 1, startDay);
          endDate = new Date(endYear, endMonth - 1, endDay);
        }
      }
      
      const tableBody = document.getElementById("despesasTableBody");
      tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Carregando...</td></tr>';
      
      db.ref("despesas").once("value").then(snapshot => {
        tableBody.innerHTML = '';
        let despesasEncontradas = false;
        
        snapshot.forEach(child => {
          const despesa = child.val();
          const descricao = despesa.descricao.toLowerCase();
          const categoria = despesa.categoria;
          
          // Verificar filtro de texto
          if (searchText && !descricao.includes(searchText)) return;
          
          // Verificar filtro de categoria
          if (categoriaFiltro && categoria !== categoriaFiltro) return;
          
          // Processar despesas à vista
          if (despesa.formaPagamento === "avista") {
            const dataCompra = new Date(despesa.dataCompra);
            
            // Verificar filtro de data
            if (startDate && endDate) {
              if (dataCompra < startDate || dataCompra > endDate) return;
            }
            
            // Verificar filtro de status
            if (statusFiltro === "pending" && despesa.pago) return;
            if (statusFiltro === "paid" && !despesa.pago) return;
            
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${despesa.descricao}</td>
              <td>${window.novo_categoriasMap[categoria] || categoria}</td>
              <td>${dataCompra.toLocaleDateString()}</td>
              <td>R$ ${parseFloat(despesa.valor).toFixed(2)}</td>
              <td>À Vista</td>
              <td>
                <span class="badge badge-${despesa.pago ? 'success' : 'warning'}">
                  ${despesa.pago ? 'Pago' : 'Pendente'}
                </span>
              </td>
              <td>
                <button class="btn btn-icon" onclick="editarDespesa('${child.key}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-icon" onclick="excluirDespesa('${child.key}')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            `;
            tableBody.appendChild(row);
            despesasEncontradas = true;
          }
          // Processar despesas no cartão
          else if (despesa.formaPagamento === "cartao" && despesa.parcelas) {
            despesa.parcelas.forEach((parcela, index) => {
              const dataVencimento = new Date(parcela.vencimento);
              
              // Verificar filtro de data
              if (startDate && endDate) {
                if (dataVencimento < startDate || dataVencimento > endDate) return;
              }
              
              // Verificar filtro de status
              if (statusFiltro === "pending" && parcela.pago) return;
              if (statusFiltro === "paid" && !parcela.pago) return;
              
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${despesa.descricao} - Parcela ${index + 1}/${despesa.parcelas.length}</td>
                <td>${window.novo_categoriasMap[categoria] || categoria}</td>
                <td>${dataVencimento.toLocaleDateString()}</td>
                <td>R$ ${parseFloat(parcela.valor).toFixed(2)}</td>
                <td>Cartão - ${despesa.cartao?.nome || 'N/A'}</td>
                <td>
                  <span class="badge badge-${parcela.pago ? 'success' : 'warning'}">
                    ${parcela.pago ? 'Pago' : 'Pendente'}
                  </span>
                </td>
                <td>
                  <button class="btn btn-icon" onclick="editarParcelaDespesa('${child.key}', ${index})">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-icon" onclick="excluirDespesa('${child.key}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              `;
              tableBody.appendChild(row);
              despesasEncontradas = true;
            });
          }
        });
        
        if (!despesasEncontradas) {
          tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma despesa encontrada com os filtros selecionados.</td></tr>';
        }
      });
    }
    
    // Limpar filtros de despesas
    function limparFiltrosDespesas() {
      document.getElementById("despesaSearchFilter").value = '';
      document.getElementById("categoriaFiltroGlobal").value = '';
      document.getElementById("statusFiltro").value = 'all';
      document.getElementById("dataRangeDespesas").value = '';
      
      filtrarDespesasGlobal();
    }
    
    // Configurar DateRangePicker para despesas
    $(function() {
      $('#dataRangeDespesas').daterangepicker({
        autoUpdateInput: false,
        locale: {
          format: 'DD/MM/YYYY',
          applyLabel: 'Aplicar',
          cancelLabel: 'Cancelar',
          fromLabel: 'Data Inicial',
          toLabel: 'Data Final',
          customRangeLabel: 'Personalizado',
          weekLabel: 'S',
          daysOfWeek: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'],
          monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'],
          firstDay: 0
        }
      });
      
      $('#dataRangeDespesas').on('apply.daterangepicker', function(ev, picker) {
        $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
      });
      
      $('#dataRangeDespesas').on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
      });
    });
    
    // Salvar configurações de notificações
    function saveNotificationSettings() {
      const userId = firebase.auth().currentUser.uid;
      
      const settings = {
        notifyBudget: document.getElementById('notifyBudget').checked,
        notifyDueDate: document.getElementById('notifyDueDate').checked,
        notifyOverdue: document.getElementById('notifyOverdue').checked,
        notifyGoals: document.getElementById('notifyGoals').checked,
        updatedAt: new Date().toISOString()
      };
      
      db.ref(`users/${userId}/settings/notifications`).set(settings)
        .then(() => {
          showToast('Configurações salvas com sucesso!', 'success');
          fecharModal('notificationSettingsModal');
        })
        .catch(error => {
          console.error('Erro ao salvar configurações:', error);
          showToast('Erro ao salvar configurações. Tente novamente.', 'danger');
        });
    }
    
    // Inicializar aplicativo quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
      // Configurações já são inicializadas no evento onAuthStateChanged
    });
  </script>
</body>
</html>
