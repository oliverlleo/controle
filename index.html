<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciamento de Contas</title>
  <style>
    /* Estilos Gerais */
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #f4f4f9;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1, h2 { color: #333; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover { background: #0056b3; }
    .hidden { display: none; }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: flex-start;
      overflow-y: auto;
      padding: 20px;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #333;
    }
    
    /* Calendário */
    #calendarHeader {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
    }
    #calendarHeader button {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      margin: 0 10px;
      color: #007bff;
    }
    #calendarMonthYear {
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
    }
    #monthYearSelect {
      display: none;
      margin-bottom: 10px;
    }
    #monthYearSelect select {
      width: 48%;
      padding: 8px;
      margin-right: 4%;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    #monthYearSelect button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #calendarGrid {
      overflow-x: auto;
    }
    #calendarGrid table {
      width: 100%;
      border-collapse: collapse;
    }
    #calendarGrid th, #calendarGrid td {
      border: 1px solid #ddd;
      padding: 2px;
      text-align: center;
      min-height: 70px;
      vertical-align: top;
    }
    #calendarGrid th { background: #007bff; color: #fff; }
    /* Célula do Calendário */
    .calendar-cell {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      height: 70px;
      padding: 4px;
      box-sizing: border-box;
    }
    .day-number {
      font-size: 1rem;
      font-weight: bold;
    }
    .expense-info {
      font-size: 0.75rem;
      color: #555;
    }
    
    /* Saldo Disponível */
    #saldoDisponivelContainer {
      text-align: left;
      margin-top: 10px;
      font-weight: bold;
      color: #28a745;
      font-size: 1rem;
    }
    
    /* Relatório */
    #relatorioMensalSection table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #relatorioMensalSection th, #relatorioMensalSection td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    #relatorioMensalSection th { background: #007bff; color: #fff; }
    
    /* Cadastro de Renda */
    .checkbox-group {
      display: flex;
      gap: 20px;
      margin: 15px 0;
      justify-content: center;
    }

    /* Responsividade para o Calendário */
    @media (max-width: 600px) {
      .modal-content {
        width: 95%;
        padding: 15px;
      }
      #calendarGrid th, #calendarGrid td {
        padding: 5px;
        min-height: 50px;
      }
      #calendarHeader button {
        font-size: 1.2rem;
        margin: 0 5px;
      }
      #calendarMonthYear {
        font-size: 1rem;
      }
      .day-number {
        font-size: 0.9rem;
      }
      .expense-info {
        font-size: 0.7rem;
      }
    }
  </style>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-database-compat.js"></script>
</head>
<body>
  <!-- Menu Principal -->
  <div class="container">
    <h1>Gerenciamento de Contas</h1>
    <button onclick="abrirModal('cadastroModal')">Cadastrar Nova Renda</button>
    <button onclick="abrirModal('fonteModal')">Fonte de Renda</button>
    <button onclick="abrirModal('categoriasModal')">Gerenciar Categorias</button>
    <button onclick="abrirModal('cartaoModal')">Gerenciar Cartões</button>
    <button onclick="abrirModal('calendarModal')">Calendário</button>
  </div>

  <!-- Cadastro de Despesa -->
  <div class="container">
    <h2>Cadastrar Despesa</h2>
    <label>Descrição:</label>
    <input type="text" id="despesaDescricao" placeholder="Descrição da despesa" required>
    <label>Valor (R$):</label>
    <input type="number" id="despesaValor" placeholder="Valor" step="0.01" required>
    <label>Data da Compra:</label>
    <input type="date" id="dataCompra" required>
    <label>Categoria:</label>
    <select id="categoriaDespesa">
      <option value="">Selecione a Categoria</option>
    </select>
    <label>Forma de Pagamento:</label>
    <select id="formaPagamento" onchange="toggleParcelamento()">
      <option value="avista">À Vista</option>
      <option value="cartao">Cartão</option>
    </select>
    <div id="parcelamentoDiv" class="hidden">
      <label>Cartão:</label>
      <select id="cartaoDespesa" required>
        <option value="">Selecione o Cartão</option>
      </select>
      <label>Número de Parcelas:</label>
      <input type="number" id="numParcelasDespesa" min="1" max="12" required>
    </div>
    <button onclick="salvarDespesa()">Salvar Despesa</button>
  </div>

  <!-- Pagar Despesa -->
  <div class="container">
    <h2>Pagar Despesa</h2>
    <label>Pesquisar Despesa:</label>
    <input type="text" id="despesaSearch" placeholder="Digite parte da descrição...">
    <select id="despesaSelect" size="5"></select>
    <button onclick="pagarDespesaSelecionada()">Pagar Despesa Selecionada</button>
  </div>

  <!-- Relatório Mensal -->
  <div class="container" id="relatorioMensalSection">
    <h2>Relatório Mensal de Despesas Pagas</h2>
    <button onclick="loadRelatorioMensal()">Atualizar Relatório</button>
    <div id="relatorioMensalContainer"></div>
  </div>

  <!-- Modal de Calendário -->
  <div id="calendarModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('calendarModal')">&times;</span>
      <h2>Calendário de Despesas</h2>
      <div id="calendarHeader">
        <button onclick="prevMonth()">&#9664;</button>
        <span id="calendarMonthYear" onclick="toggleMonthYearSelect()"></span>
        <button onclick="nextMonth()">&#9654;</button>
      </div>
      <div id="monthYearSelect">
        <select id="selectMonth" onchange="updateCalendarFromSelect()">
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
        <select id="selectYear" onchange="updateCalendarFromSelect()">
          <!-- Preenchido dinamicamente -->
        </select>
        <button onclick="toggleMonthYearSelect()">Ok</button>
      </div>
      <div id="calendarGrid"></div>
      <!-- Área fixa para exibição do saldo disponível -->
      <div id="saldoDisponivelContainer">Saldo Atual: R$ 0,00</div>
    </div>
  </div>

  <!-- Modal de Cadastro de Renda -->
  <div id="cadastroModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('cadastroModal')">&times;</span>
      <h2>Cadastrar Nova Renda</h2>
      <div id="mensagemSucessoRenda"></div>
      <form id="cadastroForm">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" placeholder="Nome" required>
        <label for="parentesco">Parentesco:</label>
        <select id="parentesco" required>
          <option value="eu">Eu</option>
          <option value="pai">Pai</option>
          <option value="irma">Irmã</option>
          <option value="esposa">Esposa</option>
          <option value="filho">Filho</option>
          <option value="filha">Filha</option>
          <option value="outros">Outros</option>
        </select>
        <div class="checkbox-group">
          <label><input type="checkbox" id="cltCheckbox" onclick="toggleClt()"> CLT</label>
          <label><input type="checkbox" id="pjCheckbox"> PJ</label>
        </div>
        <div id="cltFields" style="display: none;">
          <label for="salarioBruto">Salário Bruto (R$):</label>
          <input type="number" id="salarioBruto" placeholder="Digite o salário bruto" step="0.01" oninput="atualizarSalarioLiquido()">
          <label for="salarioLiquido">Salário Líquido (R$):</label>
          <input type="number" id="salarioLiquido" placeholder="Salário líquido calculado" step="0.01">
          <label for="numPagamentos">Número de Pagamentos no Mês:</label>
          <input type="number" id="numPagamentos" placeholder="Digite o número de pagamentos" min="1" max="5" oninput="gerarCamposPagamentos()">
          <div id="pagamentosContainer"></div>
          <p id="avisoErro" style="color: red; display: none;">Os valores não somam o salário líquido!</p>
        </div>
        <button type="submit">Salvar</button>
      </form>
    </div>
  </div>

  <!-- Modal Fonte de Renda -->
  <div id="fonteModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('fonteModal')">&times;</span>
      <h2>Fonte de Renda</h2>
      <div id="usuariosLista"></div>
    </div>
  </div>

  <!-- Modal Gerenciar Categorias -->
  <div id="categoriasModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('categoriasModal')">&times;</span>
      <h2>Gerenciar Categorias</h2>
      <label>Nome da Categoria:</label>
      <input type="text" id="categoriaNome" placeholder="Nome da categoria">
      <button onclick="salvarCategoria()">Salvar Categoria</button>
      <div id="categoriasLista"></div>
    </div>
  </div>

  <!-- Modal Gerenciar Cartões -->
  <div id="cartaoModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('cartaoModal')">&times;</span>
      <h2>Gerenciar Cartões</h2>
      <label>Nome do Cartão:</label>
      <input type="text" id="nomeCartao" placeholder="Nome do Cartão">
      <label>Dia da Fatura:</label>
      <input type="number" id="diaFatura" placeholder="Ex.: 20" min="1" max="31">
      <label>Dia do Fechamento:</label>
      <input type="number" id="diaFechamento" placeholder="Ex.: 11" min="1" max="31">
      <label>Limite do Cartão (R$):</label>
      <input type="number" id="limiteCartao" placeholder="Limite" step="0.01">
      <button onclick="salvarCartao()">Salvar Cartão</button>
      <div id="cartoesLista"></div>
    </div>
  </div>

  <script>
    'use strict';
    let currentCalendarMonth = new Date().getMonth();
    let currentCalendarYear = new Date().getFullYear();

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAG6LktPXGe6F-vSTHV2Y3n95vSwhpXch8",
      authDomain: "controlegasto-df3f1.firebaseapp.com",
      databaseURL: "https://controlegasto-df3f1-default-rtdb.firebaseio.com",
      projectId: "controlegasto-df3f1",
      storageBucket: "controlegasto-df3f1.firebasestorage.app",
      messagingSenderId: "1034936676414",
      appId: "1:1034936676414:web:61c67ce39c3ab71a07a16f",
      measurementId: "G-PTN43GZHGR"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Funções de Modal
    window.abrirModal = id => {
      document.getElementById(id).style.display = "flex";
      if(id === "fonteModal") loadUsuarios();
      if(id === "categoriasModal") loadCategorias();
      if(id === "cartaoModal") loadCartoes();
      if(id === "calendarModal") renderCalendar();
    };
    window.fecharModal = id => {
      document.getElementById(id).style.display = "none";
    };

    // Fonte de Renda
    function loadUsuarios() {
      const usuariosLista = document.getElementById("usuariosLista");
      usuariosLista.innerHTML = "";
      db.ref("pessoas").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const pessoa = child.val();
          const div = document.createElement("div");
          div.innerHTML = `<strong>Nome:</strong> ${pessoa.nome} - <strong>Salário Líquido:</strong> ${pessoa.salarioLiquido}`;
          usuariosLista.appendChild(div);
        });
      });
    }

    // Módulo Despesa
    function toggleParcelamento() {
      const forma = document.getElementById("formaPagamento").value;
      document.getElementById("parcelamentoDiv").classList.toggle("hidden", forma !== "cartao");
    }

    function salvarDespesa() {
      const descricao = document.getElementById("despesaDescricao").value;
      const valor = parseFloat(document.getElementById("despesaValor").value);
      const dataCompra = document.getElementById("dataCompra").value;
      const categoria = document.getElementById("categoriaDespesa").value;
      const formaPagamento = document.getElementById("formaPagamento").value;
      const despesasRef = db.ref("despesas");

      if(isNaN(valor)) {
        alert("O valor da despesa deve ser um número válido.");
        return;
      }

      if(formaPagamento === "cartao") {
        const selectCartao = document.getElementById("cartaoDespesa");
        if(!selectCartao.value) {
          alert("Selecione um cartão para despesas no cartão.");
          return;
        }
        const numParcelas = parseInt(document.getElementById("numParcelasDespesa").value);
        const cardOption = selectCartao.selectedOptions[0];
        const diaFatura = parseInt(cardOption.getAttribute("data-fatura"));
        const diaFechamento = parseInt(cardOption.getAttribute("data-fechamento"));
        let parcelas = [];
        const purchaseDate = new Date(dataCompra);
        let firstDueDate = new Date(purchaseDate);
        if(purchaseDate.getDate() > diaFechamento) {
          firstDueDate.setMonth(firstDueDate.getMonth() + 1);
          firstDueDate.setDate(diaFatura);
        } else {
          firstDueDate.setDate(diaFatura);
        }
        const valorParcela = parseFloat((valor / numParcelas).toFixed(2));
        for(let i = 0; i < numParcelas; i++){
          let parcelaDate = new Date(firstDueDate);
          parcelaDate.setMonth(parcelaDate.getMonth() + i);
          parcelas.push({
            valor: valorParcela,
            vencimento: parcelaDate.toISOString().split("T")[0],
            pago: false
          });
        }
        const despesaData = {
          descricao,
          formaPagamento,
          dataCompra,
          categoria,
          parcelas,
          cartao: {
            id: selectCartao.value,
            nome: selectCartao.selectedOptions[0].text,
            diaFatura,
            diaFechamento
          },
          timestamp: new Date().toISOString()
        };
        despesasRef.push(despesaData)
          .then(() => {
            alert("Despesa com cartão cadastrada com sucesso!");
            toggleParcelamento();
            loadDespesasNaoPagasSelect();
            renderCalendar();
            updateCartaoSelect();
          })
          .catch(err => alert("Erro: " + err));
      } else {
        const despesaData = {
          descricao,
          valor,
          dataCompra,
          formaPagamento,
          categoria,
          pago: false,
          timestamp: new Date().toISOString()
        };
        despesasRef.push(despesaData)
          .then(() => {
            alert("Despesa à vista cadastrada com sucesso!");
            loadDespesasNaoPagasSelect();
            renderCalendar();
          })
          .catch(err => alert("Erro: " + err));
      }
    }

    function loadDespesasNaoPagasSelect() {
      const despesaSelect = document.getElementById("despesaSelect");
      despesaSelect.innerHTML = "";
      db.ref("despesas").orderByChild("pago").equalTo(false).once("value").then(snapshot => {
        snapshot.forEach(child => {
          const despesa = child.val();
          const option = document.createElement("option");
          option.value = child.key;
          const dataExibicao = (despesa.formaPagamento === "cartao" && despesa.parcelas && despesa.parcelas.length > 0)
                                ? despesa.parcelas[0].vencimento
                                : despesa.dataCompra;
          const valorExibido = despesa.valor ? `R$ ${parseFloat(despesa.valor).toFixed(2)}` : "";
          option.text = `${despesa.descricao} ${valorExibido} - ${dataExibicao}`;
          despesaSelect.appendChild(option);
        });
      });
    }

    function pagarDespesaSelecionada() {
      const despesaSelect = document.getElementById("despesaSelect");
      const selectedValue = despesaSelect.value;
      if(!selectedValue) {
        alert("Selecione uma despesa!");
        return;
      }
      db.ref("despesas").child(selectedValue).update({ pago: true })
        .then(() => {
          alert("Despesa paga com sucesso!");
          loadDespesasNaoPagasSelect();
          renderCalendar();
        })
        .catch(err => alert("Erro ao pagar a despesa: " + err));
    }

    function loadRelatorioMensal() {
      const container = document.getElementById("relatorioMensalContainer");
      container.innerHTML = "";
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      db.ref("despesas").orderByChild("pago").equalTo(true).once("value").then(snapshot => {
        let despesas = [];
        snapshot.forEach(child => {
          const despesa = child.val();
          const dataCompra = new Date(despesa.dataCompra);
          if(dataCompra.getFullYear() === year && dataCompra.getMonth() === month) {
            despesas.push(despesa);
          }
        });
        if(!despesas.length){
          container.innerHTML = "<p>Nenhuma despesa paga neste mês.</p>";
          return;
        }
        const table = document.createElement("table");
        const headerRow = document.createElement("tr");
        ["Descrição", "Valor", "Data", "Categoria"].forEach(text => {
          const th = document.createElement("th");
          th.innerText = text;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        despesas.forEach(despesa => {
          const row = document.createElement("tr");
          const descricaoCell = document.createElement("td");
          descricaoCell.innerText = despesa.descricao;
          const valorCell = document.createElement("td");
          valorCell.innerText = despesa.valor ? parseFloat(despesa.valor).toFixed(2) : "-";
          const dataCell = document.createElement("td");
          dataCell.innerText = despesa.dataCompra;
          const categoriaCell = document.createElement("td");
          categoriaCell.innerText = despesa.categoria;
          row.append(descricaoCell, valorCell, dataCell, categoriaCell);
          table.appendChild(row);
        });
        container.appendChild(table);
      });
    }

    // Módulo Cadastro de Renda
    function toggleClt() {
      document.getElementById("cltFields").style.display =
        document.getElementById("cltCheckbox").checked ? "block" : "none";
    }

    function atualizarSalarioLiquido() {
      const salarioBruto = parseFloat(document.getElementById("salarioBruto").value) || 0;
      const inss = calcularINSS(salarioBruto);
      const irrf = calcularIRRF(salarioBruto - inss);
      const salarioLiquido = salarioBruto - inss - irrf;
      document.getElementById("salarioLiquido").value = salarioLiquido.toFixed(2);
    }

    function calcularINSS(salario) {
      if(salario <= 1320.00) return salario * 0.075;
      if(salario <= 2571.29) return (1320 * 0.075) + ((salario - 1320) * 0.09);
      if(salario <= 3856.94) return (1320 * 0.075) + (1251.29 * 0.09) + ((salario - 2571.29) * 0.12);
      if(salario <= 7507.49) return (1320 * 0.075) + (1251.29 * 0.09) + (1285.65 * 0.12) + ((salario - 3856.94) * 0.14);
      return 876.97;
    }

    function calcularIRRF(base) {
      if(base <= 2112.00) return 0;
      if(base <= 2826.65) return (base * 0.075) - 158.40;
      if(base <= 3751.05) return (base * 0.15) - 370.40;
      if(base <= 4664.68) return (base * 0.225) - 651.73;
      return (base * 0.275) - 884.96;
    }

    function gerarCamposPagamentos() {
      const container = document.getElementById("pagamentosContainer");
      container.innerHTML = "";
      const numPagamentos = parseInt(document.getElementById("numPagamentos").value) || 0;
      const salarioLiquido = parseFloat(document.getElementById("salarioLiquido").value) || 0;
      if(numPagamentos > 1){
        for(let i=1; i<= numPagamentos; i++){
          const div = document.createElement("div");
          div.className = "pagamento-item";
          div.innerHTML = `<label>Dia do Pagamento ${i}:</label>
                           <input type="number" placeholder="Dia" min="1" max="31" required>
                           <label>Valor (R$):</label>
                           <input type="number" class="valoresPagamento" placeholder="Valor R$" step="0.01" oninput="verificarSomaPagamentos()" required>`;
          container.appendChild(div);
        }
      } else if(numPagamentos === 1){
        const div = document.createElement("div");
        div.className = "pagamento-item";
        div.innerHTML = `<label>Dia do Pagamento:</label>
                         <input type="number" placeholder="Dia" min="1" max="31" required>`;
        container.appendChild(div);
        const inputValor = document.createElement("input");
        inputValor.type = "number";
        inputValor.className = "valoresPagamento";
        inputValor.placeholder = "Valor (R$)";
        inputValor.step = "0.01";
        inputValor.value = salarioLiquido.toFixed(2);
        inputValor.readOnly = true;
        container.appendChild(inputValor);
      }
    }

    function verificarSomaPagamentos() {
      let salarioLiquido = parseFloat(document.getElementById("salarioLiquido").value) || 0;
      const valores = document.querySelectorAll(".valoresPagamento");
      let soma = 0;
      valores.forEach(input => {
        soma += parseFloat(input.value) || 0;
      });
      soma = Math.round(soma * 100) / 100;
      salarioLiquido = Math.round(salarioLiquido * 100) / 100;
      document.getElementById("avisoErro").style.display = soma !== salarioLiquido ? "block" : "none";
    }

    document.getElementById("cadastroForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const nome = document.getElementById("nome").value;
      const parentesco = document.getElementById("parentesco").value;
      const salarioBruto = parseFloat(document.getElementById("salarioBruto").value) || 0;
      const salarioLiquido = parseFloat(document.getElementById("salarioLiquido").value) || 0;
      const numPagamentos = parseInt(document.getElementById("numPagamentos").value) || 0;
      const pagamentos = [];
      if(document.getElementById("cltCheckbox").checked){
        const itens = document.getElementById("pagamentosContainer").getElementsByClassName("pagamento-item");
        for(let item of itens){
          const dia = item.querySelector("input[type=number]").value;
          const valor = item.querySelector(".valoresPagamento") ? item.querySelector(".valoresPagamento").value : "";
          pagamentos.push({dia, valor});
        }
      }
      const dados = {
        nome,
        parentesco,
        salarioBruto,
        salarioLiquido,
        numPagamentos,
        pagamentos,
        timestamp: new Date().toISOString()
      };
      db.ref("pessoas").push(dados)
        .then(() => {
          const msg = document.getElementById("mensagemSucessoRenda");
          msg.innerText = "Dados salvos com sucesso!";
          msg.style.display = "block";
          setTimeout(() => {
            msg.style.display = "none";
            document.getElementById("cadastroForm").reset();
            document.getElementById("cltFields").style.display = "none";
            document.getElementById("pagamentosContainer").innerHTML = "";
          }, 3000);
        })
        .catch(err => alert("Erro ao salvar os dados de renda: " + err));
    });

    // Gerenciamento de Categorias
    function loadCategorias() {
      const categoriasLista = document.getElementById("categoriasLista");
      categoriasLista.innerHTML = "";
      db.ref("categorias").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const categoria = child.val();
          const key = child.key;
          const div = document.createElement("div");
          div.innerHTML = `<strong>Nome:</strong> ${categoria.nome} <br>
                           <button onclick="excluirCategoria('${key}')">Excluir</button>`;
          categoriasLista.appendChild(div);
        });
      });
    }

    function salvarCategoria() {
      const nome = document.getElementById("categoriaNome").value;
      if(!nome){
        alert("Preencha o nome da categoria!");
        return;
      }
      db.ref("categorias").push({nome})
        .then(() => {
          alert("Categoria salva com sucesso!");
          document.getElementById("categoriaNome").value = "";
          loadCategorias();
        })
        .catch(err => alert("Erro ao salvar a categoria: " + err));
    }

    function excluirCategoria(key) {
      if(confirm("Deseja realmente excluir esta categoria?")){
        db.ref("categorias").child(key).remove()
          .then(() => {
            alert("Categoria excluída com sucesso!");
            loadCategorias();
          })
          .catch(err => alert("Erro ao excluir a categoria: " + err));
      }
    }

    // Gerenciamento de Cartões
    function loadCartoes() {
      const cartoesLista = document.getElementById("cartoesLista");
      cartoesLista.innerHTML = "";
      db.ref("cartoes").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const cartao = child.val();
          const key = child.key;
          const div = document.createElement("div");
          div.innerHTML = `<strong>Nome:</strong> ${cartao.nome} <br>
                           <strong>Dia da Fatura:</strong> ${cartao.diaFatura} <br>
                           <strong>Dia do Fechamento:</strong> ${cartao.diaFechamento} <br>
                           <strong>Limite:</strong> R$ ${cartao.limite} <br>
                           <button onclick="excluirCartao('${key}')">Excluir</button>`;
          cartoesLista.appendChild(div);
        });
      });
    }

    function salvarCartao() {
      const nome = document.getElementById("nomeCartao").value;
      const diaFatura = document.getElementById("diaFatura").value;
      const diaFechamento = document.getElementById("diaFechamento").value;
      const limite = document.getElementById("limiteCartao").value;
      if(!nome || !diaFatura || !diaFechamento || !limite){
        alert("Preencha todos os campos!");
        return;
      }
      db.ref("cartoes").push({nome, diaFatura, diaFechamento, limite})
        .then(() => {
          alert("Cartão salvo com sucesso!");
          document.getElementById("nomeCartao").value = "";
          document.getElementById("diaFatura").value = "";
          document.getElementById("diaFechamento").value = "";
          document.getElementById("limiteCartao").value = "";
          loadCartoes();
          updateCartaoSelect();
        })
        .catch(err => alert("Erro ao salvar o cartão: " + err));
    }

    function excluirCartao(key) {
      if(confirm("Deseja realmente excluir este cartão?")){
        db.ref("cartoes").child(key).remove()
          .then(() => {
            alert("Cartão excluído com sucesso!");
            loadCartoes();
            updateCartaoSelect();
          })
          .catch(err => alert("Erro ao excluir o cartão: " + err));
      }
    }

    function updateCartaoSelect() {
      const select = document.getElementById("cartaoDespesa");
      select.innerHTML = `<option value="">Selecione o Cartão</option>`;
      db.ref("cartoes").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const cartao = child.val();
          const option = document.createElement("option");
          option.value = child.key;
          option.text = cartao.nome;
          option.setAttribute("data-fatura", cartao.diaFatura);
          option.setAttribute("data-fechamento", cartao.diaFechamento);
          select.appendChild(option);
        });
      });
    }

    function updateCategoriaSelect() {
      const select = document.getElementById("categoriaDespesa");
      select.innerHTML = `<option value="">Selecione a Categoria</option>`;
      db.ref("categorias").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const categoria = child.val();
          const option = document.createElement("option");
          option.value = categoria.nome;
          option.text = categoria.nome;
          select.appendChild(option);
        });
      });
    }

    // Calendário
    function renderCalendar() {
      const monthYearElem = document.getElementById("calendarMonthYear");
      const calendarGrid = document.getElementById("calendarGrid");
      calendarGrid.innerHTML = "";
      const date = new Date(currentCalendarYear, currentCalendarMonth, 1);
      const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
      monthYearElem.innerText = `${date.toLocaleString('pt-BR', { month: 'long' })} ${currentCalendarYear}`;
      
      const table = document.createElement("table");
      const headerRow = document.createElement("tr");
      const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
      weekDays.forEach(day => {
        const th = document.createElement("th");
        th.innerText = day;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);
      
      let row = document.createElement("tr");
      // Preencher células vazias até o primeiro dia da semana
      for(let i = 0; i < date.getDay(); i++){
        const cell = document.createElement("td");
        row.appendChild(cell);
      }
      // Preencher os dias do mês
      for(let day = 1; day <= daysInMonth; day++){
        if(row.children.length === 7){
          table.appendChild(row);
          row = document.createElement("tr");
        }
        const cell = document.createElement("td");
        cell.classList.add("calendar-cell");
        cell.innerHTML = `<div class="day-number">${day}</div>
                          <div class="expense-info"></div>`;
        cell.addEventListener("click", () => showBalanceForDate(day));
        row.appendChild(cell);
      }
      table.appendChild(row);
      calendarGrid.appendChild(table);
      
      updateCalendarExpenses();
      const today = new Date();
      if(today.getMonth() === currentCalendarMonth && today.getFullYear() === currentCalendarYear){
        showBalanceForDate(today.getDate());
      } else {
        showBalanceForDate(1);
      }
    }

    function updateCalendarExpenses() {
      const dayTotals = {};
      db.ref("despesas").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const despesa = child.val();
          // Despesas à vista
          if(despesa.formaPagamento === "avista" && despesa.dataCompra){
            const d = new Date(despesa.dataCompra).getDate();
            dayTotals[d] = (dayTotals[d] || 0) + (parseFloat(despesa.valor) || 0);
          }
          // Despesas de cartão
          if(despesa.formaPagamento === "cartao" && despesa.parcelas){
            despesa.parcelas.forEach(parcela => {
              const d = new Date(parcela.vencimento).getDate();
              dayTotals[d] = (dayTotals[d] || 0) + parseFloat(parcela.valor);
            });
          }
        });
        const cells = document.querySelectorAll(".calendar-cell");
        cells.forEach(cell => {
          const day = parseInt(cell.querySelector(".day-number").innerText);
          const expenseElem = cell.querySelector(".expense-info");
          expenseElem.innerText = dayTotals[day] ? `R$ ${dayTotals[day].toFixed(2)}` : "";
        });
      });
    }

    function showBalanceForDate(day) {
      const selectedDate = new Date(currentCalendarYear, currentCalendarMonth, day);
      db.ref("pessoas").once("value").then(snapshot => {
        let totalIncome = 0;
        snapshot.forEach(child => {
          const pessoa = child.val();
          if(pessoa.pagamentos){
            pessoa.pagamentos.forEach(pag => {
              const pagamentoDia = parseInt(pag.dia);
              if(pagamentoDia <= day){
                totalIncome += parseFloat(pag.valor) || 0;
              }
            });
          }
        });
        db.ref("despesas").once("value").then(snapshot2 => {
          let totalExpenses = 0;
          snapshot2.forEach(child => {
            const despesa = child.val();
            // Despesas à vista
            if(despesa.formaPagamento === "avista" && despesa.dataCompra){
              const d = new Date(despesa.dataCompra);
              if(d.getDate() <= day && d.getMonth() === currentCalendarMonth && d.getFullYear() === currentCalendarYear){
                totalExpenses += parseFloat(despesa.valor) || 0;
              }
            }
            // Parcelas de cartão
            if(despesa.formaPagamento === "cartao" && despesa.parcelas){
              despesa.parcelas.forEach(parcela => {
                const d = new Date(parcela.vencimento);
                if(d.getDate() <= day && d.getMonth() === currentCalendarMonth && d.getFullYear() === currentCalendarYear){
                  totalExpenses += parseFloat(parcela.valor);
                }
              });
            }
          });
          const availableBalance = totalIncome - totalExpenses;
          document.getElementById("saldoDisponivelContainer").innerText = 
            `Saldo em ${selectedDate.toLocaleDateString()}: R$ ${availableBalance.toFixed(2)}`;
        });
      });
    }

    function prevMonth() {
      currentCalendarMonth--;
      if(currentCalendarMonth < 0){
        currentCalendarMonth = 11;
        currentCalendarYear--;
      }
      renderCalendar();
    }

    function nextMonth() {
      currentCalendarMonth++;
      if(currentCalendarMonth > 11){
        currentCalendarMonth = 0;
        currentCalendarYear++;
      }
      renderCalendar();
    }

    function toggleMonthYearSelect() {
      const selectDiv = document.getElementById("monthYearSelect");
      selectDiv.style.display = (selectDiv.style.display === "none" || selectDiv.style.display === "") ? "block" : "none";
      if(selectDiv.style.display === "block"){
        const selectYear = document.getElementById("selectYear");
        if(selectYear.options.length === 0){
          for(let y = currentCalendarYear - 5; y <= currentCalendarYear + 5; y++){
            const option = document.createElement("option");
            option.value = y;
            option.text = y;
            if(y === currentCalendarYear) option.selected = true;
            selectYear.appendChild(option);
          }
        }
        document.getElementById("selectMonth").value = currentCalendarMonth;
      }
    }

    function updateCalendarFromSelect() {
      const selectMonth = document.getElementById("selectMonth").value;
      const selectYear = document.getElementById("selectYear").value;
      currentCalendarMonth = parseInt(selectMonth);
      currentCalendarYear = parseInt(selectYear);
      toggleMonthYearSelect();
      renderCalendar();
    }

    window.onload = () => {
      document.getElementById("dataCompra").value = new Date().toISOString().split("T")[0];
      updateCategoriaSelect();
      updateCartaoSelect();
      loadDespesasNaoPagasSelect();
      loadCategorias();
      loadCartoes();
      renderCalendar();
    };
  </script>
</body>
</html>
