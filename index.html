<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciamento de Contas</title>
  <style>
    /* Estilos gerais */
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      text-align: center;
      margin-bottom: 20px;
    }
    .container h1 {
      font-size: 2.5rem;
      color: #333;
      margin-bottom: 20px;
    }
    .container button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 15px 20px;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      margin: 5px;
      transition: background 0.3s ease;
    }
    .container button:hover {
      background: #0056b3;
    }
    /* Seções na tela inicial */
    .section {
      width: 100%;
      max-width: 600px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .section h2 {
      margin-top: 0;
      color: #333;
    }
    .section label {
      display: block;
      margin: 10px 0 5px;
      color: #555;
      font-size: 0.9rem;
    }
    .section input,
    .section select,
    .section button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    .section button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .section button:hover {
      background: #0056b3;
    }
    .mensagem {
      text-align: center;
      color: green;
      margin-bottom: 10px;
      display: none;
    }
    /* Calendário Interativo - Modal */
    #calendarHeader {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
    }
    #calendarHeader button {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      margin: 0 10px;
      color: #007bff;
    }
    #calendarMonthYear {
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
    }
    #monthYearSelect {
      display: none;
      margin-bottom: 10px;
    }
    #monthYearSelect select {
      width: 48%;
      padding: 8px;
      margin-right: 4%;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    #monthYearSelect button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #calendarGrid table {
      width: 100%;
      border-collapse: collapse;
    }
    #calendarGrid th, #calendarGrid td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      min-height: 60px;
      vertical-align: top;
    }
    #calendarGrid th {
      background: #007bff;
      color: #fff;
    }
    /* Modais gerais */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: flex-start;
      overflow-y: auto;
      padding: 20px;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-content h2 {
      margin-bottom: 20px;
      color: #333;
      font-size: 1.5rem;
    }
    .modal-content label {
      display: block;
      margin: 10px 0 5px;
      color: #555;
      font-size: 0.9rem;
    }
    .modal-content input,
    .modal-content select,
    .modal-content button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    .modal-content button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .modal-content button:hover {
      background: #0056b3;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #333;
    }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-database-compat.js"></script>
</head>
<body>
  <!-- Menu Principal -->
  <div class="container">
    <h1>Gerenciamento de Contas</h1>
    <button onclick="abrirModal('cadastroModal')">Cadastra Nova Renda</button>
    <button onclick="abrirModal('fonteModal')">Fonte de Renda</button>
    <button onclick="abrirModal('categoriasModal')">Gerenciar Categorias</button>
    <button onclick="abrirModal('cartaoModal')">Gerenciar Cartões</button>
    <button onclick="abrirModal('calendarModal')">Calendário</button>
  </div>

  <!-- Seção de Cadastro de Despesa -->
  <div class="section" id="despesaSection">
    <h2>Cadastrar Despesa</h2>
    <div class="mensagem" id="mensagemSucessoDespesa"></div>
    <form id="despesaForm">
      <label for="despesaDescricao">Descrição:</label>
      <input type="text" id="despesaDescricao" placeholder="Descrição da despesa" required>
      
      <label for="despesaValor">Valor da Despesa (R$):</label>
      <input type="number" id="despesaValor" placeholder="Valor" step="0.01" required>
      
      <label for="dataCompra">Data da Compra:</label>
      <input type="date" id="dataCompra" required>
      
      <label for="categoriaDespesa">Categoria:</label>
      <select id="categoriaDespesa">
        <option value="">Selecione a Categoria</option>
        <!-- Será preenchido via Firebase -->
      </select>
      
      <label>Forma de Pagamento:</label>
      <label><input type="radio" name="formaPagamento" value="avista" checked onclick="toggleDespesaPagamento()"> À vista</label>
      <label><input type="radio" name="formaPagamento" value="cartao" onclick="toggleDespesaPagamento()"> Cartão</label>
      
      <!-- Campos para despesas no cartão -->
      <div id="despesaCartaoFields" style="display: none;">
        <label for="cartaoDespesa">Cartão:</label>
        <select id="cartaoDespesa" required>
          <option value="">Selecione o Cartão</option>
          <!-- Será preenchido via Firebase -->
        </select>
        <label for="numParcelasDespesa">Número de Parcelas:</label>
        <input type="number" id="numParcelasDespesa" min="1" max="12" required>
      </div>
      
      <button type="submit">Salvar Despesa</button>
    </form>
  </div>

  <!-- Seção de Pagar Despesa (com caixa de seleção e campo de pesquisa) -->
  <div class="section" id="pagarDespesaSection">
    <h2>Pagar Despesa</h2>
    <div class="mensagem" id="mensagemSucessoPagamento" style="display:none;"></div>
    <label for="despesaSearch">Pesquisar Despesa:</label>
    <input type="text" id="despesaSearch" placeholder="Digite parte da descrição...">
    <select id="despesaSelect" size="5" style="width:100%;"></select>
    <button onclick="pagarDespesaSelecionada()">Pagar Despesa Selecionada</button>
  </div>

  <!-- Seção de Relatório Mensal -->
  <div class="section" id="relatorioMensalSection">
    <h2>Relatório Mensal de Despesas Pagas</h2>
    <button onclick="loadRelatorioMensal()">Atualizar Relatório</button>
    <div id="relatorioMensalContainer"></div>
  </div>

  <!-- Modal de Calendário -->
  <div id="calendarModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('calendarModal')">&times;</span>
      <h2>Calendário de Despesas</h2>
      <div id="calendarHeader">
        <button onclick="prevMonth()">&#9664;</button>
        <span id="calendarMonthYear" onclick="toggleMonthYearSelect()"></span>
        <button onclick="nextMonth()">&#9654;</button>
      </div>
      <div id="monthYearSelect">
        <select id="selectMonth" onchange="updateCalendarFromSelect()">
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
        <select id="selectYear" onchange="updateCalendarFromSelect()">
          <!-- Será preenchido dinamicamente -->
        </select>
        <button onclick="toggleMonthYearSelect()">Ok</button>
      </div>
      <div id="calendarGrid"></div>
    </div>
  </div>

  <!-- Modal de Cadastro de Renda -->
  <div id="cadastroModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('cadastroModal')">&times;</span>
      <h2>Nova Renda</h2>
      <div class="mensagem" id="mensagemSucessoRenda"></div>
      <form id="cadastroForm">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" placeholder="Nome" required>
        
        <label for="parentesco">Parentesco:</label>
        <select id="parentesco" required>
          <option value="eu">Eu</option>
          <option value="pai">Pai</option>
          <option value="irma">Irmã</option>
          <option value="esposa">Esposa</option>
          <option value="filho">Filho</option>
          <option value="filha">Filha</option>
          <option value="outros">Outros</option>
        </select>
        
        <div class="checkbox-group">
          <label><input type="checkbox" id="cltCheckbox" onclick="toggleClt()"> CLT</label>
          <label><input type="checkbox" id="pjCheckbox"> PJ</label>
        </div>
        
        <div id="cltFields" style="display: none;">
          <label for="salarioBruto">Salário Bruto (R$):</label>
          <input type="number" id="salarioBruto" placeholder="Digite o salário bruto" step="0.01" oninput="atualizarSalarioLiquido()">
          
          <label for="salarioLiquido">Salário Líquido (R$):</label>
          <input type="number" id="salarioLiquido" placeholder="Salário líquido calculado" step="0.01">
          
          <label for="numPagamentos">Número de Pagamentos no Mês:</label>
          <input type="number" id="numPagamentos" placeholder="Digite o número de pagamentos" min="1" max="5" oninput="gerarCamposPagamentos()">
          
          <div id="pagamentosContainer"></div>
          <p id="avisoErro" style="color:red; display:none;">Os valores não somam o salário líquido!</p>
        </div>
        
        <button type="submit">Salvar</button>
      </form>
    </div>
  </div>

  <!-- Modal Fonte de Renda -->
  <div id="fonteModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('fonteModal')">&times;</span>
      <h2>Fonte de Renda</h2>
      <div id="usuariosLista"></div>
    </div>
  </div>

  <!-- Modal Gerenciar Categorias -->
  <div id="categoriasModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('categoriasModal')">&times;</span>
      <h2>Gerenciar Categorias</h2>
      <div class="mensagem" id="mensagemSucessoCategoria"></div>
      <form id="categoriaForm">
        <label for="categoriaNome">Nome da Categoria:</label>
        <input type="text" id="categoriaNome" placeholder="Nome da categoria" required>
        <button type="submit">Salvar</button>
      </form>
      <div id="categoriasLista"></div>
    </div>
  </div>

  <!-- Modal Gerenciar Cartões -->
  <div id="cartaoModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('cartaoModal')">&times;</span>
      <h2>Gerenciar Cartões</h2>
      <div class="mensagem" id="mensagemSucessoCartao"></div>
      <form id="cartaoForm">
        <label for="nomeCartao">Nome do Cartão:</label>
        <input type="text" id="nomeCartao" placeholder="Nome do Cartão" required>
        <label for="diaFatura">Dia da Fatura:</label>
        <input type="number" id="diaFatura" placeholder="Ex.: 20" min="1" max="31" required>
        <label for="diaFechamento">Dia do Fechamento:</label>
        <input type="number" id="diaFechamento" placeholder="Ex.: 11" min="1" max="31" required>
        <label for="limiteCartao">Limite do Cartão (R$):</label>
        <input type="number" id="limiteCartao" placeholder="Limite" step="0.01" required>
        <button type="submit">Salvar Cartão</button>
      </form>
      <div id="cartoesLista"></div>
    </div>
  </div>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAG6LktPXGe6F-vSTHV2Y3n95vSwhpXch8",
      authDomain: "controlegasto-df3f1.firebaseapp.com",
      databaseURL: "https://controlegasto-df3f1-default-rtdb.firebaseio.com",
      projectId: "controlegasto-df3f1",
      storageBucket: "controlegasto-df3f1.firebasestorage.app",
      messagingSenderId: "1034936676414",
      appId: "1:1034936676414:web:61c67ce39c3ab71a07a16f",
      measurementId: "G-PTN43GZHGR"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Variáveis globais para o calendário
    let currentCalendarMonth = new Date().getMonth();
    let currentCalendarYear = new Date().getFullYear();

    // Ao carregar a página, define a data da compra como hoje, atualiza selects de categorias e cartões e carrega despesas não pagas
    window.onload = function() {
      document.getElementById("dataCompra").value = new Date().toISOString().split("T")[0];
      updateCategoriaSelect();
      updateCartaoSelect();
      loadDespesasNaoPagasSelect();
    };

    // Funções para abrir/fechar modais
    function abrirModal(id) {
      document.getElementById(id).style.display = "flex";
      if(id === "fonteModal") loadUsuarios();
      if(id === "categoriasModal") loadCategorias();
      if(id === "cartaoModal") loadCartoes();
      if(id === "calendarModal") renderCalendar();
    }
    function fecharModal(id) {
      document.getElementById(id).style.display = "none";
    }

    // --- MÓDULO RENDA (idem anterior) ---
    function toggleClt() {
      document.getElementById("cltFields").style.display =
        document.getElementById("cltCheckbox").checked ? "block" : "none";
    }
    function atualizarSalarioLiquido() {
      let salarioBruto = parseFloat(document.getElementById("salarioBruto").value) || 0;
      let inss = calcularINSS(salarioBruto);
      let irrf = calcularIRRF(salarioBruto - inss);
      let salarioLiquido = salarioBruto - inss - irrf;
      document.getElementById("salarioLiquido").value = salarioLiquido.toFixed(2);
    }
    function calcularINSS(salario) {
      if(salario <= 1320) return salario * 0.075;
      else if(salario <= 2571.29) return (1320 * 0.075) + ((salario - 1320) * 0.09);
      else if(salario <= 3856.94) return (1320 * 0.075) + (1251.29 * 0.09) + ((salario - 2571.29) * 0.12);
      else if(salario <= 7507.49) return (1320 * 0.075) + (1251.29 * 0.09) + (1285.65 * 0.12) + ((salario - 3856.94) * 0.14);
      return 876.97;
    }
    function calcularIRRF(base) {
      if(base <= 2112) return 0;
      else if(base <= 2826.65) return (base * 0.075) - 158.40;
      else if(base <= 3751.05) return (base * 0.15) - 370.40;
      else if(base <= 4664.68) return (base * 0.225) - 651.73;
      return (base * 0.275) - 884.96;
    }
    function gerarCamposPagamentos() {
      let container = document.getElementById("pagamentosContainer");
      container.innerHTML = "";
      let numPagamentos = parseInt(document.getElementById("numPagamentos").value) || 0;
      let salarioLiquido = parseFloat(document.getElementById("salarioLiquido").value) || 0;
      if(numPagamentos >= 1) {
        for(let i = 1; i <= numPagamentos; i++){
          let div = document.createElement("div");
          div.className = "pagamento-item";
          div.innerHTML = `
            <label>Dia do Pagamento ${numPagamentos > 1 ? i : ""}:</label>
            <input type="number" placeholder="Dia" min="1" max="31" required>
            <label>Valor R$:</label>
            <input type="number" class="valoresPagamento" placeholder="Valor R$" step="0.01" ${numPagamentos === 1 ? `value="${salarioLiquido.toFixed(2)}" readonly` : ""} required>
          `;
          container.appendChild(div);
        }
      }
    }
    function verificarSomaPagamentos() {
      let salarioLiquido = parseFloat(document.getElementById("salarioLiquido").value) || 0;
      let valores = document.querySelectorAll(".valoresPagamento");
      let soma = 0;
      valores.forEach(input => { soma += parseFloat(input.value) || 0; });
      soma = Math.round(soma * 100) / 100;
      salarioLiquido = Math.round(salarioLiquido * 100) / 100;
      document.getElementById("avisoErro").style.display = soma !== salarioLiquido ? "block" : "none";
    }
    document.addEventListener("input", function(event) {
      if(event.target.classList.contains("valoresPagamento")) verificarSomaPagamentos();
    });
    document.getElementById("cadastroForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const nome = document.getElementById("nome").value;
      const parentesco = document.getElementById("parentesco").value;
      const salarioBruto = parseFloat(document.getElementById("salarioBruto").value) || 0;
      const salarioLiquido = parseFloat(document.getElementById("salarioLiquido").value) || 0;
      let pagamentos = [];
      if(document.getElementById("cltCheckbox").checked) {
        const container = document.getElementById("pagamentosContainer");
        const itens = container.getElementsByClassName("pagamento-item");
        for(let item of itens) {
          const dia = item.querySelector("input[type=number]").value;
          const valor = item.querySelector(".valoresPagamento").value;
          pagamentos.push({dia, valor});
        }
      }
      const dados = { nome, parentesco, salarioBruto, salarioLiquido, pagamentos, timestamp: new Date().toISOString() };
      database.ref("pessoas").push(dados)
        .then(() => {
          const msg = document.getElementById("mensagemSucessoRenda");
          msg.innerText = "Dados salvos com sucesso!";
          msg.style.display = "block";
          setTimeout(() => { msg.style.display = "none"; }, 3000);
          document.getElementById("cadastroForm").reset();
          document.getElementById("cltFields").style.display = "none";
          document.getElementById("pagamentosContainer").innerHTML = "";
        })
        .catch((error) => { alert("Erro ao salvar os dados de renda."); });
    });
    function loadUsuarios() {
      const usuariosLista = document.getElementById("usuariosLista");
      usuariosLista.innerHTML = "";
      database.ref("pessoas").once("value", snapshot => {
        snapshot.forEach(childSnapshot => {
          const usuario = childSnapshot.val();
          let div = document.createElement("div");
          div.innerHTML = `
            <strong>Nome:</strong> ${usuario.nome} <br>
            <strong>Parentesco:</strong> ${usuario.parentesco} <br>
            <strong>Salário Bruto:</strong> ${usuario.salarioBruto} <br>
            <strong>Salário Líquido:</strong> ${usuario.salarioLiquido} <br>
          `;
          usuariosLista.appendChild(div);
        });
      });
    }

    // --- MÓDULO DESPESA ---
    function toggleDespesaPagamento() {
      const forma = document.querySelector('input[name="formaPagamento"]:checked').value;
      document.getElementById("despesaCartaoFields").style.display = forma === "cartao" ? "block" : "none";
    }
    function updateCartaoSelect() {
      const select = document.getElementById("cartaoDespesa");
      if(!select) return;
      select.innerHTML = `<option value="">Selecione o Cartão</option>`;
      database.ref("cartoes").once("value", snapshot => {
        snapshot.forEach(child => {
          const cartao = child.val();
          let option = document.createElement("option");
          option.value = child.key;
          option.innerText = cartao.nome;
          option.setAttribute("data-fatura", cartao.diaFatura);
          option.setAttribute("data-fechamento", cartao.diaFechamento);
          select.appendChild(option);
        });
      });
    }
    document.getElementById("despesaForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const descricao = document.getElementById("despesaDescricao").value;
      const valorDespesa = parseFloat(document.getElementById("despesaValor").value) || 0;
      const dataCompra = document.getElementById("dataCompra").value;
      const formaPagamento = document.querySelector('input[name="formaPagamento"]:checked').value;
      const categoria = document.getElementById("categoriaDespesa").value;
      if(formaPagamento === "cartao"){
        const selectCartao = document.getElementById("cartaoDespesa");
        if(!selectCartao.value){
          alert("Selecione um cartão para despesas no cartão.");
          return;
        }
        const numParcelas = document.getElementById("numParcelasDespesa").value;
        // Verificar limite disponível
        database.ref("despesas").orderByChild("cartao/id").equalTo(selectCartao.value).once("value").then(function(snapshot) {
          let used = 0;
          snapshot.forEach(function(child) {
            const desp = child.val();
            if(!desp.pago) {
              used += parseFloat(desp.valorDespesa);
            }
          });
          database.ref("cartoes").child(selectCartao.value).once("value").then(function(cardSnap) {
            const card = cardSnap.val();
            let available = card.limite - used;
            if(valorDespesa > available){
              alert("Limite excedido! Disponível: R$ " + available.toFixed(2));
              return;
            }
            // Registra a despesa com cartão
            const despesa = { 
              descricao, 
              valorDespesa, 
              dataCompra, 
              formaPagamento, 
              categoria, 
              numParcelas, 
              pago: false, 
              cartao: {
                id: selectCartao.value,
                nome: selectCartao.selectedOptions[0].text,
                fatura: parseInt(selectCartao.selectedOptions[0].getAttribute("data-fatura")),
                fechamento: parseInt(selectCartao.selectedOptions[0].getAttribute("data-fechamento"))
              },
              timestamp: new Date().toISOString() 
            };
            database.ref("despesas").push(despesa)
              .then(() => {
                const msg = document.getElementById("mensagemSucessoDespesa");
                msg.innerText = "Despesa salva com sucesso!";
                msg.style.display = "block";
                setTimeout(() => { msg.style.display = "none"; }, 3000);
                document.getElementById("despesaForm").reset();
                document.getElementById("despesaCartaoFields").style.display = "none";
                renderCalendar();
                loadDespesasNaoPagasSelect();
                updateCartaoSelect();
              })
              .catch((error) => { alert("Erro ao salvar a despesa."); });
          });
        });
      } else {
        // Despesa à vista
        const despesa = { descricao, valorDespesa, dataCompra, formaPagamento, categoria, pago: true, timestamp: new Date().toISOString() };
        database.ref("despesas").push(despesa)
          .then(() => {
            const msg = document.getElementById("mensagemSucessoDespesa");
            msg.innerText = "Despesa salva com sucesso!";
            msg.style.display = "block";
            setTimeout(() => { msg.style.display = "none"; }, 3000);
            document.getElementById("despesaForm").reset();
            renderCalendar();
          })
          .catch((error) => { alert("Erro ao salvar a despesa."); });
      }
    });
    
    // --- MÓDULO PAGAR DESPESA: Usar select com pesquisa ---
    function loadDespesasNaoPagasSelect() {
      const select = document.getElementById("despesaSelect");
      select.innerHTML = "";
      database.ref("despesas").orderByChild("pago").equalTo(false).once("value").then(function(snapshot) {
        snapshot.forEach(function(child) {
          const desp = child.val();
          // Cria uma opção com o id como valor e mostra descrição, data e valor
          let option = document.createElement("option");
          option.value = child.key;
          option.text = `${desp.descricao} - ${desp.dataCompra} - R$ ${parseFloat(desp.valorDespesa).toFixed(2)}`;
          select.appendChild(option);
        });
      });
    }
    // Função para filtrar as opções com base na pesquisa
    document.getElementById("despesaSearch").addEventListener("input", function() {
      const search = document.getElementById("despesaSearch").value.toLowerCase();
      const select = document.getElementById("despesaSelect");
      const options = select.options;
      for (let i = 0; i < options.length; i++) {
        const text = options[i].text.toLowerCase();
        options[i].style.display = text.includes(search) ? "block" : "none";
      }
    });
    // Função para pagar a despesa selecionada
    function pagarDespesaSelecionada() {
      const select = document.getElementById("despesaSelect");
      const id = select.value;
      if(!id) {
        alert("Selecione uma despesa para pagar.");
        return;
      }
      database.ref("despesas").child(id).update({ pago: true })
        .then(() => {
          alert("Despesa paga com sucesso!");
          loadDespesasNaoPagasSelect();
          renderCalendar();
          updateCartaoSelect();
        })
        .catch((error) => { alert("Erro ao atualizar a despesa."); });
    }

    // --- MÓDULO RELATÓRIO MENSAL ---
    function loadRelatorioMensal() {
      let monthlyTotals = {};
      database.ref("despesas").orderByChild("pago").equalTo(true).once("value").then(function(snapshot) {
        snapshot.forEach(function(child) {
          const desp = child.val();
          let d = new Date(desp.dataCompra ? desp.dataCompra : desp.timestamp);
          let key = (d.getMonth()+1).toString().padStart(2, "0") + "/" + d.getFullYear();
          if(!monthlyTotals[key]) monthlyTotals[key] = 0;
          monthlyTotals[key] += parseFloat(desp.valorDespesa);
        });
        let container = document.getElementById("relatorioMensalContainer");
        container.innerHTML = "";
        let table = document.createElement("table");
        let headerRow = document.createElement("tr");
        let th1 = document.createElement("th");
        th1.innerText = "Mês/Ano";
        let th2 = document.createElement("th");
        th2.innerText = "Total Pago (R$)";
        headerRow.appendChild(th1);
        headerRow.appendChild(th2);
        table.appendChild(headerRow);
        let keys = Object.keys(monthlyTotals).sort((a, b) => {
          let [mA, yA] = a.split("/").map(Number);
          let [mB, yB] = b.split("/").map(Number);
          return (yA === yB) ? mA - mB : yA - yB;
        });
        keys.forEach(key => {
          let row = document.createElement("tr");
          let td1 = document.createElement("td");
          td1.innerText = key;
          let td2 = document.createElement("td");
          td2.innerText = monthlyTotals[key].toFixed(2);
          row.appendChild(td1);
          row.appendChild(td2);
          table.appendChild(row);
        });
        container.appendChild(table);
      });
    }

    // --- MÓDULO CALENDÁRIO ---
    function loadCalendarExpenses(month, year, callback) {
      let totals = {};
      for(let d = 1; d <= 31; d++){
        totals[d] = 0;
      }
      database.ref("despesas").once("value", snapshot => {
        snapshot.forEach(child => {
          const despesa = child.val();
          if(despesa.formaPagamento === "cartao" && despesa.cartao) {
            let purchaseDate = new Date(despesa.dataCompra);
            let purchaseDay = purchaseDate.getDate();
            let fechamento = despesa.cartao.fechamento;
            let fatura = despesa.cartao.fatura;
            let offset = (purchaseDay > fechamento) ? 1 : 0;
            let firstDueMonth = purchaseDate.getMonth() + offset;
            let firstDueYear = purchaseDate.getFullYear();
            if(firstDueMonth >= 12) { firstDueMonth -= 12; firstDueYear++; }
            let diffMonths = (year - firstDueYear) * 12 + (month - firstDueMonth);
            let numParcelas = parseInt(despesa.numParcelas);
            if(diffMonths >= 0 && diffMonths < numParcelas) {
              let installment = parseFloat(despesa.valorDespesa) / numParcelas;
              totals[fatura] += installment;
            }
          } else if(despesa.formaPagamento === "avista") {
            let purchaseDate = new Date(despesa.dataCompra);
            if(purchaseDate.getFullYear() === year && purchaseDate.getMonth() === month) {
              let day = purchaseDate.getDate();
              totals[day] += parseFloat(despesa.valorDespesa);
            }
          }
        });
        callback(totals);
      });
    }
    function renderCalendar() {
      document.getElementById("calendarMonthYear").innerText = getMonthName(currentCalendarMonth) + " " + currentCalendarYear;
      populateMonthYearSelect();
      loadCalendarExpenses(currentCalendarMonth, currentCalendarYear, function(totals) {
        let firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
        let daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
        let table = document.createElement("table");
        let headerRow = document.createElement("tr");
        const diasSemana = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
        diasSemana.forEach(function(dia) {
          let th = document.createElement("th");
          th.innerText = dia;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        let row = document.createElement("tr");
        for (let i = 0; i < firstDay; i++) {
          let cell = document.createElement("td");
          cell.innerText = "";
          row.appendChild(cell);
        }
        for (let d = 1; d <= daysInMonth; d++) {
          let cell = document.createElement("td");
          cell.innerHTML = "<strong>" + d + "</strong><br>";
          if(totals[d] && totals[d] > 0) {
            cell.innerHTML += "R$ " + totals[d].toFixed(2);
          }
          row.appendChild(cell);
          if ((firstDay + d) % 7 === 0) {
            table.appendChild(row);
            row = document.createElement("tr");
          }
        }
        if(row.children.length > 0) {
          while(row.children.length < 7) {
            let cell = document.createElement("td");
            cell.innerText = "";
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
        let calendarGrid = document.getElementById("calendarGrid");
        calendarGrid.innerHTML = "";
        calendarGrid.appendChild(table);
      });
    }
    function getMonthName(monthIndex) {
      const nomes = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                      "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
      return nomes[monthIndex];
    }
    function prevMonth() {
      currentCalendarMonth--;
      if(currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
      }
      renderCalendar();
    }
    function nextMonth() {
      currentCalendarMonth++;
      if(currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
      }
      renderCalendar();
    }
    function populateMonthYearSelect() {
      let selectYear = document.getElementById("selectYear");
      selectYear.innerHTML = "";
      let currentYear = new Date().getFullYear();
      for(let y = currentYear - 10; y <= currentYear + 10; y++){
        let option = document.createElement("option");
        option.value = y;
        option.innerText = y;
        if(y === currentCalendarYear) option.selected = true;
        selectYear.appendChild(option);
      }
      let selectMonth = document.getElementById("selectMonth");
      selectMonth.value = currentCalendarMonth;
    }
    function toggleMonthYearSelect() {
      let container = document.getElementById("monthYearSelect");
      container.style.display = container.style.display === "none" ? "block" : "none";
    }
    function updateCalendarFromSelect() {
      let selectMonth = document.getElementById("selectMonth");
      let selectYear = document.getElementById("selectYear");
      currentCalendarMonth = parseInt(selectMonth.value);
      currentCalendarYear = parseInt(selectYear.value);
      renderCalendar();
    }

    // --- MÓDULO RELATÓRIO MENSAL ---
    function loadRelatorioMensal() {
      let monthlyTotals = {};
      database.ref("despesas").orderByChild("pago").equalTo(true).once("value").then(function(snapshot) {
        snapshot.forEach(function(child) {
          const desp = child.val();
          let d = new Date(desp.dataCompra ? desp.dataCompra : desp.timestamp);
          let key = (d.getMonth()+1).toString().padStart(2, "0") + "/" + d.getFullYear();
          if(!monthlyTotals[key]) monthlyTotals[key] = 0;
          monthlyTotals[key] += parseFloat(desp.valorDespesa);
        });
        let container = document.getElementById("relatorioMensalContainer");
        container.innerHTML = "";
        let table = document.createElement("table");
        let headerRow = document.createElement("tr");
        let th1 = document.createElement("th");
        th1.innerText = "Mês/Ano";
        let th2 = document.createElement("th");
        th2.innerText = "Total Pago (R$)";
        headerRow.appendChild(th1);
        headerRow.appendChild(th2);
        table.appendChild(headerRow);
        let keys = Object.keys(monthlyTotals).sort((a, b) => {
          let [mA, yA] = a.split("/").map(Number);
          let [mB, yB] = b.split("/").map(Number);
          return (yA === yB) ? mA - mB : yA - yB;
        });
        keys.forEach(key => {
          let row = document.createElement("tr");
          let td1 = document.createElement("td");
          td1.innerText = key;
          let td2 = document.createElement("td");
          td2.innerText = monthlyTotals[key].toFixed(2);
          row.appendChild(td1);
          row.appendChild(td2);
          table.appendChild(row);
        });
        container.appendChild(table);
      });
    }

    // --- MÓDULO PAGAR DESPESA COM CAIXA DE SELEÇÃO E PESQUISA ---
    function loadDespesasNaoPagasSelect() {
      const select = document.getElementById("despesaSelect");
      select.innerHTML = "";
      database.ref("despesas").orderByChild("pago").equalTo(false).once("value").then(function(snapshot) {
        snapshot.forEach(function(child) {
          const desp = child.val();
          let option = document.createElement("option");
          option.value = child.key;
          option.text = `${desp.descricao} - ${desp.dataCompra} - R$ ${parseFloat(desp.valorDespesa).toFixed(2)}`;
          select.appendChild(option);
        });
      });
    }
    // Filtro: conforme o usuário digita, filtra as opções da caixa de seleção
    document.getElementById("despesaSearch").addEventListener("input", function() {
      const search = document.getElementById("despesaSearch").value.toLowerCase();
      const select = document.getElementById("despesaSelect");
      const options = select.options;
      for (let i = 0; i < options.length; i++) {
        const text = options[i].text.toLowerCase();
        options[i].style.display = text.includes(search) ? "block" : "none";
      }
    });
    function pagarDespesaSelecionada() {
      const select = document.getElementById("despesaSelect");
      const id = select.value;
      if(!id) {
        alert("Selecione uma despesa para pagar.");
        return;
      }
      database.ref("despesas").child(id).update({ pago: true })
        .then(() => {
          alert("Despesa paga com sucesso!");
          loadDespesasNaoPagasSelect();
          renderCalendar();
          updateCartaoSelect();
        })
        .catch((error) => { alert("Erro ao atualizar a despesa."); });
    }

    // --- MÓDULO CARTÕES ---
    document.getElementById("cartaoForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const nomeCartao = document.getElementById("nomeCartao").value;
      const diaFatura = parseInt(document.getElementById("diaFatura").value);
      const diaFechamento = parseInt(document.getElementById("diaFechamento").value);
      const limiteCartao = parseFloat(document.getElementById("limiteCartao").value) || 0;
      const cartao = { nome: nomeCartao, diaFatura, diaFechamento, limite: limiteCartao };
      database.ref("cartoes").push(cartao)
        .then(() => {
          const msg = document.getElementById("mensagemSucessoCartao");
          msg.innerText = "Cartão salvo com sucesso!";
          msg.style.display = "block";
          setTimeout(() => { msg.style.display = "none"; }, 3000);
          document.getElementById("cartaoForm").reset();
          loadCartoes();
          updateCartaoSelect();
        })
        .catch((error) => { alert("Erro ao salvar o cartão."); });
    });
    function loadCartoes() {
      const cartoesLista = document.getElementById("cartoesLista");
      cartoesLista.innerHTML = "";
      database.ref("cartoes").once("value", snapshot => {
        snapshot.forEach(child => {
          const cartao = child.val();
          const key = child.key;
          database.ref("despesas").orderByChild("cartao/id").equalTo(key).once("value").then(function(snap) {
            let used = 0;
            snap.forEach(function(child2) {
              const desp = child2.val();
              if(!desp.pago) {
                used += parseFloat(desp.valorDespesa);
              }
            });
            let available = cartao.limite - used;
            let cartDiv = document.createElement("div");
            cartDiv.innerHTML = `<strong>${cartao.nome}</strong> (Fatura: ${cartao.diaFatura}, Fechamento: ${cartao.diaFechamento}, Limite: R$ ${cartao.limite.toFixed(2)}, Disponível: R$ ${available.toFixed(2)}) <button onclick="excluirCartao('${key}')">Excluir</button>`;
            cartoesLista.appendChild(cartDiv);
          });
        });
      });
    }
    function excluirCartao(key) {
      if(confirm("Deseja realmente excluir este cartão?")){
        database.ref("cartoes/" + key).remove()
          .then(() => { alert("Cartão excluído com sucesso!"); loadCartoes(); updateCartaoSelect(); })
          .catch((error) => { alert("Erro ao excluir o cartão."); });
      }
    }
    function updateCartaoSelect() {
      const select = document.getElementById("cartaoDespesa");
      if(!select) return;
      select.innerHTML = `<option value="">Selecione o Cartão</option>`;
      database.ref("cartoes").once("value", snapshot => {
        snapshot.forEach(child => {
          const cartao = child.val();
          let option = document.createElement("option");
          option.value = child.key;
          option.innerText = cartao.nome;
          option.setAttribute("data-fatura", cartao.diaFatura);
          option.setAttribute("data-fechamento", cartao.diaFechamento);
          select.appendChild(option);
        });
      });
    }

    // --- MÓDULO CATEGORIAS ---
    document.getElementById("categoriaForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const nomeCategoria = document.getElementById("categoriaNome").value;
      if(!nomeCategoria) return;
      database.ref("categorias").push({ nome: nomeCategoria })
        .then(() => {
          const msg = document.getElementById("mensagemSucessoCategoria");
          msg.innerText = "Categoria salva com sucesso!";
          msg.style.display = "block";
          setTimeout(() => { msg.style.display = "none"; }, 3000);
          document.getElementById("categoriaForm").reset();
          loadCategorias();
          updateCategoriaSelect();
        })
        .catch((error) => { alert("Erro ao salvar a categoria."); });
    });
    function loadCategorias() {
      const categoriasLista = document.getElementById("categoriasLista");
      categoriasLista.innerHTML = "";
      database.ref("categorias").once("value", snapshot => {
        snapshot.forEach(child => {
          const categoria = child.val();
          const key = child.key;
          let catDiv = document.createElement("div");
          catDiv.innerHTML = `<strong>${categoria.nome}</strong> <button onclick="excluirCategoria('${key}')">Excluir</button>`;
          categoriasLista.appendChild(catDiv);
        });
      });
    }
    function excluirCategoria(key) {
      if(confirm("Deseja realmente excluir esta categoria?")){
        database.ref("categorias/" + key).remove()
          .then(() => { alert("Categoria excluída com sucesso!"); loadCategorias(); updateCategoriaSelect(); })
          .catch((error) => { alert("Erro ao excluir a categoria."); });
      }
    }
    function updateCategoriaSelect() {
      const select = document.getElementById("categoriaDespesa");
      if(!select) return;
      select.innerHTML = `<option value="">Selecione a Categoria</option>`;
      database.ref("categorias").once("value", snapshot => {
        snapshot.forEach(child => {
          const cat = child.val();
          select.innerHTML += `<option value="${cat.nome}">${cat.nome}</option>`;
        });
      });
    }
    
    // --- Atualização do Formulário de Despesa ---
    if(!document.getElementById("dataCompra")){
      let form = document.getElementById("despesaForm");
      let label = document.createElement("label");
      label.setAttribute("for", "dataCompra");
      label.innerText = "Data da Compra:";
      let input = document.createElement("input");
      input.type = "date";
      input.id = "dataCompra";
      input.required = true;
      form.insertBefore(label, form.children[4]);
      form.insertBefore(input, form.children[5]);
      input.value = new Date().toISOString().split("T")[0];
    }
    
    // --- MÓDULO PAGAR DESPESA COM CAIXA DE SELEÇÃO E PESQUISA ---
    function loadDespesasNaoPagasSelect() {
      const select = document.getElementById("despesaSelect");
      select.innerHTML = "";
      database.ref("despesas").orderByChild("pago").equalTo(false).once("value").then(function(snapshot) {
        snapshot.forEach(function(child) {
          const desp = child.val();
          let option = document.createElement("option");
          option.value = child.key;
          option.text = `${desp.descricao} - ${desp.dataCompra} - R$ ${parseFloat(desp.valorDespesa).toFixed(2)}`;
          select.appendChild(option);
        });
      });
    }
    // Filtra as opções conforme o usuário digita
    document.getElementById("despesaSearch").addEventListener("input", function() {
      const search = document.getElementById("despesaSearch").value.toLowerCase();
      const select = document.getElementById("despesaSelect");
      const options = select.options;
      for (let i = 0; i < options.length; i++) {
        const text = options[i].text.toLowerCase();
        options[i].style.display = text.includes(search) ? "block" : "none";
      }
    });
    function pagarDespesaSelecionada() {
      const select = document.getElementById("despesaSelect");
      const id = select.value;
      if(!id) {
        alert("Selecione uma despesa para pagar.");
        return;
      }
      database.ref("despesas").child(id).update({ pago: true })
        .then(() => {
          alert("Despesa paga com sucesso!");
          loadDespesasNaoPagasSelect();
          renderCalendar();
          updateCartaoSelect();
        })
        .catch((error) => { alert("Erro ao atualizar a despesa."); });
    }

    // --- MÓDULO RELATÓRIO MENSAL ---
    function loadRelatorioMensal() {
      let monthlyTotals = {};
      database.ref("despesas").orderByChild("pago").equalTo(true).once("value").then(function(snapshot) {
        snapshot.forEach(function(child) {
          const desp = child.val();
          let d = new Date(desp.dataCompra ? desp.dataCompra : desp.timestamp);
          let key = (d.getMonth()+1).toString().padStart(2, "0") + "/" + d.getFullYear();
          if(!monthlyTotals[key]) monthlyTotals[key] = 0;
          monthlyTotals[key] += parseFloat(desp.valorDespesa);
        });
        let container = document.getElementById("relatorioMensalContainer");
        container.innerHTML = "";
        let table = document.createElement("table");
        let headerRow = document.createElement("tr");
        let th1 = document.createElement("th");
        th1.innerText = "Mês/Ano";
        let th2 = document.createElement("th");
        th2.innerText = "Total Pago (R$)";
        headerRow.appendChild(th1);
        headerRow.appendChild(th2);
        table.appendChild(headerRow);
        let keys = Object.keys(monthlyTotals).sort((a, b) => {
          let [mA, yA] = a.split("/").map(Number);
          let [mB, yB] = b.split("/").map(Number);
          return (yA === yB) ? mA - mB : yA - yB;
        });
        keys.forEach(key => {
          let row = document.createElement("tr");
          let td1 = document.createElement("td");
          td1.innerText = key;
          let td2 = document.createElement("td");
          td2.innerText = monthlyTotals[key].toFixed(2);
          row.appendChild(td1);
          row.appendChild(td2);
          table.appendChild(row);
        });
        container.appendChild(table);
      });
    }

    // --- MÓDULO CALENDÁRIO ---
    function loadCalendarExpenses(month, year, callback) {
      let totals = {};
      for(let d = 1; d <= 31; d++){
        totals[d] = 0;
      }
      database.ref("despesas").once("value", snapshot => {
        snapshot.forEach(child => {
          const despesa = child.val();
          if(despesa.formaPagamento === "cartao" && despesa.cartao) {
            let purchaseDate = new Date(despesa.dataCompra);
            let purchaseDay = purchaseDate.getDate();
            let fechamento = despesa.cartao.fechamento;
            let fatura = despesa.cartao.fatura;
            let offset = (purchaseDay > fechamento) ? 1 : 0;
            let firstDueMonth = purchaseDate.getMonth() + offset;
            let firstDueYear = purchaseDate.getFullYear();
            if(firstDueMonth >= 12) { firstDueMonth -= 12; firstDueYear++; }
            let diffMonths = (year - firstDueYear) * 12 + (month - firstDueMonth);
            let numParcelas = parseInt(despesa.numParcelas);
            if(diffMonths >= 0 && diffMonths < numParcelas) {
              let installment = parseFloat(despesa.valorDespesa) / numParcelas;
              totals[fatura] += installment;
            }
          } else if(despesa.formaPagamento === "avista") {
            let purchaseDate = new Date(despesa.dataCompra);
            if(purchaseDate.getFullYear() === year && purchaseDate.getMonth() === month) {
              let day = purchaseDate.getDate();
              totals[day] += parseFloat(despesa.valorDespesa);
            }
          }
        });
        callback(totals);
      });
    }
    function renderCalendar() {
      document.getElementById("calendarMonthYear").innerText = getMonthName(currentCalendarMonth) + " " + currentCalendarYear;
      populateMonthYearSelect();
      loadCalendarExpenses(currentCalendarMonth, currentCalendarYear, function(totals) {
        let firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
        let daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
        let table = document.createElement("table");
        let headerRow = document.createElement("tr");
        const diasSemana = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
        diasSemana.forEach(function(dia) {
          let th = document.createElement("th");
          th.innerText = dia;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        let row = document.createElement("tr");
        for (let i = 0; i < firstDay; i++) {
          let cell = document.createElement("td");
          cell.innerText = "";
          row.appendChild(cell);
        }
        for (let d = 1; d <= daysInMonth; d++) {
          let cell = document.createElement("td");
          cell.innerHTML = "<strong>" + d + "</strong><br>";
          if(totals[d] && totals[d] > 0) {
            cell.innerHTML += "R$ " + totals[d].toFixed(2);
          }
          row.appendChild(cell);
          if ((firstDay + d) % 7 === 0) {
            table.appendChild(row);
            row = document.createElement("tr");
          }
        }
        if(row.children.length > 0) {
          while(row.children.length < 7) {
            let cell = document.createElement("td");
            cell.innerText = "";
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
        let calendarGrid = document.getElementById("calendarGrid");
        calendarGrid.innerHTML = "";
        calendarGrid.appendChild(table);
      });
    }
    function getMonthName(monthIndex) {
      const nomes = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                      "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
      return nomes[monthIndex];
    }
    function prevMonth() {
      currentCalendarMonth--;
      if(currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
      }
      renderCalendar();
    }
    function nextMonth() {
      currentCalendarMonth++;
      if(currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
      }
      renderCalendar();
    }
    function populateMonthYearSelect() {
      let selectYear = document.getElementById("selectYear");
      selectYear.innerHTML = "";
      let currentYear = new Date().getFullYear();
      for(let y = currentYear - 10; y <= currentYear + 10; y++){
        let option = document.createElement("option");
        option.value = y;
        option.innerText = y;
        if(y === currentCalendarYear) option.selected = true;
        selectYear.appendChild(option);
      }
      let selectMonth = document.getElementById("selectMonth");
      selectMonth.value = currentCalendarMonth;
    }
    function toggleMonthYearSelect() {
      let container = document.getElementById("monthYearSelect");
      container.style.display = container.style.display === "none" ? "block" : "none";
    }
    function updateCalendarFromSelect() {
      let selectMonth = document.getElementById("selectMonth");
      let selectYear = document.getElementById("selectYear");
      currentCalendarMonth = parseInt(selectMonth.value);
      currentCalendarYear = parseInt(selectYear.value);
      renderCalendar();
    }

    // --- MÓDULO RELATÓRIO MENSAL ---
    function loadRelatorioMensal() {
      let monthlyTotals = {};
      database.ref("despesas").orderByChild("pago").equalTo(true).once("value").then(function(snapshot) {
        snapshot.forEach(function(child) {
          const desp = child.val();
          let d = new Date(desp.dataCompra ? desp.dataCompra : desp.timestamp);
          let key = (d.getMonth()+1).toString().padStart(2, "0") + "/" + d.getFullYear();
          if(!monthlyTotals[key]) monthlyTotals[key] = 0;
          monthlyTotals[key] += parseFloat(desp.valorDespesa);
        });
        let container = document.getElementById("relatorioMensalContainer");
        container.innerHTML = "";
        let table = document.createElement("table");
        let headerRow = document.createElement("tr");
        let th1 = document.createElement("th");
        th1.innerText = "Mês/Ano";
        let th2 = document.createElement("th");
        th2.innerText = "Total Pago (R$)";
        headerRow.appendChild(th1);
        headerRow.appendChild(th2);
        table.appendChild(headerRow);
        let keys = Object.keys(monthlyTotals).sort((a, b) => {
          let [mA, yA] = a.split("/").map(Number);
          let [mB, yB] = b.split("/").map(Number);
          return (yA === yB) ? mA - mB : yA - yB;
        });
        keys.forEach(key => {
          let row = document.createElement("tr");
          let td1 = document.createElement("td");
          td1.innerText = key;
          let td2 = document.createElement("td");
          td2.innerText = monthlyTotals[key].toFixed(2);
          row.appendChild(td1);
          row.appendChild(td2);
          table.appendChild(row);
        });
        container.appendChild(table);
      });
    }

    // --- MÓDULO CARTÕES ---
    document.getElementById("cartaoForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const nomeCartao = document.getElementById("nomeCartao").value;
      const diaFatura = parseInt(document.getElementById("diaFatura").value);
      const diaFechamento = parseInt(document.getElementById("diaFechamento").value);
      const limiteCartao = parseFloat(document.getElementById("limiteCartao").value) || 0;
      const cartao = { nome: nomeCartao, diaFatura, diaFechamento, limite: limiteCartao };
      database.ref("cartoes").push(cartao)
        .then(() => {
          const msg = document.getElementById("mensagemSucessoCartao");
          msg.innerText = "Cartão salvo com sucesso!";
          msg.style.display = "block";
          setTimeout(() => { msg.style.display = "none"; }, 3000);
          document.getElementById("cartaoForm").reset();
          loadCartoes();
          updateCartaoSelect();
        })
        .catch((error) => { alert("Erro ao salvar o cartão."); });
    });
    function loadCartoes() {
      const cartoesLista = document.getElementById("cartoesLista");
      cartoesLista.innerHTML = "";
      database.ref("cartoes").once("value", snapshot => {
        snapshot.forEach(child => {
          const cartao = child.val();
          const key = child.key;
          database.ref("despesas").orderByChild("cartao/id").equalTo(key).once("value").then(function(snap) {
            let used = 0;
            snap.forEach(function(child2) {
              const desp = child2.val();
              if(!desp.pago) {
                used += parseFloat(desp.valorDespesa);
              }
            });
            let available = cartao.limite - used;
            let cartDiv = document.createElement("div");
            cartDiv.innerHTML = `<strong>${cartao.nome}</strong> (Fatura: ${cartao.diaFatura}, Fechamento: ${cartao.diaFechamento}, Limite: R$ ${cartao.limite.toFixed(2)}, Disponível: R$ ${available.toFixed(2)}) <button onclick="excluirCartao('${key}')">Excluir</button>`;
            cartoesLista.appendChild(cartDiv);
          });
        });
      });
    }
    function excluirCartao(key) {
      if(confirm("Deseja realmente excluir este cartão?")){
        database.ref("cartoes/" + key).remove()
          .then(() => { alert("Cartão excluído com sucesso!"); loadCartoes(); updateCartaoSelect(); })
          .catch((error) => { alert("Erro ao excluir o cartão."); });
      }
    }
    function updateCartaoSelect() {
      const select = document.getElementById("cartaoDespesa");
      if(!select) return;
      select.innerHTML = `<option value="">Selecione o Cartão</option>`;
      database.ref("cartoes").once("value", snapshot => {
        snapshot.forEach(child => {
          const cartao = child.val();
          let option = document.createElement("option");
          option.value = child.key;
          option.innerText = cartao.nome;
          option.setAttribute("data-fatura", cartao.diaFatura);
          option.setAttribute("data-fechamento", cartao.diaFechamento);
          select.appendChild(option);
        });
      });
    }

    // --- MÓDULO CATEGORIAS ---
    document.getElementById("categoriaForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const nomeCategoria = document.getElementById("categoriaNome").value;
      if(!nomeCategoria) return;
      database.ref("categorias").push({ nome: nomeCategoria })
        .then(() => {
          const msg = document.getElementById("mensagemSucessoCategoria");
          msg.innerText = "Categoria salva com sucesso!";
          msg.style.display = "block";
          setTimeout(() => { msg.style.display = "none"; }, 3000);
          document.getElementById("categoriaForm").reset();
          loadCategorias();
          updateCategoriaSelect();
        })
        .catch((error) => { alert("Erro ao salvar a categoria."); });
    });
    function loadCategorias() {
      const categoriasLista = document.getElementById("categoriasLista");
      categoriasLista.innerHTML = "";
      database.ref("categorias").once("value", snapshot => {
        snapshot.forEach(child => {
          const categoria = child.val();
          const key = child.key;
          let catDiv = document.createElement("div");
          catDiv.innerHTML = `<strong>${categoria.nome}</strong> <button onclick="excluirCategoria('${key}')">Excluir</button>`;
          categoriasLista.appendChild(catDiv);
        });
      });
    }
    function excluirCategoria(key) {
      if(confirm("Deseja realmente excluir esta categoria?")){
        database.ref("categorias/" + key).remove()
          .then(() => { alert("Categoria excluída com sucesso!"); loadCategorias(); updateCategoriaSelect(); })
          .catch((error) => { alert("Erro ao excluir a categoria."); });
      }
    }
    function updateCategoriaSelect() {
      const select = document.getElementById("categoriaDespesa");
      if(!select) return;
      select.innerHTML = `<option value="">Selecione a Categoria</option>`;
      database.ref("categorias").once("value", snapshot => {
        snapshot.forEach(child => {
          const cat = child.val();
          select.innerHTML += `<option value="${cat.nome}">${cat.nome}</option>`;
        });
      });
    }
    
    // --- Atualização do Formulário de Despesa ---
    if(!document.getElementById("dataCompra")){
      let form = document.getElementById("despesaForm");
      let label = document.createElement("label");
      label.setAttribute("for", "dataCompra");
      label.innerText = "Data da Compra:";
      let input = document.createElement("input");
      input.type = "date";
      input.id = "dataCompra";
      input.required = true;
      form.insertBefore(label, form.children[4]);
      form.insertBefore(input, form.children[5]);
      input.value = new Date().toISOString().split("T")[0];
    }
    
    // --- MÓDULO PAGAR DESPESA (CAIXA DE SELEÇÃO COM PESQUISA) ---
    // Cria a caixa de seleção e o campo de pesquisa (já estão na seção "Pagar Despesa" do HTML)
    function loadDespesasNaoPagasSelect() {
      const select = document.getElementById("despesaSelect");
      select.innerHTML = "";
      database.ref("despesas").orderByChild("pago").equalTo(false).once("value").then(function(snapshot) {
        snapshot.forEach(function(child) {
          const desp = child.val();
          let option = document.createElement("option");
          option.value = child.key;
          option.text = `${desp.descricao} - ${desp.dataCompra} - R$ ${parseFloat(desp.valorDespesa).toFixed(2)}`;
          select.appendChild(option);
        });
      });
    }
    // Função para pagar a despesa selecionada
    function pagarDespesaSelecionada() {
      const select = document.getElementById("despesaSelect");
      const id = select.value;
      if(!id) {
        alert("Selecione uma despesa para pagar.");
        return;
      }
      database.ref("despesas").child(id).update({ pago: true })
        .then(() => {
          alert("Despesa paga com sucesso!");
          loadDespesasNaoPagasSelect();
          renderCalendar();
          updateCartaoSelect();
        })
        .catch((error) => { alert("Erro ao atualizar a despesa."); });
    }
    
    // --- MÓDULO RELATÓRIO MENSAL ---
    function loadRelatorioMensal() {
      let monthlyTotals = {};
      database.ref("despesas").orderByChild("pago").equalTo(true).once("value").then(function(snapshot) {
        snapshot.forEach(function(child) {
          const desp = child.val();
          let d = new Date(desp.dataCompra ? desp.dataCompra : desp.timestamp);
          let key = (d.getMonth()+1).toString().padStart(2, "0") + "/" + d.getFullYear();
          if(!monthlyTotals[key]) monthlyTotals[key] = 0;
          monthlyTotals[key] += parseFloat(desp.valorDespesa);
        });
        let container = document.getElementById("relatorioMensalContainer");
        container.innerHTML = "";
        let table = document.createElement("table");
        let headerRow = document.createElement("tr");
        let th1 = document.createElement("th");
        th1.innerText = "Mês/Ano";
        let th2 = document.createElement("th");
        th2.innerText = "Total Pago (R$)";
        headerRow.appendChild(th1);
        headerRow.appendChild(th2);
        table.appendChild(headerRow);
        let keys = Object.keys(monthlyTotals).sort((a, b) => {
          let [mA, yA] = a.split("/").map(Number);
          let [mB, yB] = b.split("/").map(Number);
          return (yA === yB) ? mA - mB : yA - yB;
        });
        keys.forEach(key => {
          let row = document.createElement("tr");
          let td1 = document.createElement("td");
          td1.innerText = key;
          let td2 = document.createElement("td");
          td2.innerText = monthlyTotals[key].toFixed(2);
          row.appendChild(td1);
          row.appendChild(td2);
          table.appendChild(row);
        });
        container.appendChild(table);
      });
    }

    // --- MÓDULO CALENDÁRIO ---
    function loadCalendarExpenses(month, year, callback) {
      let totals = {};
      for(let d = 1; d <= 31; d++){
        totals[d] = 0;
      }
      database.ref("despesas").once("value", snapshot => {
        snapshot.forEach(child => {
          const despesa = child.val();
          if(despesa.formaPagamento === "cartao" && despesa.cartao) {
            let purchaseDate = new Date(despesa.dataCompra);
            let purchaseDay = purchaseDate.getDate();
            let fechamento = despesa.cartao.fechamento;
            let fatura = despesa.cartao.fatura;
            let offset = (purchaseDay > fechamento) ? 1 : 0;
            let firstDueMonth = purchaseDate.getMonth() + offset;
            let firstDueYear = purchaseDate.getFullYear();
            if(firstDueMonth >= 12) { firstDueMonth -= 12; firstDueYear++; }
            let diffMonths = (year - firstDueYear) * 12 + (month - firstDueMonth);
            let numParcelas = parseInt(despesa.numParcelas);
            if(diffMonths >= 0 && diffMonths < numParcelas) {
              let installment = parseFloat(despesa.valorDespesa) / numParcelas;
              totals[fatura] += installment;
            }
          } else if(despesa.formaPagamento === "avista") {
            let purchaseDate = new Date(despesa.dataCompra);
            if(purchaseDate.getFullYear() === year && purchaseDate.getMonth() === month) {
              let day = purchaseDate.getDate();
              totals[day] += parseFloat(despesa.valorDespesa);
            }
          }
        });
        callback(totals);
      });
    }
    function renderCalendar() {
      document.getElementById("calendarMonthYear").innerText = getMonthName(currentCalendarMonth) + " " + currentCalendarYear;
      populateMonthYearSelect();
      loadCalendarExpenses(currentCalendarMonth, currentCalendarYear, function(totals) {
        let firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
        let daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
        let table = document.createElement("table");
        let headerRow = document.createElement("tr");
        const diasSemana = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
        diasSemana.forEach(function(dia) {
          let th = document.createElement("th");
          th.innerText = dia;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        let row = document.createElement("tr");
        for (let i = 0; i < firstDay; i++) {
          let cell = document.createElement("td");
          cell.innerText = "";
          row.appendChild(cell);
        }
        for (let d = 1; d <= daysInMonth; d++) {
          let cell = document.createElement("td");
          cell.innerHTML = "<strong>" + d + "</strong><br>";
          if(totals[d] && totals[d] > 0) {
            cell.innerHTML += "R$ " + totals[d].toFixed(2);
          }
          row.appendChild(cell);
          if ((firstDay + d) % 7 === 0) {
            table.appendChild(row);
            row = document.createElement("tr");
          }
        }
        if(row.children.length > 0) {
          while(row.children.length < 7) {
            let cell = document.createElement("td");
            cell.innerText = "";
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
        let calendarGrid = document.getElementById("calendarGrid");
        calendarGrid.innerHTML = "";
        calendarGrid.appendChild(table);
      });
    }
    function getMonthName(monthIndex) {
      const nomes = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                      "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
      return nomes[monthIndex];
    }
    function prevMonth() {
      currentCalendarMonth--;
      if(currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
      }
      renderCalendar();
    }
    function nextMonth() {
      currentCalendarMonth++;
      if(currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
      }
      renderCalendar();
    }
    function populateMonthYearSelect() {
      let selectYear = document.getElementById("selectYear");
      selectYear.innerHTML = "";
      let currentYear = new Date().getFullYear();
      for(let y = currentYear - 10; y <= currentYear + 10; y++){
        let option = document.createElement("option");
        option.value = y;
        option.innerText = y;
        if(y === currentCalendarYear) option.selected = true;
        selectYear.appendChild(option);
      }
      let selectMonth = document.getElementById("selectMonth");
      selectMonth.value = currentCalendarMonth;
    }
    function toggleMonthYearSelect() {
      let container = document.getElementById("monthYearSelect");
      container.style.display = container.style.display === "none" ? "block" : "none";
    }
    function updateCalendarFromSelect() {
      let selectMonth = document.getElementById("selectMonth");
      let selectYear = document.getElementById("selectYear");
      currentCalendarMonth = parseInt(selectMonth.value);
      currentCalendarYear = parseInt(selectYear.value);
      renderCalendar();
    }

  </script>
</body>
</html>
