<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciamento de Contas</title>
  <style>
    /* Estilos gerais */
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1, h2 {
      color: #333;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #0056b3;
    }
    .hidden { display: none; }
    /* Modal e Calendário */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: flex-start;
      overflow-y: auto;
      padding: 20px;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #333;
    }
    /* Estilo minimalista para a lista de despesas */
    #despesaSelect {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #f9f9f9;
    }
    #despesaSelect option {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    #despesaSelect option:hover {
      background: #007bff;
      color: white;
    }
    /* Filtros de pesquisa */
    .filtros {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .filtros select, .filtros input {
      flex: 1;
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-database-compat.js"></script>
</head>
<body>

  <!-- Menu Principal -->
  <div class="container">
    <h1>Gerenciamento de Contas</h1>
    <button onclick="abrirModal('cadastroModal')">Cadastrar Nova Renda</button>
    <button onclick="abrirModal('fonteModal'); loadUsuarios()">Fonte de Renda</button>
    <button onclick="abrirModal('categoriasModal')">Gerenciar Categorias</button>
    <button onclick="abrirModal('cartaoModal')">Gerenciar Cartões</button>
    <button onclick="abrirModal('calendarModal'); renderCalendar()">Calendário</button>
  </div>

  <!-- Cadastro de Despesa -->
  <div class="container">
    <h2>Cadastrar Despesa</h2>
    <label>Descrição:</label>
    <input type="text" id="despesaDescricao" placeholder="Descrição da despesa" required>
    <label>Valor (R$):</label>
    <input type="number" id="despesaValor" placeholder="Valor" step="0.01" required>
    <label>Data da Compra:</label>
    <input type="date" id="dataCompra" required>
    <label>Categoria:</label>
    <select id="categoriaDespesa">
      <option value="">Selecione a Categoria</option>
    </select>
    <label>Forma de Pagamento:</label>
    <select id="formaPagamento" onchange="toggleParcelamento()">
      <option value="avista">À Vista</option>
      <option value="cartao">Cartão</option>
    </select>
    <div id="parcelamentoDiv" class="hidden">
      <label>Cartão:</label>
      <select id="cartaoDespesa" required>
        <option value="">Selecione o Cartão</option>
      </select>
      <label>Número de Parcelas:</label>
      <input type="number" id="numParcelasDespesa" min="1" max="12" required>
    </div>
    <button onclick="salvarDespesa()">Salvar Despesa</button>
  </div>

  <!-- Pagar Despesa -->
  <div class="container">
    <h2>Pagar Despesa</h2>
    <div class="filtros">
      <select id="filtroMes">
        <option value="">Todos os meses</option>
        <option value="0">Janeiro</option>
        <option value="1">Fevereiro</option>
        <option value="2">Março</option>
        <option value="3">Abril</option>
        <option value="4">Maio</option>
        <option value="5">Junho</option>
        <option value="6">Julho</option>
        <option value="7">Agosto</option>
        <option value="8">Setembro</option>
        <option value="9">Outubro</option>
        <option value="10">Novembro</option>
        <option value="11">Dezembro</option>
      </select>
      <select id="filtroAno">
        <option value="">Todos os anos</option>
        <!-- Preenchido dinamicamente -->
      </select>
      <button onclick="filtrarDespesas()">Filtrar</button>
    </div>
    <label>Pesquisar Despesa:</label>
    <input type="text" id="despesaSearch" placeholder="Digite parte da descrição...">
    <select id="despesaSelect" size="5"></select>
    <button onclick="pagarDespesaSelecionada()">Pagar Despesa Selecionada</button>
  </div>

  <!-- Relatório Mensal -->
  <div class="container" id="relatorioMensalSection">
    <h2>Relatório Mensal de Despesas Pagas</h2>
    <button onclick="loadRelatorioMensal()">Atualizar Relatório</button>
    <div id="relatorioMensalContainer"></div>
  </div>

  <!-- Modal de Calendário -->
  <div id="calendarModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('calendarModal')">&times;</span>
      <h2>Calendário de Despesas</h2>
      <div id="calendarHeader">
        <button onclick="prevMonth()">&#9664;</button>
        <span id="calendarMonthYear" onclick="toggleMonthYearSelect()"></span>
        <button onclick="nextMonth()">&#9654;</button>
      </div>
      <div id="monthYearSelect">
        <select id="selectMonth" onchange="updateCalendarFromSelect()">
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
        <select id="selectYear" onchange="updateCalendarFromSelect()">
          <!-- Preenchido dinamicamente -->
        </select>
        <button onclick="toggleMonthYearSelect()">Ok</button>
      </div>
      <div id="calendarGrid"></div>
    </div>
  </div>

  <!-- Modal de Cadastro de Renda -->
  <div id="cadastroModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('cadastroModal')">&times;</span>
      <h2>Cadastrar Nova Renda</h2>
      <div id="mensagemSucessoRenda"></div>
      <form id="cadastroForm">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" placeholder="Nome" required>
        <label for="parentesco">Parentesco:</label>
        <select id="parentesco" required>
          <option value="eu">Eu</option>
          <option value="pai">Pai</option>
          <option value="irma">Irmã</option>
          <option value="esposa">Esposa</option>
          <option value="filho">Filho</option>
          <option value="filha">Filha</option>
          <option value="outros">Outros</option>
        </select>
        <div class="checkbox-group">
          <label><input type="checkbox" id="cltCheckbox" onclick="toggleClt()"> CLT</label>
          <label><input type="checkbox" id="pjCheckbox"> PJ</label>
        </div>
        <div id="cltFields" style="display: none;">
          <label for="salarioBruto">Salário Bruto (R$):</label>
          <input type="number" id="salarioBruto" placeholder="Digite o salário bruto" step="0.01" oninput="atualizarSalarioLiquido()">
          <label for="salarioLiquido">Salário Líquido (R$):</label>
          <input type="number" id="salarioLiquido" placeholder="Salário líquido calculado" step="0.01">
          <label for="numPagamentos">Número de Pagamentos no Mês:</label>
          <input type="number" id="numPagamentos" placeholder="Digite o número de pagamentos" min="1" max="5" oninput="gerarCamposPagamentos()">
          <div id="pagamentosContainer"></div>
          <p id="avisoErro" style="color: red; display: none;">Os valores não somam o salário líquido!</p>
        </div>
        <button type="submit">Salvar</button>
      </form>
    </div>
  </div>

  <!-- Modal Fonte de Renda -->
  <div id="fonteModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('fonteModal')">&times;</span>
      <h2>Fonte de Renda</h2>
      <div id="usuariosLista"></div>
    </div>
  </div>

  <!-- Modal Gerenciar Categorias -->
  <div id="categoriasModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('categoriasModal')">&times;</span>
      <h2>Gerenciar Categorias</h2>
      <label>Nome da Categoria:</label>
      <input type="text" id="categoriaNome" placeholder="Nome da categoria">
      <button onclick="salvarCategoria()">Salvar Categoria</button>
      <div id="categoriasLista"></div>
    </div>
  </div>

  <!-- Modal Gerenciar Cartões -->
  <div id="cartaoModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('cartaoModal')">&times;</span>
      <h2>Gerenciar Cartões</h2>
      <label>Nome do Cartão:</label>
      <input type="text" id="nomeCartao" placeholder="Nome do Cartão">
      <label>Dia da Fatura:</label>
      <input type="number" id="diaFatura" placeholder="Ex.: 20" min="1" max="31">
      <label>Dia do Fechamento:</label>
      <input type="number" id="diaFechamento" placeholder="Ex.: 11" min="1" max="31">
      <label>Limite do Cartão (R$):</label>
      <input type="number" id="limiteCartao" placeholder="Limite" step="0.01">
      <button onclick="salvarCartao()">Salvar Cartão</button>
      <div id="cartoesLista"></div>
    </div>
  </div>

  <script>
    // Firebase Configuração – utilize seus dados
    const firebaseConfig = {
      apiKey: "AIzaSyAG6LktPXGe6F-vSTHV2Y3n95vSwhpXch8",
      authDomain: "controlegasto-df3f1.firebaseapp.com",
      databaseURL: "https://controlegasto-df3f1-default-rtdb.firebaseio.com",
      projectId: "controlegasto-df3f1",
      storageBucket: "controlegasto-df3f1.firebasestorage.app",
      messagingSenderId: "1034936676414",
      appId: "1:1034936676414:web:61c67ce39c3ab71a07a16f",
      measurementId: "G-PTN43GZHGR"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* Funções para modais */
    window.abrirModal = function(id) {
      document.getElementById(id).style.display = "flex";
      if (id === "fonteModal") loadUsuarios();
      if (id === "categoriasModal") loadCategorias();
      if (id === "cartaoModal") loadCartoes();
      if (id === "calendarModal") renderCalendar();
    };
    window.fecharModal = function(id) {
      document.getElementById(id).style.display = "none";
    };

    /* Módulo Despesa */
    function toggleParcelamento() {
      const forma = document.getElementById("formaPagamento").value;
      document.getElementById("parcelamentoDiv").classList.toggle("hidden", forma !== "cartao");
    }

    function salvarDespesa() {
      const descricao = document.getElementById("despesaDescricao").value;
      const valor = parseFloat(document.getElementById("despesaValor").value);
      const dataCompra = document.getElementById("dataCompra").value;
      const categoria = document.getElementById("categoriaDespesa").value;
      const formaPagamento = document.getElementById("formaPagamento").value;
      const despesasRef = db.ref("despesas");

      if (formaPagamento === "cartao") {
        const selectCartao = document.getElementById("cartaoDespesa");
        if (!selectCartao.value) {
          alert("Selecione um cartão para despesas no cartão.");
          return;
        }
        const numParcelas = parseInt(document.getElementById("numParcelasDespesa").value);
        const cardOption = selectCartao.selectedOptions[0];
        const diaFatura = parseInt(cardOption.getAttribute("data-fatura"));
        const diaFechamento = parseInt(cardOption.getAttribute("data-fechamento"));
        let parcelas = [];
        const purchaseDate = new Date(dataCompra);
        const purchaseDay = purchaseDate.getDate();
        let firstDueDate = new Date(purchaseDate);
        if (purchaseDay > diaFechamento) {
          firstDueDate.setMonth(firstDueDate.getMonth() + 1);
          firstDueDate.setDate(diaFatura);
        } else {
          firstDueDate.setDate(diaFatura);
        }
        const valorParcela = parseFloat((valor / numParcelas).toFixed(2));
        for (let i = 0; i < numParcelas; i++) {
          let parcelaDate = new Date(firstDueDate);
          parcelaDate.setMonth(parcelaDate.getMonth() + i);
          parcelas.push({
            valor: valorParcela,
            vencimento: parcelaDate.toISOString().split("T")[0],
            pago: false
          });
        }
        const despesaData = {
          descricao: descricao,
          formaPagamento: formaPagamento,
          dataCompra: dataCompra,
          categoria: categoria,
          parcelas: parcelas,
          cartao: {
            id: selectCartao.value,
            nome: selectCartao.selectedOptions[0].text,
            diaFatura: diaFatura,
            diaFechamento: diaFechamento
          },
          timestamp: new Date().toISOString()
        };
        despesasRef.push(despesaData)
          .then(() => {
            alert("Despesa com cartão cadastrada com sucesso!");
            document.getElementById("despesaForm").reset();
            toggleParcelamento();
            loadDespesasNaoPagasSelect();
            renderCalendar();
            updateCartaoSelect();
          })
          .catch(err => alert("Erro: " + err));
      } else {
        const despesaData = {
          descricao: descricao,
          valor: valor,
          dataCompra: dataCompra,
          formaPagamento: formaPagamento,
          categoria: categoria,
          pago: false,
          timestamp: new Date().toISOString()
        };
        despesasRef.push(despesaData)
          .then(() => {
            alert("Despesa à vista cadastrada com sucesso!");
            document.getElementById("despesaForm").reset();
            loadDespesasNaoPagasSelect();
            renderCalendar();
          })
          .catch(err => alert("Erro: " + err));
      }
    }

    /* Módulo Pagar Despesa */
    function loadDespesasNaoPagasSelect() {
      const select = document.getElementById("despesaSelect");
      select.innerHTML = "";
      db.ref("despesas").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const despesa = child.val();
          const id = child.key;
          if (despesa.formaPagamento === "cartao" && despesa.parcelas) {
            despesa.parcelas.forEach((parcela, idx) => {
              if (!parcela.pago) {
                let opt = document.createElement("option");
                opt.value = `${id}|${idx}`;
                opt.text = `${despesa.descricao} - Parcela ${idx+1}/${despesa.parcelas.length} - ${parcela.vencimento} - R$ ${parcela.valor}`;
                select.appendChild(opt);
              }
            });
          } else if (!despesa.pago) {
            let opt = document.createElement("option");
            opt.value = id;
            opt.text = `${despesa.descricao} - ${despesa.dataCompra} - R$ ${despesa.valor}`;
            select.appendChild(opt);
          }
        });
      });
    }

    function filtrarDespesas() {
      const mes = document.getElementById("filtroMes").value;
      const ano = document.getElementById("filtroAno").value;
      const select = document.getElementById("despesaSelect");
      select.innerHTML = "";
      db.ref("despesas").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const despesa = child.val();
          const id = child.key;
          const data = new Date(despesa.dataCompra);
          const despesaMes = data.getMonth();
          const despesaAno = data.getFullYear();
          if ((mes === "" || despesaMes == mes) && (ano === "" || despesaAno == ano)) {
            if (despesa.formaPagamento === "cartao" && despesa.parcelas) {
              despesa.parcelas.forEach((parcela, idx) => {
                if (!parcela.pago) {
                  let opt = document.createElement("option");
                  opt.value = `${id}|${idx}`;
                  opt.text = `${despesa.descricao} - Parcela ${idx+1}/${despesa.parcelas.length} - ${parcela.vencimento} - R$ ${parcela.valor}`;
                  select.appendChild(opt);
                }
              });
            } else if (!despesa.pago) {
              let opt = document.createElement("option");
              opt.value = id;
              opt.text = `${despesa.descricao} - ${despesa.dataCompra} - R$ ${despesa.valor}`;
              select.appendChild(opt);
            }
          }
        });
      });
    }

    document.getElementById("despesaSearch").addEventListener("input", function() {
      const termo = document.getElementById("despesaSearch").value.toLowerCase();
      const select = document.getElementById("despesaSelect");
      for (let i = 0; i < select.options.length; i++) {
        const txt = select.options[i].text.toLowerCase();
        select.options[i].style.display = txt.includes(termo) ? "" : "none";
      }
    });

    function pagarDespesaSelecionada() {
      const select = document.getElementById("despesaSelect");
      const val = select.value;
      if (!val) { alert("Selecione uma despesa!"); return; }
      if (val.indexOf("|") !== -1) {
        const [id, idx] = val.split("|");
        const ref = db.ref("despesas").child(id);
        ref.once("value").then(snapshot => {
          let desp = snapshot.val();
          desp.parcelas[idx].pago = true;
          ref.update({ parcelas: desp.parcelas })
            .then(() => { 
              alert("Parcela paga com sucesso!"); 
              loadDespesasNaoPagasSelect();
              renderCalendar();
              updateCartaoSelect();
            });
        });
      } else {
        db.ref("despesas").child(val).update({ pago: true })
          .then(() => { 
            alert("Despesa à vista paga!"); 
            loadDespesasNaoPagasSelect();
            renderCalendar();
            updateCartaoSelect();
          });
      }
    }

    /* Inicialização única */
    window.onload = function() {
      document.getElementById("dataCompra").value = new Date().toISOString().split("T")[0];
      updateCategoriaSelect();
      updateCartaoSelect();
      loadDespesasNaoPagasSelect();
      loadCategorias();
      loadCartoes();
      renderCalendar();
      populateAnoFilter();
    };

    function populateAnoFilter() {
      const selectAno = document.getElementById("filtroAno");
      const currentYear = new Date().getFullYear();
      for (let i = currentYear - 10; i <= currentYear + 10; i++) {
        let option = document.createElement("option");
        option.value = i;
        option.text = i;
        selectAno.appendChild(option);
      }
    }
  </script>
</body>
</html>
