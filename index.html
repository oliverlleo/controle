<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gerenciamento de Contas Pessoais</title>
  
  <!-- Meta tags para evitar cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <!-- Google Fonts: Roboto -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- CSS do Daterangepicker (com versionamento para forçar recarregamento) -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css?v=1.0.0" />
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js?v=1.0.0"></script>
  
  <!-- Ícones (Font Awesome) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css?v=1.0.0">
  
  <style>
    :root {
      --bg-color: #e6ebf1;
      --card-color: #f0f3f5;
      --primary: #4caf50;
      --text-color: #333;
      --shadow-light: rgba(255, 255, 255, 0.7);
      --shadow-dark: rgba(0, 0, 0, 0.1);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(145deg, #e6ebf1, #f0f3f5);
      color: var(--text-color);
      display: flex;
      min-height: 100vh;
      overflow: hidden;
    }
    
    /* Navegação Lateral */
    aside {
      width: 250px;
      background: var(--card-color);
      padding: 20px;
      box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    aside h2 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 10px;
    }
    
    aside a {
      text-decoration: none;
      color: var(--text-color);
      padding: 10px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s ease;
      box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
    }
    
    aside a:hover {
      background: var(--primary);
      color: #fff;
    }
    
    /* Conteúdo Principal */
    main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    
    header {
      margin-bottom: 20px;
    }
    
    header h1 {
      color: var(--primary);
      text-align: center;
      margin-bottom: 20px;
    }
    
    .container {
      background: var(--card-color);
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
    }
    
    button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 6px;
      background: var(--card-color);
      box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
      font-size: 1rem;
      color: var(--text-color);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    button:hover {
      background: var(--primary);
      color: #fff;
      box-shadow: 1px 1px 3px var(--shadow-dark), -1px -1px 3px var(--shadow-light);
    }
    
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: none;
      border-radius: 6px;
      background: var(--card-color);
      box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
      font-size: 1rem;
      color: var(--text-color);
      outline: none;
    }
    
    input:focus, select:focus {
      box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
    }
    
    /* Modais e Drawers */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      justify-content: center;
      align-items: center;
      padding: 20px;
      z-index: 1000;
    }
    
    .modal-content {
      background: var(--card-color);
      padding: 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-color);
    }
    
    /* Tabelas e Gráficos */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    
    th {
      background: var(--primary);
      color: #fff;
    }
    
    /* Responsividade */
    @media (max-width: 800px) {
      body { flex-direction: column; }
      aside { width: 100%; flex-direction: row; overflow-x: auto; }
      aside a { flex: 1; justify-content: center; }
      main { padding: 10px; }
    }
    
    /* Estilização para o seletor do Dashboard */
    #dashboardHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    #dashboardMonthSelector {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Ajuste para o título ficar na mesma linha que os controles */
    #dashboardSection h2 {
      display: inline-block;
      margin-right: 20px;
    }
    
    /* Estilo para os botões de navegação por mês */
    .nav-mes-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--primary);
    }
    
    /* Estilo do painel de despesas do mês */
    #painelDespesasMes {
      width: 50%;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      background: var(--card-color);
    }
    
    /* Ajuste para o container do gráfico e painel */
    .grafico-painel-container {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    
    #graficoDespesas {
      width: 50% !important;
      max-height: 300px;
      box-sizing: border-box;
      display: block;
    }
    
    /* CSS para alertas (novos) */
    .toast-alerta {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      padding: 15px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <!-- Menu Lateral -->
  <aside>
    <h2><i class="fa-solid fa-wallet"></i> Contas</h2>
    <a href="#" onclick="showSection('dashboardSection')"><i class="fa-solid fa-house"></i> Dashboard</a>
    <a href="#" onclick="showSection('despesasSection')"><i class="fa-solid fa-money-bill-wave"></i> Despesas</a>
    <a href="#" onclick="showSection('relatorioSection')"><i class="fa-solid fa-chart-line"></i> Relatórios</a>
    <a href="#" onclick="showSection('categoriasSection')"><i class="fa-solid fa-tags"></i> Categorias</a>
    <a href="#" onclick="showSection('cartoesSection')"><i class="fa-solid fa-credit-card"></i> Cartões</a>
    <a href="#" onclick="showSection('rendaSection')"><i class="fa-solid fa-user"></i> Renda</a>
    <a href="#" onclick="exportData()"><i class="fa-solid fa-file-export"></i> Exportar Dados</a>
    <!-- Novos itens no Menu Lateral -->
    <a href="#" onclick="showSection('previsaoSection')"><i class="fa-solid fa-chart-line"></i> Previsões</a>
    <a href="#" onclick="showSection('alertasSection')"><i class="fa-solid fa-bell"></i> Alertas</a>
  </aside>
  
  <!-- Conteúdo Principal -->
  <main>
    <header>
      <h1>Sistema de Gerenciamento de Contas</h1>
    </header>
    
    <!-- Dashboard Resumido -->
    <section id="dashboardSection" class="container">
      <div id="dashboardHeader">
        <h2>Dashboard Resumido</h2>
        <div id="dashboardMonthSelector">
          <label for="dashboardMonth">Mês:</label>
          <select id="dashboardMonth">
            <option value="0">Janeiro</option>
            <option value="1">Fevereiro</option>
            <option value="2">Março</option>
            <option value="3">Abril</option>
            <option value="4">Maio</option>
            <option value="5">Junho</option>
            <option value="6">Julho</option>
            <option value="7">Agosto</option>
            <option value="8">Setembro</option>
            <option value="9">Outubro</option>
            <option value="10">Novembro</option>
            <option value="11">Dezembro</option>
          </select>
          <label for="dashboardYear">Ano:</label>
          <select id="dashboardYear">
            <option value="2020">2020</option>
            <option value="2021">2021</option>
            <option value="2022">2022</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
          </select>
          <button onclick="atualizarDashboard()">Atualizar Dashboard</button>
        </div>
      </div>
      
      <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap; margin-top: 20px;">
        <!-- Resumo dos dados ocupando o restante do espaço -->
        <div id="dashboardResumo" style="flex: 1; display: flex; justify-content: space-around; align-items: center;">
          <div class="dashboard-item" style="text-align: center;">
            <h3>Saldo Atual</h3>
            <p id="saldoAtual">R$ 6416.60</p>
          </div>
          <div class="dashboard-item" style="text-align: center;">
            <!-- Título com navegação por mês -->
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
              <button class="nav-mes-btn" onclick="prevDashboardMonth()"><i class="fa-solid fa-arrow-left"></i></button>
              <h3 id="despesasMesTitle">Despesas de Março</h3>
              <button class="nav-mes-btn" onclick="nextDashboardMonth()"><i class="fa-solid fa-arrow-right"></i></button>
            </div>
            <p id="despesasMes">R$ 4440.00</p>
          </div>
          <div class="dashboard-item" style="text-align: center;">
            <h3>Próximos Vencimentos</h3>
            <p id="proximosVencimentos">27</p>
          </div>
        </div>
      </div>
      
      <!-- Gráfico de Despesas e Painel de Despesas do Mês divididos em duas colunas -->
      <div class="grafico-painel-container">
        <canvas id="graficoDespesas" width="809" height="375" style="box-sizing: border-box; display: block; height: 300px; width: 647px;"></canvas>
        <div id="painelDespesasMes">
          <h4>Despesas do Mês</h4>
          <div id="listaDespesasMes">
            <!-- Exemplo existente:
            <div style="border-bottom: 1px solid rgb(204, 204, 204); padding: 5px 0px;">
              <strong>cartão </strong> - À Vista - R$ 4440.00<br>
              <small>20/03/2025</small>
            </div>
            -->
          </div>
        </div>
      </div>
      
      <button onclick="abrirModal('cadastroDespesaModal')">Cadastrar Nova Despesa</button>
    </section>
    
    <!-- Seção de Despesas (Cadastro e Pagamento) -->
    <section id="despesasSection" class="container" style="display: none;">
      <h2>Despesas</h2>
      <button onclick="abrirModal('cadastroDespesaModal')">Cadastrar Despesa</button>
      <button onclick="abrirModal('pagarDespesaModal')">Pagar Despesa</button>
      <button onclick="abrirModal('calendarModal'); renderCalendar()">Calendário</button>
    </section>
    
    <!-- Seção de Relatórios -->
    <section id="relatorioSection" class="container" style="display: none;">
      <h2>Relatórios</h2>
      <div id="filtrosRelatorio" style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
        <label for="dataRange">Período:</label>
        <input type="text" id="dataRange" placeholder="00/00/0000 - 00/00/0000">
      </div>
      <div id="relatorioMensalContainer"></div>
    </section>
    
    <!-- Seção de Categorias -->
    <section id="categoriasSection" class="container" style="display: none;">
      <h2>Categorias</h2>
      <button onclick="abrirModal('categoriasModal')">Gerenciar Categorias</button>
      <div id="categoriasListaPrincipal"></div>
    </section>
    
    <!-- Seção de Cartões -->
    <section id="cartoesSection" class="container" style="display: none;">
      <h2>Cartões</h2>
      <button onclick="abrirModal('cartaoModal')">Gerenciar Cartões</button>
      <div id="cartoesListaPrincipal"></div>
    </section>
    
    <!-- Seção de Renda -->
    <section id="rendaSection" class="container" style="display: none;">
      <h2>Cadastro de Renda</h2>
      <button onclick="abrirModal('cadastroModal')">Cadastrar Nova Renda</button>
      <button onclick="loadRendas()">Ver Rendas Cadastradas</button>
      <div id="usuariosListaPrincipal"></div>
    </section>
    
    <!-- NOVAS SEÇÕES -->
    <!-- Seção de Previsões -->
    <section id="previsaoSection" class="container" style="display:none;">
      <h2>Previsão de Gastos</h2>
      <div class="grafico-painel-container">
        <canvas id="novo_graficoPrevisao"></canvas>
        <div id="novo_tabelaPrevisao">
          <h4>Próximos 3 Meses</h4>
          <!-- Dados serão preenchidos via JS -->
        </div>
      </div>
      <button onclick="novo_calcularPrevisoes()">Gerar Previsões</button>
    </section>
    
    <!-- Seção de Alertas -->
    <section id="alertasSection" class="container" style="display:none;">
      <h2>Alertas</h2>
      <button onclick="abrirModal('novo_limitesModal')">
        <i class="fa-solid fa-sliders"></i> Configurar Limites
      </button>
      <div id="novo_listaAlertas" style="margin-top: 20px;"></div>
    </section>
  </main>
  
  <!-- ===================== MODAIS ===================== -->
  <!-- Modal: Cadastro de Despesa (Reutiliza as funções originais) -->
  <div id="cadastroDespesaModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('cadastroDespesaModal')">&times;</span>
      <h2>Cadastrar Despesa</h2>
      <label>Descrição:</label>
      <input type="text" id="despesaDescricao" placeholder="Descrição da despesa" required>
      <label>Valor (R$):</label>
      <input type="number" id="despesaValor" placeholder="Valor" step="0.01" required>
      <label>Data da Compra:</label>
      <input type="date" id="dataCompra" required>
      <label>Categoria:</label>
      <select id="categoriaDespesa">
        <option value="">Selecione a Categoria</option>
        <option value="-OLp0FXlAC6bjHph1w4E">Fixo</option>
        <option value="-OLs5YvsxD2FPYqe6ATi">Casa</option>
        <option value="-OLs5_qmZZmFqKmaSE2S">Carro</option>
        <option value="-OLs5eHQkVx5m9JbmuVK">Alimentação</option>
        <option value="-OLs5m5bXk2uRhNfCawq">Pet</option>
        <option value="-OM7odu2iJfsBwYv9wyV">Lazer</option>
      </select>
      <label>Forma de Pagamento:</label>
      <select id="formaPagamento" onchange="toggleParcelamento()">
        <option value="avista">À Vista</option>
        <option value="cartao">Cartão</option>
      </select>
      <div id="parcelamentoDiv" class="hidden">
        <label>Cartão:</label>
        <select id="cartaoDespesa" required>
          <option value="">Selecione o Cartão</option>
        </select>
        <label>Número de Parcelas:</label>
        <input type="number" id="numParcelasDespesa" min="1" max="12" required>
      </div>
      <button onclick="salvarDespesa()">Salvar Despesa</button>
    </div>
  </div>
  
  <!-- Modal: Pagamento de Despesa -->
  <div id="pagarDespesaModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('pagarDespesaModal')">&times;</span>
      <h2>Pagar Despesa</h2>
      <div id="pagarDespesaFilters" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center;">
        <input type="text" id="despesaSearch" placeholder="Descrição" maxlength="25">
        <input type="text" id="mesFiltro" placeholder="Mês (ex: JAN)" list="meses">
        <datalist id="meses">
          <option value="JAN">
          <option value="FEV">
          <option value="MAR">
          <option value="ABR">
          <option value="MAI">
          <option value="JUN">
          <option value="JUL">
          <option value="AGO">
          <option value="SET">
          <option value="OUT">
          <option value="NOV">
          <option value="DEZ">
        </datalist>
        <input type="text" id="anoFiltro" placeholder="Ano (ex: 2025)" list="anos">
        <datalist id="anos">
          <option value="2020">
          <option value="2021">
          <option value="2022">
          <option value="2023">
          <option value="2024">
          <option value="2025">
          <option value="2026">
          <option value="2027">
        </datalist>
        <select id="categoriaFiltro">
          <option value="">Todas as Categorias</option>
        </select>
        <label style="display: flex; align-items: center; gap: 5px;">
          <input type="checkbox" id="contaMesFiltro">
          Conta do Mês
        </label>
        <button onclick="filtrarDespesas()">Filtrar</button>
      </div>
      <select id="despesaSelect" size="5" style="margin-top: 10px;">
        <option value="-OLq5V9CphPw9F7FTtje|0">brinc - Parcela 1 de 2 - Venc: 2025-04-20 - R$ 1111.00</option>
        <option value="-OLq5V9CphPw9F7FTtje|1">brinc - Parcela 2 de 2 - Venc: 2025-05-20 - R$ 1111.00</option>
        <option value="-OLqhbGqG0eaCM8dC_k1">cartão  R$ 4440.00 - 2025-03-21</option>
      </select>
      <button onclick="pagarDespesaSelecionada()">Pagar Parcela Selecionada</button>
    </div>
  </div>
  
  <!-- Modal: Calendário de Despesas -->
  <div id="calendarModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('calendarModal')">&times;</span>
      <h2 id="calendarTitulo">Calendário de Despesas</h2>
      <div id="calendarHeader" style="display: flex; justify-content: space-between; align-items: center;">
        <button onclick="prevMonth()">&#9664;</button>
        <span id="calendarMonthYear" onclick="toggleMonthYearSelect()" style="cursor: pointer;"></span>
        <button onclick="nextMonth()">&#9654;</button>
      </div>
      <div id="monthYearSelect" style="display: none; margin-bottom: 10px;">
        <select id="selectMonth">
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
        <select id="selectYear">
          <!-- Preenchido dinamicamente -->
        </select>
        <button onclick="toggleMonthYearSelect()">Ok</button>
      </div>
      <div id="calendarGrid"></div>
      <div id="saldoDisponivelContainer" style="text-align: right; margin-top: 10px; font-weight: bold; color: var(--primary);">Saldo Atual: R$ 0,00</div>
    </div>
  </div>
  
  <!-- Modal: Cadastro de Renda -->
  <div id="cadastroModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('cadastroModal')">&times;</span>
      <h2>Cadastrar Nova Renda</h2>
      <div id="mensagemSucessoRenda"></div>
      <form id="cadastroForm">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" placeholder="Nome" required>
        <label for="parentesco">Parentesco:</label>
        <select id="parentesco" required>
          <option value="eu">Eu</option>
          <option value="pai">Pai</option>
          <option value="irma">Irmã</option>
          <option value="esposa">Esposa</option>
          <option value="filho">Filho</option>
          <option value="filha">Filha</option>
          <option value="outros">Outros</option>
        </select>
        <!-- Novo campo: Saldo Inicial -->
        <label for="saldoInicial">Saldo Inicial (R$):</label>
        <input type="number" id="saldoInicial" placeholder="Digite o saldo inicial" step="0.01" required>
        <div class="checkbox-group" style="display: flex; gap: 20px; margin: 15px 0; justify-content: center;">
          <label><input type="checkbox" id="cltCheckbox" onclick="toggleClt()"> CLT</label>
          <label><input type="checkbox" id="pjCheckbox"> PJ</label>
        </div>
        <div id="cltFields" style="display: none;">
          <label for="salarioBruto">Salário Bruto (R$):</label>
          <input type="number" id="salarioBruto" placeholder="Digite o salário bruto" step="0.01" oninput="atualizarSalarioLiquido()">
          <label for="salarioLiquido">Salário Líquido (R$):</label>
          <input type="number" id="salarioLiquido" placeholder="Salário líquido calculado" step="0.01">
          <label for="numPagamentos">Número de Pagamentos no Mês:</label>
          <input type="number" id="numPagamentos" placeholder="Digite o número de pagamentos" min="1" max="5" oninput="gerarCamposPagamentos()">
          <div id="pagamentosContainer"></div>
          <p id="avisoErro" style="color: red; display: none;">Os valores não somam o salário líquido!</p>
        </div>
        <button type="submit">Salvar</button>
      </form>
    </div>
  </div>
  
  <!-- Modal: Fonte de Renda / Usuários -->
  <div id="fonteModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('fonteModal')">&times;</span>
      <h2>Fonte de Renda</h2>
      <div id="usuariosLista"></div>
    </div>
  </div>
  
  <!-- Modal: Gerenciar Categorias -->
  <div id="categoriasModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('categoriasModal')">&times;</span>
      <h2>Gerenciar Categorias</h2>
      <label>Nome da Categoria:</label>
      <input type="text" id="categoriaNome" placeholder="Nome da categoria">
      <button onclick="salvarCategoria()">Salvar Categoria</button>
      <div id="categoriasLista"></div>
    </div>
  </div>
  
  <!-- Modal: Gerenciar Cartões -->
  <div id="cartaoModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('cartaoModal')">&times;</span>
      <h2>Gerenciar Cartões</h2>
      <label>Nome do Cartão:</label>
      <input type="text" id="nomeCartao" placeholder="Nome do Cartão">
      <label>Dia da Fatura:</label>
      <input type="number" id="diaFatura" placeholder="Ex.: 20" min="1" max="31">
      <label>Dia do Fechamento:</label>
      <input type="number" id="diaFechamento" placeholder="Ex.: 11" min="1" max="31">
      <label>Limite do Cartão (R$):</label>
      <input type="number" id="limiteCartao" placeholder="Limite" step="0.01">
      <button onclick="salvarCartao()">Salvar Cartão</button>
      <div id="cartoesLista"></div>
    </div>
  </div>
  
  <!-- Modal NOVO: Configurar Limites (Limites por Categoria) -->
  <div id="novo_limitesModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal('novo_limitesModal')">&times;</span>
      <h2>Configurar Limites por Categoria</h2>
      <div id="novo_limitesContainer"></div>
      <button onclick="novo_salvarLimites()">Salvar Limites</button>
    </div>
  </div>
  
  <!-- ===================== SCRIPTS ===================== -->
  <!-- Inclusão de bibliotecas externas -->
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-database-compat.js"></script>
  
  <script>
    'use strict';
    
    // Variável para controlar a exibição das rendas
    let rendaVisivel = false;
    
    // Variáveis de navegação e calendário
    let currentCalendarMonth = new Date().getMonth();
    let currentCalendarYear = new Date().getFullYear();
    let rangeStart = null;
    let rangeEnd = null;
    
    // Firebase Configuração – mantenha os dados originais inalterados
    const firebaseConfig = {
      apiKey: "AIzaSyAG6LktPXGe6F-vSTHV2Y3n95vSwhpXch8",
      authDomain: "controlegasto-df3f1.firebaseapp.com",
      databaseURL: "https://controlegasto-df3f1-default-rtdb.firebaseio.com",
      projectId: "controlegasto-df3f1",
      storageBucket: "controlegasto-df3f1.firebasestorage.app",
      messagingSenderId: "1034936676414",
      appId: "1:1034936676414:web:61c67ce39c3ab71a07a16f",
      measurementId: "G-PTN43GZHGR"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    /* Carrega mapeamento de categorias (ID => Nome) sem alterar a estrutura existente */
    window.novo_categoriasMap = {};
    db.ref("categorias").once("value").then(snapshot => {
      snapshot.forEach(child => {
        window.novo_categoriasMap[child.key] = child.val().nome;
      });
    });
    
    /* Inicialização do Daterangepicker com máscara */
    $(function() {
      $('#dataRange').mask('00/00/0000 - 00/00/0000', {
        placeholder: "00/00/0000 - 00/00/0000",
        clearIfNotMatch: false,
        selectOnFocus: true
      });
      
      $('#dataRange').daterangepicker({
        autoUpdateInput: false,
        locale: {
          format: 'DD/MM/YYYY',
          applyLabel: 'Aplicar',
          cancelLabel: 'Cancelar',
          fromLabel: 'Data Inicial',
          toLabel: 'Data Final',
          customRangeLabel: 'Personalizado',
          weekLabel: 'S',
          daysOfWeek: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'],
          monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'],
          firstDay: 0
        }
      });
      
      $('#dataRange').on('apply.daterangepicker', function(ev, picker) {
        rangeStart = picker.startDate.toDate();
        rangeEnd = picker.endDate.toDate();
        $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
        loadRelatorioMensal();
      });
      
      $('#dataRange').on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
        rangeStart = null;
        rangeEnd = null;
        loadRelatorioMensal();
      });
      
      $('#dataRange').on('show.daterangepicker', function(ev, picker) {
        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    });
    
    /* Preenche o seletor de ano do dashboard */
    function preencherDashboardAno() {
      const selectAno = document.getElementById("dashboardYear");
      selectAno.innerHTML = "";
      const currentYear = new Date().getFullYear();
      for(let y = currentYear - 5; y <= currentYear + 5; y++) {
        let option = document.createElement("option");
        option.value = y;
        option.text = y;
        if(y === currentYear) option.selected = true;
        selectAno.appendChild(option);
      }
    }
    
    /* Função para mostrar seções do sistema */
    function showSection(sectionId) {
      const sections = document.querySelectorAll('main > section');
      sections.forEach(sec => sec.style.display = 'none');
      document.getElementById(sectionId).style.display = 'block';
    }
    
    /* Funções de Modal */
    window.abrirModal = function(id) {
      document.getElementById(id).style.display = "flex";
      if (id === "fonteModal") loadUsuarios();
      if (id === "categoriasModal") loadCategorias();
      if (id === "cartaoModal") loadCartoes();
      if (id === "calendarModal") {
        document.getElementById("calendarTitulo").innerText = "Calendário de Despesas";
        renderCalendar();
      }
      if (id === "pagarDespesaModal") filtrarDespesas();
      // NOVO: Se abrir o modal de limites, carregar limites existentes
      if (id === "novo_limitesModal") novo_carregarLimites();
    };
    
    window.fecharModal = function(id) {
      document.getElementById(id).style.display = "none";
    };
    
    /* Função para exportar dados em CSV */
    function exportData() {
      db.ref("despesas").once("value").then(snapshot => {
        let csv = "Descrição,Valor,Data,Forma de Pagamento\n";
        snapshot.forEach(child => {
          const despesa = child.val();
          if(despesa.formaPagamento === "avista") {
            csv += `${despesa.descricao},${despesa.valor},${despesa.dataCompra},${despesa.formaPagamento}\n`;
          } else if(despesa.formaPagamento === "cartao" && despesa.parcelas) {
            despesa.parcelas.forEach((parcela, index) => {
              csv += `${despesa.descricao} - Parcela ${index+1},${parcela.valor},${parcela.vencimento},${despesa.formaPagamento}\n`;
            });
          }
        });
        let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        let url = URL.createObjectURL(blob);
        let a = document.createElement("a");
        a.href = url;
        a.download = "despesas.csv";
        a.click();
      });
    }
    
    /* Dashboard: Atualiza resumo e gráficos conforme o mês/ano selecionado */
    function atualizarDashboard() {
      const dashboardMonth = parseInt(document.getElementById("dashboardMonth").value);
      const dashboardYear = parseInt(document.getElementById("dashboardYear").value);
      
      let saldo = 0;
      let hoje = new Date();
      
      // Novo cálculo: soma o saldo inicial de cada pessoa e os pagamentos (se já ocorreram)
      db.ref("pessoas").once("value").then(snapshot => {
        snapshot.forEach(child => {
          let pessoa = child.val();
          saldo += parseFloat(pessoa.saldoInicial) || 0; // adiciona o saldo inicial
          if(pessoa.pagamentos) {
            pessoa.pagamentos.forEach(pag => { 
              // Considera o pagamento apenas se o dia do pagamento já passou no mês atual
              let pagamentoDia = parseInt(pag.dia);
              if(pagamentoDia <= hoje.getDate()){
                saldo += parseFloat(pag.valor) || 0;
              }
            });
          }
        });
        
        // Subtrai as despesas pagas
        db.ref("despesas").once("value").then(snapshot2 => {
          snapshot2.forEach(child => {
            let despesa = child.val();
            if(despesa.pago) {
              if(despesa.formaPagamento === "avista") {
                saldo -= parseFloat(despesa.valor) || 0;
              } else if(despesa.formaPagamento === "cartao" && despesa.parcelas) {
                despesa.parcelas.forEach(parcela => {
                  if(parcela.pago) {
                    saldo -= parseFloat(parcela.valor) || 0;
                  }
                });
              }
            }
          });
          document.getElementById("saldoAtual").innerText = "R$ " + saldo.toFixed(2);
          
          // Atualiza outras partes do dashboard
          atualizarDespesasMes();
          currentCalendarMonth = dashboardMonth;
          currentCalendarYear = dashboardYear;
          renderCalendar();
          atualizarGrafico();
          updateProximosVencimentos();
        });
      });
    }
    
    /* Nova Função: Atualiza o contador de próximos vencimentos */
    function updateProximosVencimentos() {
      const hoje = new Date();
      let proximoVencimento = null;
      
      db.ref("despesas").once("value").then(snapshot => {
        snapshot.forEach(child => {
          let despesa = child.val();
          // Verifica para despesas à vista
          if(despesa.formaPagamento === "avista" && !despesa.pago && despesa.dataCompra) {
            let dataCompra = new Date(despesa.dataCompra);
            if(dataCompra >= hoje) {
              if(proximoVencimento === null || dataCompra < proximoVencimento) {
                proximoVencimento = dataCompra;
              }
            }
          }
          // Verifica para despesas com cartão
          else if(despesa.formaPagamento === "cartao" && despesa.parcelas) {
            despesa.parcelas.forEach(parcela => {
              if(!parcela.pago) {
                let venc = new Date(parcela.vencimento);
                if(venc >= hoje) {
                  if(proximoVencimento === null || venc < proximoVencimento) {
                    proximoVencimento = venc;
                  }
                }
              }
            });
          }
        });
        if(proximoVencimento) {
          // Calcula a diferença em dias
          const diffTime = proximoVencimento - hoje;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          document.getElementById("proximosVencimentos").innerText = diffDays;
        } else {
          document.getElementById("proximosVencimentos").innerText = 0;
        }
      });
    }
    
    /* Nova Função: Atualiza as Despesas do Mês (considerando todas as despesas programadas para o mês) */
    function atualizarDespesasMes() {
      const dashboardMonth = parseInt(document.getElementById("dashboardMonth").value);
      const dashboardYear = parseInt(document.getElementById("dashboardYear").value);
      let despesasMes = 0;
      db.ref("despesas").once("value").then(snapshot => {
        snapshot.forEach(child => {
          let despesa = child.val();
          // NÃO processa despesas já pagas
          if(despesa.pago) return;
          // Para despesas à vista, soma se a data da compra pertence ao mês/ano selecionado
          if(despesa.formaPagamento === "avista" && despesa.dataCompra) {
            let dt = new Date(despesa.dataCompra);
            if(dt.getMonth() === dashboardMonth && dt.getFullYear() === dashboardYear) {
              despesasMes += parseFloat(despesa.valor) || 0;
            }
          }
          // Para despesas com cartão, percorre todas as parcelas do mês/ano selecionado
          else if(despesa.formaPagamento === "cartao" && despesa.parcelas) {
            despesa.parcelas.forEach(parcela => {
              let dt = new Date(parcela.vencimento);
              if(dt.getMonth() === dashboardMonth && dt.getFullYear() === dashboardYear) {
                despesasMes += parseFloat(parcela.valor) || 0;
              }
            });
          }
        });
        document.getElementById("despesasMes").innerText = "R$ " + despesasMes.toFixed(2);
      });
    }
    
    /* Nova Função: Atualiza o painel de despesas do mês com busca automática no banco de dados */
    function carregarPainelDespesasMes() {
      const dashboardMonth = parseInt(document.getElementById("dashboardMonth").value);
      const dashboardYear = parseInt(document.getElementById("dashboardYear").value);
      const listaContainer = document.getElementById("listaDespesasMes");
      listaContainer.innerHTML = "";
      
      db.ref("despesas").once("value").then(snapshot => {
        snapshot.forEach(child => {
          let despesa = child.val();
          // NÃO processa despesas que já foram pagas
          if(despesa.pago) return;
          // Processa despesas à vista
          if(despesa.formaPagamento === "avista" && despesa.dataCompra) {
            let dt = new Date(despesa.dataCompra);
            if(dt.getMonth() === dashboardMonth && dt.getFullYear() === dashboardYear) {
              let divDespesa = document.createElement("div");
              divDespesa.style.borderBottom = "1px solid rgb(204, 204, 204)";
              divDespesa.style.padding = "5px 0px";
              // Exibe descrição, valor e data para despesas à vista
              divDespesa.innerHTML = `<strong>${despesa.descricao}</strong> - À Vista - R$ ${parseFloat(despesa.valor).toFixed(2)}<br><small>${dt.toLocaleDateString()}</small>`;
              listaContainer.appendChild(divDespesa);
            }
          }
          // Processa despesas com cartão e suas parcelas
          else if(despesa.formaPagamento === "cartao" && despesa.parcelas) {
            let totalParcelas = despesa.parcelas.length;
            despesa.parcelas.forEach((parcela, index) => {
              let dt = new Date(parcela.vencimento);
              if(dt.getMonth() === dashboardMonth && dt.getFullYear() === dashboardYear) {
                let divDespesa = document.createElement("div");
                divDespesa.style.borderBottom = "1px solid rgb(204, 204, 204)";
                divDespesa.style.padding = "5px 0px";
                // Exibe descrição, número da parcela, total de parcelas, valor da parcela e data
                divDespesa.innerHTML = `<strong>${despesa.descricao}</strong> - Parcela ${index+1} de ${totalParcelas} - Cartão - R$ ${parseFloat(parcela.valor).toFixed(2)}<br><small>${dt.toLocaleDateString()}</small>`;
                listaContainer.appendChild(divDespesa);
              }
            });
          }
        });
        // Após popular a lista, chama a nova função para verificar despesas vencidas
        novo_verificarDespesasVencidas();
      });
    }
    
    /* Gráfico de Despesas por Categoria (usando Chart.js) - Agora inclui todas as despesas do mês */
    let grafico;
    function atualizarGrafico() {
      const dashboardMonth = parseInt(document.getElementById("dashboardMonth").value);
      const dashboardYear = parseInt(document.getElementById("dashboardYear").value);
      let categorias = {};
      db.ref("despesas").once("value").then(snapshot => {
        snapshot.forEach(child => {
          let despesa = child.val();
          // Para despesas à vista, inclui se a data da compra pertence ao mês/ano selecionado
          if(despesa.formaPagamento === "avista" && despesa.dataCompra) {
            let dt = new Date(despesa.dataCompra);
            if(dt.getMonth() === dashboardMonth && dt.getFullYear() === dashboardYear) {
              categorias[despesa.categoria] = (categorias[despesa.categoria] || 0) + parseFloat(despesa.valor);
            }
          }
          // Para despesas com cartão, percorre todas as parcelas do mês/ano selecionado
          else if(despesa.formaPagamento === "cartao" && despesa.parcelas) {
            despesa.parcelas.forEach(parcela => {
              let dt = new Date(parcela.vencimento);
              if(dt.getMonth() === dashboardMonth && dt.getFullYear() === dashboardYear) {
                categorias[despesa.categoria] = (categorias[despesa.categoria] || 0) + parseFloat(parcela.valor);
              }
            });
          }
        });
        // Converte as chaves (IDs de categoria) para os nomes usando o mapeamento global
        const labels = Object.keys(categorias).map(id => window.novo_categoriasMap[id] || id);
        const data = Object.values(categorias);
        const ctx = document.getElementById("graficoDespesas").getContext("2d");
        if(grafico) grafico.destroy();
        grafico = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Despesas por Categoria',
              data,
              backgroundColor: 'rgba(76, 175, 80, 0.6)',
              borderColor: 'rgba(76, 175, 80, 1)',
              borderWidth: 1
            }]
          },
          options: {
            scales: { y: { beginAtZero: true } }
          }
        });
      });
    }
    
    /* Funções de Categorias, Cartões, Despesas e Renda */
    function updateCategoriaSelect() {
      const select = document.getElementById("categoriaDespesa");
      select.innerHTML = '<option value="">Selecione a Categoria</option>';
      db.ref("categorias").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const categoria = child.val();
          const option = document.createElement("option");
          option.value = child.key;
          option.text = categoria.nome;
          select.appendChild(option);
        });
      });
    }
    
    function salvarCategoria() {
      const nomeCategoria = document.getElementById("categoriaNome").value;
      if (!nomeCategoria.trim()) { alert("Digite o nome da categoria."); return; }
      db.ref("categorias").push({ nome: nomeCategoria.trim(), timestamp: new Date().toISOString() })
        .then(() => {
          alert("Categoria salva com sucesso!");
          document.getElementById("categoriaNome").value = "";
          loadCategorias();
          updateCategoriaSelect();
          loadCategoriasFiltro();
        })
        .catch(err => alert("Erro ao salvar categoria: " + err));
    }
    
    function loadCategorias() {
      const categoriasLista = document.getElementById("categoriasLista");
      categoriasLista.innerHTML = "";
      db.ref("categorias").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const categoria = child.val();
          const div = document.createElement("div");
          div.innerHTML = `<strong>${categoria.nome}</strong>`;
          categoriasLista.appendChild(div);
        });
      });
    }
    
    function loadCategoriasFiltro() {
      const select = document.getElementById("categoriaFiltro");
      select.innerHTML = '<option value="">Todas as Categorias</option>';
      db.ref("categorias").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const categoria = child.val();
          const option = document.createElement("option");
          option.value = child.key;
          option.text = categoria.nome;
          select.appendChild(option);
        });
      });
    }
    
    function updateCartaoSelect() {
      const select = document.getElementById("cartaoDespesa");
      select.innerHTML = '<option value="">Selecione o Cartão</option>';
      db.ref("cartoes").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const cartao = child.val();
          const option = document.createElement("option");
          option.value = child.key;
          option.text = cartao.nome;
          option.setAttribute("data-fatura", cartao.diaFatura);
          option.setAttribute("data-fechamento", cartao.diaFechamento);
          select.appendChild(option);
        });
      });
    }
    
    function loadCartoes() {
      const cartoesLista = document.getElementById("cartoesLista");
      cartoesLista.innerHTML = "";
      db.ref("cartoes").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const cartao = child.val();
          const div = document.createElement("div");
          div.innerHTML = `<strong>${cartao.nome}</strong> - Limite: R$ ${parseFloat(cartao.limite).toFixed(2)}`;
          cartoesLista.appendChild(div);
        });
      });
    }
    
    function salvarDespesa() {
      const descricao = document.getElementById("despesaDescricao").value;
      const valor = parseFloat(document.getElementById("despesaValor").value);
      const dataCompra = document.getElementById("dataCompra").value;
      const categoria = document.getElementById("categoriaDespesa").value;
      const formaPagamento = document.getElementById("formaPagamento").value;
      const despesasRef = db.ref("despesas");
      if (isNaN(valor)) {
        alert("O valor da despesa deve ser um número válido.");
        return;
      }
      if (formaPagamento === "cartao") {
        const selectCartao = document.getElementById("cartaoDespesa");
        if (!selectCartao.value) {
          alert("Selecione um cartão para despesas no cartão.");
          return;
        }
        const numParcelas = parseInt(document.getElementById("numParcelasDespesa").value);
        const cardOption = selectCartao.selectedOptions[0];
        const diaFatura = parseInt(cardOption.getAttribute("data-fatura"));
        const diaFechamento = parseInt(cardOption.getAttribute("data-fechamento"));
        let parcelas = [];
        const purchaseDate = new Date(dataCompra);
        let firstDueDate = new Date(purchaseDate);
        if (purchaseDate.getDate() > diaFechamento) {
          firstDueDate.setMonth(firstDueDate.getMonth() + 1);
          firstDueDate.setDate(diaFatura);
        } else {
          firstDueDate.setDate(diaFatura);
        }
        const valorParcela = parseFloat((valor / numParcelas).toFixed(2));
        for (let i = 0; i < numParcelas; i++) {
          let parcelaDate = new Date(firstDueDate);
          parcelaDate.setMonth(parcelaDate.getMonth() + i);
          parcelas.push({
            valor: valorParcela,
            vencimento: parcelaDate.toISOString().split("T")[0],
            pago: false
          });
        }
        const despesaData = {
          descricao,
          formaPagamento,
          dataCompra,
          categoria,
          parcelas,
          cartao: {
            id: selectCartao.value,
            nome: selectCartao.selectedOptions[0].text,
            diaFatura,
            diaFechamento
          },
          pago: false,
          timestamp: new Date().toISOString()
        };
        despesasRef.push(despesaData)
          .then(() => {
            alert("Despesa com cartão cadastrada com sucesso!");
            toggleParcelamento();
            filtrarDespesas();
            renderCalendar();
            updateCartaoSelect();
            atualizarDashboard();
            // Recarrega a página para simular fechar e reabrir
            window.location.reload();
          })
          .catch(err => alert("Erro: " + err));
      } else {
        const despesaData = {
          descricao,
          valor,
          dataCompra,
          formaPagamento,
          categoria,
          pago: false,
          timestamp: new Date().toISOString()
        };
        despesasRef.push(despesaData)
          .then(() => {
            alert("Despesa à vista cadastrada com sucesso!");
            filtrarDespesas();
            renderCalendar();
            atualizarDashboard();
            // Recarrega a página para simular fechar e reabrir
            window.location.reload();
          })
          .catch(err => alert("Erro: " + err));
      }
    }
    
    function toggleParcelamento() {
      const forma = document.getElementById("formaPagamento").value;
      document.getElementById("parcelamentoDiv").classList.toggle("hidden", forma !== "cartao");
    }
    
    // Modificação: Impede o pagamento se não houver saldo suficiente
    function pagarDespesaSelecionada() {
      const despesaSelect = document.getElementById("despesaSelect");
      const selectedValue = despesaSelect.value;
      if (!selectedValue) {
        alert("Selecione uma despesa/parcela!");
        return;
      }
      // Obtém o saldo disponível
      const saldoAtualText = document.getElementById("saldoAtual").innerText;
      const saldoAtual = parseFloat(saldoAtualText.replace("R$", "").replace(",", ".").trim());
      // Obtém o valor da despesa/parcela a partir do texto da opção
      const optionText = despesaSelect.options[despesaSelect.selectedIndex].text;
      const match = optionText.match(/R\$\s*([\d.,]+)/);
      if(match) {
        const despesaValor = parseFloat(match[1].replace(",", "."));
        if(saldoAtual < despesaValor) {
          alert("Saldo insuficiente");
          return;
        }
      }
      
      if (selectedValue.indexOf("|") === -1) {
        db.ref("despesas").child(selectedValue).update({ pago: true })
          .then(() => {
            alert("Despesa paga com sucesso!");
            filtrarDespesas();
            renderCalendar();
            atualizarDashboard();
            // Recarrega a página para simular fechar e reabrir
            window.location.reload();
          })
          .catch(err => alert("Erro ao pagar a despesa: " + err));
      } else {
        const [expenseKey, parcelIndex] = selectedValue.split("|");
        const parcelaRef = db.ref("despesas/" + expenseKey + "/parcelas/" + parcelIndex);
        parcelaRef.update({ pago: true })
          .then(() => {
            db.ref("despesas/" + expenseKey + "/parcelas").once("value").then(snapshot => {
              let allPaid = true;
              snapshot.forEach(child => { if (!child.val().pago) { allPaid = false; } });
              if (allPaid) { db.ref("despesas").child(expenseKey).update({ pago: true }); }
            });
            alert("Parcela paga com sucesso!");
            filtrarDespesas();
            renderCalendar();
            atualizarDashboard();
            // Recarrega a página para simular fechar e reabrir
            window.location.reload();
          })
          .catch(err => alert("Erro ao pagar a parcela: " + err));
      }
    }
    
    function loadRelatorioMensal() {
      let dataInicial = rangeStart ? rangeStart.toISOString().split("T")[0] : "";
      let dataFinal = rangeEnd ? rangeEnd.toISOString().split("T")[0] : "";
      const container = document.getElementById("relatorioMensalContainer");
      container.innerHTML = "";
      db.ref("despesas").once("value").then(snapshot => {
        let rows = [];
        snapshot.forEach(child => {
          const despesa = child.val();
          function getTime(dateStr) { return new Date(dateStr).getTime(); }
          if (despesa.formaPagamento === "avista" && despesa.pago) {
            let dt = despesa.dataCompra;
            if ((!dataInicial || getTime(dt) >= getTime(dataInicial)) &&
                (!dataFinal || getTime(dt) <= getTime(dataFinal))) {
              rows.push({ descricao: despesa.descricao, data: dt, valor: despesa.valor, forma: "À Vista" });
            }
          } else if (despesa.formaPagamento === "cartao" && despesa.parcelas) {
            despesa.parcelas.forEach((parcela, index) => {
              if (parcela.pago) {
                let dt = parcela.vencimento;
                if ((!dataInicial || getTime(dt) >= getTime(dataInicial)) &&
                    (!dataFinal || getTime(dt) <= getTime(dataFinal))) {
                  rows.push({ descricao: `${despesa.descricao} - Parcela ${index+1}`, data: dt, valor: parcela.valor, forma: "Cartão" });
                }
              }
            });
          }
        });
        if (rows.length > 0) {
          let table = document.createElement("table");
          let header = document.createElement("tr");
          ["Descrição", "Data", "Valor", "Forma"].forEach(col => {
            let th = document.createElement("th");
            th.innerText = col;
            header.appendChild(th);
          });
          table.appendChild(header);
          rows.forEach(r => {
            let tr = document.createElement("tr");
            let tdDesc = document.createElement("td");
            tdDesc.innerText = r.descricao;
            let tdData = document.createElement("td");
            tdData.innerText = new Date(r.data).toLocaleDateString();
            let tdValor = document.createElement("td");
            tdValor.innerText = "R$ " + parseFloat(r.valor).toFixed(2);
            let tdForma = document.createElement("td");
            tdForma.innerText = r.forma;
            tr.appendChild(tdDesc);
            tr.appendChild(tdData);
            tr.appendChild(tdValor);
            tr.appendChild(tdForma);
            table.appendChild(tr);
          });
          container.appendChild(table);
        } else {
          container.innerHTML = "<p>Nenhum registro encontrado para o período selecionado.</p>";
        }
      });
    }
    
    function renderCalendar() {
      let monthYearElem = document.getElementById("calendarMonthYear");
      let calendarGrid = document.getElementById("calendarGrid");
      calendarGrid.innerHTML = "";
      let date = new Date(currentCalendarYear, currentCalendarMonth, 1);
      let daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
      monthYearElem.innerText = `${date.toLocaleString('pt-BR', { month: 'long' })} ${currentCalendarYear}`;
      
      let table = document.createElement("table");
      let headerRow = document.createElement("tr");
      const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
      weekDays.forEach(day => {
        let th = document.createElement("th");
        th.innerText = day;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);
      
      let row = document.createElement("tr");
      for (let i = 0; i < date.getDay(); i++) {
        let cell = document.createElement("td");
        cell.innerText = "";
        row.appendChild(cell);
      }
      for (let day = 1; day <= daysInMonth; day++) {
        if (row.children.length === 7) {
          table.appendChild(row);
          row = document.createElement("tr");
        }
        let cell = document.createElement("td");
        cell.innerHTML = day + "<br>R$ " + (0).toFixed(2);
        cell.addEventListener("click", function() { showBalanceForDate(day); });
        cell.classList.add("calendar-cell");
        row.appendChild(cell);
      }
      table.appendChild(row);
      calendarGrid.appendChild(table);
    }
    
    function showBalanceForDate(day) {
      let selectedDate = new Date(currentCalendarYear, currentCalendarMonth, day);
      db.ref("pessoas").once("value").then(snapshot => {
        let totalIncome = 0;
        snapshot.forEach(child => {
          let pessoa = child.val();
          if (pessoa.pagamentos) {
            pessoa.pagamentos.forEach(pag => {
              let pagamentoDia = parseInt(pag.dia);
              if (pagamentoDia <= day) { totalIncome += parseFloat(pag.valor) || 0; }
            });
          }
        });
        db.ref("despesas").once("value").then(snapshot2 => {
          let totalExpenses = 0;
          snapshot2.forEach(child => {
            let despesa = child.val();
            if (despesa.formaPagamento === "avista" && despesa.dataCompra) {
              let d = new Date(despesa.dataCompra);
              if (d.getDate() <= day && d.getMonth() === currentCalendarMonth && d.getFullYear() === currentCalendarYear) {
                totalExpenses += parseFloat(despesa.valor) || 0;
              }
            }
            if (despesa.formaPagamento === "cartao" && despesa.parcelas) {
              despesa.parcelas.forEach(parcela => {
                let d = new Date(parcela.vencimento);
                if (d.getDate() <= day && d.getMonth() === currentCalendarMonth && d.getFullYear() === currentCalendarYear) {
                  totalExpenses += parseFloat(parcela.valor);
                }
              });
            }
          });
          let availableBalance = totalIncome - totalExpenses;
          document.getElementById("saldoDisponivelContainer").innerText =
            `Saldo em ${selectedDate.toLocaleDateString()}: R$ ${availableBalance.toFixed(2)}`;
        });
      });
    }
    
    function prevMonth() {
      currentCalendarMonth--;
      if (currentCalendarMonth < 0) { currentCalendarMonth = 11; currentCalendarYear--; }
      renderCalendar();
    }
    
    function nextMonth() {
      currentCalendarMonth++;
      if (currentCalendarMonth > 11) { currentCalendarMonth = 0; currentCalendarYear++; }
      renderCalendar();
    }
    
    function toggleMonthYearSelect() {
      let selectDiv = document.getElementById("monthYearSelect");
      selectDiv.style.display = (selectDiv.style.display === "none" || selectDiv.style.display === "") ? "block" : "none";
      if (selectDiv.style.display === "block") {
        let selectYear = document.getElementById("selectYear");
        if (selectYear.options.length === 0) {
          for (let y = currentCalendarYear - 5; y <= currentCalendarYear + 5; y++) {
            let option = document.createElement("option");
            option.value = y;
            option.text = y;
            if (y === currentCalendarYear) option.selected = true;
            selectYear.appendChild(option);
          }
        }
        document.getElementById("selectMonth").value = currentCalendarMonth;
      }
    }
    
    function updateCalendarFromSelect() {
      let selectMonth = document.getElementById("selectMonth").value;
      let selectYear = document.getElementById("selectYear").value;
      currentCalendarMonth = parseInt(selectMonth);
      currentCalendarYear = parseInt(selectYear);
      toggleMonthYearSelect();
      renderCalendar();
    }
    
    function toggleClt() {
      document.getElementById("cltFields").style.display =
        document.getElementById("cltCheckbox").checked ? "block" : "none";
    }
    
    function atualizarSalarioLiquido() {
      let salarioBruto = parseFloat(document.getElementById("salarioBruto").value) || 0;
      let inss = calcularINSS(salarioBruto);
      let irrf = calcularIRRF(salarioBruto - inss);
      let salarioLiquido = salarioBruto - inss - irrf;
      document.getElementById("salarioLiquido").value = salarioLiquido.toFixed(2);
    }
    
    function calcularINSS(salario) {
      if (salario <= 1320.00) return salario * 0.075;
      else if (salario <= 2571.29) return (1320 * 0.075) + ((salario - 1320) * 0.09);
      else if (salario <= 3856.94) return (1320 * 0.075) + (1251.29 * 0.09) + ((salario - 2571.29) * 0.12);
      else if (salario <= 7507.49) return (1320 * 0.075) + (1251.29 * 0.09) + (1285.65 * 0.12) + ((salario - 3856.94) * 0.14);
      return 876.97;
    }
    
    function calcularIRRF(base) {
      if (base <= 2112.00) return 0;
      else if (base <= 2826.65) return (base * 0.075) - 158.40;
      else if (base <= 3751.05) return (base * 0.15) - 370.40;
      else if (base <= 4664.68) return (base * 0.225) - 651.73;
      return (base * 0.275) - 884.96;
    }
    
    function gerarCamposPagamentos() {
      let container = document.getElementById("pagamentosContainer");
      container.innerHTML = "";
      let numPagamentos = parseInt(document.getElementById("numPagamentos").value) || 0;
      let salarioLiquido = parseFloat(document.getElementById("salarioLiquido").value) || 0;
      if (numPagamentos > 1) {
        for (let i = 1; i <= numPagamentos; i++) {
          let div = document.createElement("div");
          div.className = "pagamento-item";
          div.innerHTML = `<label>Dia do Pagamento ${i}:</label>
                           <input type="number" placeholder="Dia" min="1" max="31" required>
                           <label>Valor (R$):</label>
                           <input type="number" class="valoresPagamento" placeholder="Valor R$" step="0.01" oninput="verificarSomaPagamentos()" required>`;
          container.appendChild(div);
        }
      } else if (numPagamentos === 1) {
        let div = document.createElement("div");
        div.className = "pagamento-item";
        div.innerHTML = `<label>Dia do Pagamento:</label>
                         <input type="number" placeholder="Dia" min="1" max="31" required>`;
        container.appendChild(div);
        let inputValor = document.createElement("input");
        inputValor.type = "number";
        inputValor.className = "valoresPagamento";
        inputValor.placeholder = "Valor (R$)";
        inputValor.step = "0.01";
        inputValor.value = salarioLiquido.toFixed(2);
        inputValor.readOnly = true;
        container.appendChild(inputValor);
      }
    }
    
    function verificarSomaPagamentos() {
      let salarioLiquido = parseFloat(document.getElementById("salarioLiquido").value) || 0;
      let valores = document.querySelectorAll(".valoresPagamento");
      let soma = 0;
      valores.forEach(input => { soma += parseFloat(input.value) || 0; });
      soma = Math.round(soma * 100) / 100;
      salarioLiquido = Math.round(salarioLiquido * 100) / 100;
      document.getElementById("avisoErro").style.display = soma !== salarioLiquido ? "block" : "none";
    }
    
    document.getElementById("cadastroForm").addEventListener("submit", function(e) {
      e.preventDefault();
      let nome = document.getElementById("nome").value;
      let parentesco = document.getElementById("parentesco").value;
      // Novo campo: saldoInicial
      let saldoInicial = parseFloat(document.getElementById("saldoInicial").value) || 0;
      let salarioBruto = parseFloat(document.getElementById("salarioBruto").value) || 0;
      let salarioLiquido = parseFloat(document.getElementById("salarioLiquido").value) || 0;
      let numPagamentos = parseInt(document.getElementById("numPagamentos").value) || 0;
      let pagamentos = [];
      if (document.getElementById("cltCheckbox").checked) {
        let itens = document.getElementById("pagamentosContainer").getElementsByClassName("pagamento-item");
        for (let item of itens) {
          let dia = item.querySelector("input[type=number]").value;
          let valor = item.querySelector(".valoresPagamento") ? item.querySelector(".valoresPagamento").value : "";
          pagamentos.push({ dia, valor });
        }
      }
      let dados = {
        nome,
        parentesco,
        saldoInicial,  // Armazena o saldo inicial informado
        salarioBruto,
        salarioLiquido,
        numPagamentos,
        pagamentos,
        timestamp: new Date().toISOString()
      };
      db.ref("pessoas").push(dados)
        .then(() => {
          let msg = document.getElementById("mensagemSucessoRenda");
          msg.innerText = "Dados salvos com sucesso!";
          msg.style.display = "block";
          setTimeout(() => {
            msg.style.display = "none";
            document.getElementById("cadastroForm").reset();
            document.getElementById("cltFields").style.display = "none";
            document.getElementById("pagamentosContainer").innerHTML = "";
          }, 3000);
        })
        .catch(err => alert("Erro ao salvar os dados de renda: " + err));
    });
    
    /* Função para carregar/alternar rendas cadastradas na página de Renda com opção de excluir */
    function loadRendas() {
      const rendaList = document.getElementById("usuariosListaPrincipal");
      if (rendaVisivel) {
        rendaList.innerHTML = "";
        rendaVisivel = false;
        return;
      }
      db.ref("pessoas").once("value").then(snapshot => {
        rendaList.innerHTML = "";
        snapshot.forEach(child => {
          const pessoa = child.val();
          const key = child.key;
          const div = document.createElement("div");
          div.style.padding = "10px";
          div.style.marginBottom = "10px";
          div.style.borderRadius = "8px";
          div.style.boxShadow = "3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light)";
          let pagamentosInfo = "";
          if (pessoa.pagamentos) {
            pagamentosInfo = "<br><strong>Pagamentos:</strong> ";
            pessoa.pagamentos.forEach(pag => {
              pagamentosInfo += `Dia: ${pag.dia}, Valor: R$ ${parseFloat(pag.valor).toFixed(2)}; `;
            });
          }
          div.innerHTML = `<strong>Nome:</strong> ${pessoa.nome} - <strong>Saldo Inicial:</strong> R$ ${parseFloat(pessoa.saldoInicial).toFixed(2)} - <strong>Salário Líquido:</strong> R$ ${parseFloat(pessoa.salarioLiquido).toFixed(2)} ${pagamentosInfo}
                           <button onclick="deleteRenda('${key}')" style="margin-left: 10px; background: red; color: white; border: none; border-radius: 50%; cursor: pointer;">X</button>`;
          rendaList.appendChild(div);
        });
        rendaVisivel = true;
      });
    }
    
    /* Função para excluir uma renda */
    function deleteRenda(key) {
      if (confirm("Tem certeza que deseja excluir esta renda?")) {
        db.ref("pessoas").child(key).remove()
          .then(() => {
            alert("Renda excluída com sucesso!");
            loadRendas();
            atualizarDashboard();
          })
          .catch(err => alert("Erro ao excluir renda: " + err));
      }
    }
    
    /* Função para carregar despesas não pagas (usada em outros módulos) */
    function loadDespesasNaoPagasSelect() {
      const despesaSelect = document.getElementById("despesaSelect");
      despesaSelect.innerHTML = "";
      db.ref("despesas").orderByChild("pago").equalTo(false).once("value").then(snapshot => {
        snapshot.forEach(child => {
          const despesa = child.val();
          if (despesa.formaPagamento === "avista") {
            const option = document.createElement("option");
            option.value = child.key;
            const dataExibicao = despesa.dataCompra;
            const valorExibido = despesa.valor ? "R$ " + parseFloat(despesa.valor).toFixed(2) : "";
            option.text = despesa.descricao + " " + valorExibido + " - " + dataExibicao;
            despesaSelect.appendChild(option);
          } else if (despesa.formaPagamento === "cartao" && despesa.parcelas) {
            despesa.parcelas.forEach((parcela, index) => {
              if (!parcela.pago) {
                const option = document.createElement("option");
                option.value = child.key + "|" + index;
                option.text = `${despesa.descricao} - Parcela ${index+1} de ${despesa.parcelas.length} - Venc: ${parcela.vencimento} - R$ ${parseFloat(parcela.valor).toFixed(2)}`;
                despesaSelect.appendChild(option);
              }
            });
          }
        });
      });
    }
    
    /* NOVAS FUNÇÕES DE NAVEGAÇÃO DO DASHBOARD (setas para alterar o mês e atualizar título) */
    function prevDashboardMonth() {
      let selectMonth = document.getElementById("dashboardMonth");
      let selectYear = document.getElementById("dashboardYear");
      let currentMonth = parseInt(selectMonth.value);
      if (currentMonth === 0) {
        currentMonth = 11;
        selectYear.value = parseInt(selectYear.value) - 1;
      } else {
        currentMonth--;
      }
      selectMonth.value = currentMonth;
      atualizarDashboard();
      updateDespesasMesTitle();
      carregarPainelDespesasMes();
    }
    
    function nextDashboardMonth() {
      let selectMonth = document.getElementById("dashboardMonth");
      let selectYear = document.getElementById("dashboardYear");
      let currentMonth = parseInt(selectMonth.value);
      if (currentMonth === 11) {
        currentMonth = 0;
        selectYear.value = parseInt(selectYear.value) + 1;
      } else {
        currentMonth++;
      }
      selectMonth.value = currentMonth;
      atualizarDashboard();
      updateDespesasMesTitle();
      carregarPainelDespesasMes();
    }
    
    function updateDespesasMesTitle() {
      let selectMonth = document.getElementById("dashboardMonth");
      let monthIndex = parseInt(selectMonth.value);
      let monthName = new Date(2020, monthIndex).toLocaleString('pt-BR', { month: 'long' });
      document.getElementById("despesasMesTitle").innerText = "Despesas de " + monthName.charAt(0).toUpperCase() + monthName.slice(1);
    }
    
    /* ================= NOVAS FUNCIONALIDADES ================= */
    
    // A. Cadastro de Limites por Categoria
    function novo_carregarLimites() {
      const container = document.getElementById("novo_limitesContainer");
      container.innerHTML = "";
      // Busca categorias existentes SEM alterar função original
      db.ref("categorias").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const categoria = child.val();
          const div = document.createElement("div");
          div.style.marginBottom = "10px";
          div.innerHTML = `<label>${categoria.nome}:</label>
                           <input type="number" id="novo_limite_${child.key}" placeholder="Limite para ${categoria.nome}" step="0.01">`;
          container.appendChild(div);
        });
      });
    }
    
    function novo_salvarLimites() {
      // Para cada categoria, salva na nova tabela "limites_categorias"
      db.ref("categorias").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const categoria = child.val();
          const input = document.getElementById("novo_limite_" + child.key);
          if(input && input.value) {
            const limite = parseFloat(input.value);
            db.ref("limites_categorias").child(child.key).set({
              categoriaId: child.key,
              limite: limite,
              userId: "default" // ou usar id do usuário se disponível
            });
          }
        });
        alert("Limites salvos com sucesso!");
        fecharModal("novo_limitesModal");
      });
    }
    
    // B. Previsão de Despesas
    function novo_calcularPrevisoes() {
      // Analisa despesas dos últimos 6 meses e aplica regressão linear para projetar os próximos 3 meses
      // Para não interferir nas funções existentes, utiliza dados da coleção "despesas"
      const hoje = new Date();
      const seisMesesAtras = new Date(hoje.getFullYear(), hoje.getMonth() - 5, 1);
      let despesasMes = {}; // chave: "ano-mes", valor: soma das despesas
      
      db.ref("despesas").once("value").then(snapshot => {
        snapshot.forEach(child => {
          let despesa = child.val();
          let dt;
          if(despesa.formaPagamento === "avista" && despesa.dataCompra) {
            dt = new Date(despesa.dataCompra);
            if(dt >= seisMesesAtras && dt <= hoje) {
              let key = dt.getFullYear() + "-" + (dt.getMonth()+1);
              despesasMes[key] = (despesasMes[key] || 0) + parseFloat(despesa.valor);
            }
          } else if(despesa.formaPagamento === "cartao" && despesa.parcelas) {
            despesa.parcelas.forEach(parcela => {
              dt = new Date(parcela.vencimento);
              if(dt >= seisMesesAtras && dt <= hoje) {
                let key = dt.getFullYear() + "-" + (dt.getMonth()+1);
                despesasMes[key] = (despesasMes[key] || 0) + parseFloat(parcela.valor);
              }
            });
          }
        });
        
        // Ordena as chaves (meses) e aplica uma regressão linear simples
        const keys = Object.keys(despesasMes).sort();
        let x = [];
        let y = [];
        keys.forEach((k, index) => {
          x.push(index + 1);
          y.push(despesasMes[k]);
        });
        
        // Função de regressão linear simples (mínimos quadrados)
        function regressaoLinear(x, y) {
          let n = x.length;
          let sumX = x.reduce((a, b) => a + b, 0);
          let sumY = y.reduce((a, b) => a + b, 0);
          let sumXY = x.reduce((acc, val, i) => acc + val * y[i], 0);
          let sumX2 = x.reduce((acc, val) => acc + val * val, 0);
          let m = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
          let b = (sumY - m * sumX) / n;
          return { m, b };
        }
        
        const { m, b } = regressaoLinear(x, y);
        // Projeta os próximos 3 meses
        let previsoes = [];
        for(let i = x.length + 1; i <= x.length + 3; i++) {
          previsoes.push(b + m * i);
        }
        
        // Atualiza o novo gráfico (#novo_graficoPrevisao)
        const ctxPrev = document.getElementById("novo_graficoPrevisao").getContext("2d");
        if(window.novoGraficoPrevisao) window.novoGraficoPrevisao.destroy();
        window.novoGraficoPrevisao = new Chart(ctxPrev, {
          type: 'line',
          data: {
            labels: ['Mês 1', 'Mês 2', 'Mês 3'],
            datasets: [{
              label: 'Previsão de Despesas',
              data: previsoes,
              backgroundColor: 'rgba(76, 175, 80, 0.6)',
              borderColor: 'rgba(76, 175, 80, 1)',
              fill: false,
              tension: 0.1
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
        
        // Atualiza a tabela de previsão
        const tabela = document.getElementById("novo_tabelaPrevisao");
        tabela.innerHTML = "<h4>Próximos 3 Meses</h4>";
        previsoes.forEach((prev, i) => {
          const p = document.createElement("p");
          p.innerText = `Mês ${i+1}: R$ ${prev.toFixed(2)}`;
          tabela.appendChild(p);
        });
      });
    }
    
    // C. Alertas Automáticos
    function novo_verificarAlertas() {
      const hoje = new Date();
      const alertaLista = document.getElementById("novo_listaAlertas");
      alertaLista.innerHTML = "";
      
      // 1. Checa vencimentos 3 dias antes
      db.ref("despesas").once("value").then(snapshot => {
        snapshot.forEach(child => {
          let despesa = child.val();
          if(despesa.formaPagamento === "avista" && !despesa.pago && despesa.dataCompra) {
            let dataCompra = new Date(despesa.dataCompra);
            let diffDays = Math.ceil((dataCompra - hoje) / (1000 * 60 * 60 * 24));
            if(diffDays === 3) {
              novo_mostrarAlerta(`Despesa "${despesa.descricao}" vence em 3 dias.`);
              // Salvar alerta no histórico
              db.ref("alertas_historico").push({
                tipo: "vencimento",
                mensagem: `Despesa "${despesa.descricao}" vence em 3 dias.`,
                data: hoje.toISOString().split("T")[0]
              });
            }
          } else if(despesa.formaPagamento === "cartao" && despesa.parcelas) {
            despesa.parcelas.forEach(parcela => {
              if(!parcela.pago) {
                let venc = new Date(parcela.vencimento);
                let diffDays = Math.ceil((venc - hoje) / (1000 * 60 * 60 * 24));
                if(diffDays === 3) {
                  novo_mostrarAlerta(`Parcela de "${despesa.descricao}" vence em 3 dias.`);
                  db.ref("alertas_historico").push({
                    tipo: "vencimento",
                    mensagem: `Parcela de "${despesa.descricao}" vence em 3 dias.`,
                    data: hoje.toISOString().split("T")[0]
                  });
                }
              }
            });
          }
        });
      });
      
      // 2. Checa limites por categoria (80% do limite)
      db.ref("despesas").once("value").then(snapshot => {
        let gastosCategoria = {};
        snapshot.forEach(child => {
          let despesa = child.val();
          if(despesa.pago || (despesa.formaPagamento === "cartao" && despesa.parcelas.every(p => p.pago))) return;
          let cat = despesa.categoria;
          let valor = 0;
          if(despesa.formaPagamento === "avista") {
            valor = parseFloat(despesa.valor) || 0;
          } else if(despesa.formaPagamento === "cartao" && despesa.parcelas) {
            despesa.parcelas.forEach(parcela => {
              if(!parcela.pago) { valor += parseFloat(parcela.valor) || 0; }
            });
          }
          gastosCategoria[cat] = (gastosCategoria[cat] || 0) + valor;
        });
        
        // Verifica limites cadastrados na nova tabela "limites_categorias"
        db.ref("limites_categorias").once("value").then(snapshotLimites => {
          snapshotLimites.forEach(child => {
            let limiteData = child.val();
            let gasto = gastosCategoria[child.key] || 0;
            if(gasto >= 0.8 * limiteData.limite) {
              novo_mostrarAlerta(`Alerta: Categoria "${child.key}" atingiu ${((gasto/limiteData.limite)*100).toFixed(0)}% do limite.`);
              db.ref("alertas_historico").push({
                tipo: "limite_excedido",
                mensagem: `Categoria "${child.key}" atingiu ${((gasto/limiteData.limite)*100).toFixed(0)}% do limite.`,
                data: hoje.toISOString().split("T")[0]
              });
            }
          });
        });
      });
    }
    
    // Função de exibição de alerta (NOVA)
    function novo_mostrarAlerta(mensagem) {
      const toast = document.createElement("div");
      toast.className = "toast-alerta";
      toast.innerText = mensagem;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }
    
    // Chama a verificação de alertas a cada 24h
    setInterval(novo_verificarAlertas, 86400000);
    
    /* ================= NOVA FUNCIONALIDADE: Verificar Despesas Vencidas ================= */
    function novo_verificarDespesasVencidas() {
      const lista = document.getElementById("listaDespesasMes");
      const hoje = new Date();
      // Para cada despesa (cada div dentro de #listaDespesasMes)
      const itens = lista.querySelectorAll("div");
      itens.forEach(item => {
        const smallElem = item.querySelector("small");
        if (!smallElem) return;
        const dataText = smallElem.innerText.trim(); // formato: dd/mm/aaaa
        const partes = dataText.split("/");
        if (partes.length === 3) {
          const dia = parseInt(partes[0]);
          const mes = parseInt(partes[1]) - 1;
          const ano = parseInt(partes[2]);
          const dataDespesa = new Date(ano, mes, dia);
          if (dataDespesa < hoje) {
            // Se a despesa estiver vencida, adiciona o alerta "Conta atrasada" em vermelho, se ainda não estiver presente
            if (!item.querySelector(".novo-alerta-vencida")) {
              const alertaSpan = document.createElement("span");
              alertaSpan.className = "novo-alerta-vencida";
              alertaSpan.style.color = "red";
              alertaSpan.style.marginLeft = "10px";
              alertaSpan.innerText = "Conta atrasada";
              item.appendChild(alertaSpan);
            }
          } else {
            // Se a despesa não estiver vencida, remove o alerta, se existir
            const alertaExistente = item.querySelector(".novo-alerta-vencida");
            if (alertaExistente) alertaExistente.remove();
          }
        }
      });
    }
    
    /* ================= NOVA FUNCIONALIDADE: Corrigir Eixo Y do Gráfico ================= */
    (function(){
      // Armazena o valor máximo inicial do eixo Y
      window.novo_maxEixoFixo = null;
      
      const originalAtualizarGrafico = atualizarGrafico;
      atualizarGrafico = function() {
        originalAtualizarGrafico();
        // Aguarda a atualização e depois ajusta o eixo Y
        setTimeout(novo_ajustarEixoY, 150);
      }
      
      function novo_ajustarEixoY() {
        if(grafico && grafico.data && grafico.data.datasets && grafico.data.datasets[0]) {
          const dados = grafico.data.datasets[0].data;
          const maxAtual = Math.max(...dados);
          // Se não foi definido um valor máximo fixo, o define com o primeiro valor máximo
          if(window.novo_maxEixoFixo === null) {
            window.novo_maxEixoFixo = maxAtual;
          }
          // Se o novo máximo for menor que o fixo, mantenha o fixo
          grafico.options.scales.y.max = (maxAtual < window.novo_maxEixoFixo) ? window.novo_maxEixoFixo : maxAtual;
          grafico.update();
        }
      }
    })();
    
    /* ================= NOVA FUNCIONALIDADE: Recarregar a Página ================= */
    // Após cadastrar ou pagar uma despesa, a página é recarregada para simular fechar e reabrir o sistema.
    
    /* Carrega dados iniciais */
    window.onload = () => {
      document.getElementById("dataCompra").value = new Date().toISOString().split("T")[0];
      updateCategoriaSelect();
      updateCartaoSelect();
      loadDespesasNaoPagasSelect();
      loadCategorias();
      loadCartoes();
      renderCalendar();
      loadCategoriasFiltro();
      preencherDashboardAno();
      document.getElementById("dashboardMonth").value = new Date().getMonth();
      atualizarDashboard();
      updateDespesasMesTitle();
      // Chama o painel de despesas após carregar a página
      carregarPainelDespesasMes();
    };
    
    // Adiciona eventos para atualizar o painel de despesas do mês quando o dashboard for atualizado
    document.getElementById("dashboardMonth").addEventListener("change", carregarPainelDespesasMes);
    document.getElementById("dashboardYear").addEventListener("change", carregarPainelDespesasMes);
    // Também adiciona ao botão de atualizar dashboard (com um pequeno delay para garantir a atualização dos dados)
    document.querySelector("button[onclick='atualizarDashboard()']").addEventListener("click", function() {
      setTimeout(carregarPainelDespesasMes, 500);
    });
  </script>
</body>
</html>
