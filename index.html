<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciamento de Contas</title>
  <style>
    /* Estilos mantidos conforme original */
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    /* ... (manter todos os estilos originais) ... */
    #monthYearSelect {
      display: none;
      margin-bottom: 10px;
      background: #fff;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-database-compat.js"></script>
</head>
<body>

  <!-- Seções HTML mantidas conforme original -->

  <script>
    // Firebase Configuração
    const firebaseConfig = {
      apiKey: "AIzaSyAG6LktPXGe6F-vSTHV2Y3n95vSwhpXch8",
      authDomain: "controlegasto-df3f1.firebaseapp.com",
      databaseURL: "https://controlegasto-df3f1-default-rtdb.firebaseio.com",
      projectId: "controlegasto-df3f1",
      storageBucket: "controlegasto-df3f1.firebasestorage.app",
      messagingSenderId: "1034936676414",
      appId: "1:1034936676414:web:61c67ce39c3ab71a07a16f",
      measurementId: "G-PTN43GZHGR"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentCalendarMonth = new Date().getMonth();
    let currentCalendarYear = new Date().getFullYear();

    window.onload = function() {
      document.getElementById("dataCompra").value = new Date().toISOString().split("T")[0];
      updateCategoriaSelect();
      updateCartaoSelect();
      loadDespesasNaoPagasSelect();
      loadCategorias();
      loadCartoes();
    };

    // Funções auxiliares corrigidas
    async function updateCategoriaSelect() {
      const select = document.getElementById("categoriaDespesa");
      select.innerHTML = '<option value="">Selecione a Categoria</option>';
      const snapshot = await db.ref("categorias").once("value");
      snapshot.forEach(child => {
        const option = document.createElement("option");
        option.value = child.key;
        option.textContent = child.val().nome;
        select.appendChild(option);
      });
    }

    async function updateCartaoSelect() {
      const select = document.getElementById("cartaoDespesa");
      select.innerHTML = '<option value="">Selecione o Cartão</option>';
      const snapshot = await db.ref("cartoes").once("value");
      snapshot.forEach(child => {
        const cartao = child.val();
        const option = document.createElement("option");
        option.value = child.key;
        option.textContent = cartao.nome;
        option.setAttribute("data-fatura", cartao.diaFatura);
        option.setAttribute("data-fechamento", cartao.diaFechamento);
        select.appendChild(option);
      });
    }

    // Função corrigida para carregar despesas
    function loadDespesasNaoPagasSelect() {
      const select = document.getElementById("despesaSelect");
      select.innerHTML = "";
      db.ref("despesas").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const despesa = child.val();
          const id = child.key;
          
          if (despesa.formaPagamento === "cartao" && despesa.parcelas) {
            despesa.parcelas.forEach((parcela, idx) => {
              if (!parcela.pago) {
                const opt = document.createElement("option");
                opt.value = `${id}|${idx}`;
                opt.textContent = `${despesa.descricao} - Parcela ${idx+1}/${despesa.parcelas.length} - ${parcela.vencimento} - R$ ${parcela.valor}`;
                select.appendChild(opt);
              }
            });
          } else if (!despesa.pago) {
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = `${despesa.descricao} - ${despesa.dataCompra} - R$ ${despesa.valor}`;
            select.appendChild(opt);
          }
        });
      }).catch(error => console.error("Erro ao carregar despesas:", error));
    }

    // Função corrigida para salvar despesa
    async function salvarDespesa() {
      const despesaData = {
        descricao: document.getElementById("despesaDescricao").value,
        valor: parseFloat(document.getElementById("despesaValor").value),
        dataCompra: document.getElementById("dataCompra").value,
        categoria: document.getElementById("categoriaDespesa").value,
        formaPagamento: document.getElementById("formaPagamento").value,
        timestamp: new Date().toISOString()
      };

      try {
        if (despesaData.formaPagamento === "cartao") {
          const cartaoSelect = document.getElementById("cartaoDespesa");
          if (!cartaoSelect.value) throw new Error("Selecione um cartão");
          
          despesaData.cartao = {
            id: cartaoSelect.value,
            nome: cartaoSelect.options[cartaoSelect.selectedIndex].text,
            diaFatura: parseInt(cartaoSelect.options[cartaoSelect.selectedIndex].getAttribute("data-fatura")),
            diaFechamento: parseInt(cartaoSelect.options[cartaoSelect.selectedIndex].getAttribute("data-fechamento"))
          };

          despesaData.parcelas = calcularParcelas(
            despesaData.valor,
            document.getElementById("numParcelasDespesa").value,
            despesaData.dataCompra,
            despesaData.cartao.diaFatura,
            despesaData.cartao.diaFechamento
          );
        } else {
          despesaData.pago = false;
        }

        await db.ref("despesas").push(despesaData);
        alert("Despesa salva com sucesso!");
        document.querySelectorAll('input, select').forEach(element => {
          if (element.id !== 'dataCompra') element.value = '';
        });
        loadDespesasNaoPagasSelect();
        renderCalendar();
      } catch (error) {
        alert(`Erro: ${error.message}`);
      }
    }

    function calcularParcelas(valorTotal, numParcelas, dataCompra, diaFatura, diaFechamento) {
      const parcelas = [];
      const valorParcela = parseFloat((valorTotal / numParcelas).toFixed(2));
      const data = new Date(dataCompra);
      const diaCompra = data.getDate();

      let mesBase = data.getMonth();
      let anoBase = data.getFullYear();

      if (diaCompra > diaFechamento) {
        mesBase++;
        if (mesBase > 11) {
          mesBase = 0;
          anoBase++;
        }
      }

      for (let i = 0; i < numParcelas; i++) {
        const parcelaMes = mesBase + i;
        const parcelaData = new Date(anoBase, parcelaMes, diaFatura);
        parcelas.push({
          valor: valorParcela,
          vencimento: parcelaData.toISOString().split('T')[0],
          pago: false
        });
      }
      return parcelas;
    }

    // Funções do calendário corrigidas
    function renderCalendar() {
      populateMonthYearSelect();
      document.getElementById("calendarMonthYear").textContent = 
        `${getMonthName(currentCalendarMonth)} ${currentCalendarYear}`;

      loadCalendarExpenses(currentCalendarMonth, currentCalendarYear, totals => {
        const calendarGrid = document.getElementById("calendarGrid");
        calendarGrid.innerHTML = '';
        
        const table = document.createElement("table");
        const header = document.createElement("tr");
        ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"].forEach(dia => {
          const th = document.createElement("th");
          th.textContent = dia;
          header.appendChild(th);
        });
        table.appendChild(header);

        const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
        const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
        
        let row = document.createElement("tr");
        for (let i = 0; i < firstDay; i++) {
          row.appendChild(document.createElement("td"));
        }

        for (let d = 1; d <= daysInMonth; d++) {
          const cell = document.createElement("td");
          cell.innerHTML = `<strong>${d}</strong><br>${totals[d] ? 'R$ ' + totals[d].toFixed(2) : ''}`;
          row.appendChild(cell);

          if ((firstDay + d) % 7 === 0) {
            table.appendChild(row);
            row = document.createElement("tr");
          }
        }

        if (row.children.length > 0) {
          while (row.children.length < 7) row.appendChild(document.createElement("td"));
          table.appendChild(row);
        }

        calendarGrid.appendChild(table);
      });
    }

    function populateMonthYearSelect() {
      const yearSelect = document.getElementById("selectYear");
      yearSelect.innerHTML = '';
      const currentYear = new Date().getFullYear();
      for (let y = currentYear - 10; y <= currentYear + 10; y++) {
        const option = document.createElement("option");
        option.value = y;
        option.textContent = y;
        if (y === currentCalendarYear) option.selected = true;
        yearSelect.appendChild(option);
      }
      document.getElementById("selectMonth").value = currentCalendarMonth;
    }

    // Restante das funções mantidas com correções similares
  </script>
</body>
</html>
